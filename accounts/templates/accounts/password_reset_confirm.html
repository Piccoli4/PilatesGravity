{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}Nueva Contrase√±a - Pilates Gravity{% endblock %}

{% block content %}
    {% if validlink %}
        <!-- Formulario para establecer nueva contrase√±a -->
        <div class="text-center mb-8">
            <div class="w-14 h-14 mx-auto mb-4 text-principal animate-iconPulse">
                <svg width="60" height="60" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-full h-full">
                    <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zM10 17l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z" fill="currentColor"/>
                </svg>
            </div>
            <h2 class="text-3xl font-bold text-principal mb-3 tracking-wide">Nueva Contrase√±a</h2>
            <p class="text-base text-gris-medio font-light opacity-90 leading-relaxed">
                Crea tu nueva contrase√±a segura
            </p>
            <div class="w-20 h-0.5 bg-gradient-to-r from-secundario to-principal mx-auto mt-4 rounded-full"></div>
        </div>

        <form method="post" class="space-y-6">
            {% csrf_token %}
            
            <div class="form-field-group opacity-0 translate-y-5">
                <label for="id_new_password1" class="block text-sm font-semibold text-gray-800 mb-3 flex items-center gap-2">
                    <span class="text-lg">üîê</span>
                    Nueva contrase√±a
                </label>
                <div class="relative">
                    <input type="password" 
                           name="{{ form.new_password1.name }}" 
                           id="id_new_password1" 
                           class="w-full px-4 py-4 pr-12 border-2 border-gray-200 rounded-xl text-base bg-gris-claro transition-all duration-300 focus:border-principal focus:outline-none focus:ring-4 focus:ring-principal/10 focus:bg-white focus:-translate-y-0.5 hover:border-secundario"
                           placeholder="Tu nueva contrase√±a"
                           value="{{ form.new_password1.value|default:'' }}"
                           required>
                    <div class="absolute bottom-0 left-0 right-0 h-0.5 bg-gradient-to-r from-secundario to-principal scale-x-0 transition-transform duration-300 rounded-full input-focus-line"></div>
                    <button type="button" 
                            class="absolute right-3 top-1/2 -translate-y-1/2 bg-none border-none cursor-pointer text-gris-medio text-lg transition-all duration-200 flex items-center justify-center w-6 h-6 hover:text-principal hover:scale-125 password-toggle"
                            onclick="togglePassword('id_new_password1', this)"
                            aria-label="Mostrar contrase√±a">
                        <span class="toggle-icon">üëÅÔ∏è</span>
                    </button>
                </div>
                {% if form.new_password1.errors %}
                    <div class="mt-2 space-y-1">
                        {% for error in form.new_password1.errors %}
                            <span class="block text-error text-sm flex items-center gap-1 animate-slideInError">
                                ‚ö†Ô∏è {{ error }}
                            </span>
                        {% endfor %}
                    </div>
                {% endif %}
                {% if form.new_password1.help_text %}
                    <div class="mt-3 flex items-start gap-2 p-3 bg-blue-50 rounded-lg border-l-4 border-info">
                        <span class="text-base flex-shrink-0 mt-0.5">üí°</span>
                        <span class="text-sm text-principal opacity-80 leading-relaxed">{{ form.new_password1.help_text }}</span>
                    </div>
                {% endif %}
            </div>

            <div class="form-field-group opacity-0 translate-y-5">
                <label for="id_new_password2" class="block text-sm font-semibold text-gray-800 mb-3 flex items-center gap-2">
                    <span class="text-lg">üîê</span>
                    Confirmar contrase√±a
                </label>
                <div class="relative">
                    <input type="password" 
                           name="{{ form.new_password2.name }}" 
                           id="id_new_password2" 
                           class="w-full px-4 py-4 pr-12 border-2 border-gray-200 rounded-xl text-base bg-gris-claro transition-all duration-300 focus:border-principal focus:outline-none focus:ring-4 focus:ring-principal/10 focus:bg-white focus:-translate-y-0.5 hover:border-secundario"
                           placeholder="Confirma tu nueva contrase√±a"
                           value="{{ form.new_password2.value|default:'' }}"
                           required>
                    <div class="absolute bottom-0 left-0 right-0 h-0.5 bg-gradient-to-r from-secundario to-principal scale-x-0 transition-transform duration-300 rounded-full input-focus-line"></div>
                    <button type="button" 
                            class="absolute right-3 top-1/2 -translate-y-1/2 bg-none border-none cursor-pointer text-gris-medio text-lg transition-all duration-200 flex items-center justify-center w-6 h-6 hover:text-principal hover:scale-125 password-toggle"
                            onclick="togglePassword('id_new_password2', this)"
                            aria-label="Mostrar contrase√±a">
                        <span class="toggle-icon">üëÅÔ∏è</span>
                    </button>
                </div>
                {% if form.new_password2.errors %}
                    <div class="mt-2 space-y-1">
                        {% for error in form.new_password2.errors %}
                            <span class="block text-error text-sm flex items-center gap-1 animate-slideInError">
                                ‚ö†Ô∏è {{ error }}
                            </span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="password-strength-info bg-gradient-to-br from-principal/5 to-secundario/5 rounded-lg p-4 my-6 border-l-4 border-secundario opacity-0 translate-y-5">
                <h4 class="text-principal text-sm font-semibold mb-3 m-0">Tu contrase√±a debe:</h4>
                <ul class="list-none p-0 m-0 space-y-2">
                    <li class="flex items-center gap-2 text-sm text-gray-600">
                        <span class="text-base w-4 text-center">üìè</span>
                        Tener al menos 6 caracteres
                    </li>
                    <li class="flex items-center gap-2 text-sm text-gray-600">
                        <span class="text-base w-4 text-center">üî§</span>
                        No ser demasiado com√∫n
                    </li>
                    <li class="flex items-center gap-2 text-sm text-gray-600">
                        <span class="text-base w-4 text-center">üë§</span>
                        No ser similar a tu informaci√≥n personal
                    </li>
                </ul>
            </div>

            <div class="form-submit-section opacity-0 translate-y-5">
                <button type="submit" class="reset-submit-btn w-full bg-gradient-to-r from-principal to-slate-600 text-white border-none rounded-xl px-8 py-4 text-lg font-semibold cursor-pointer transition-all duration-300 relative overflow-hidden shadow-btn-primary hover:shadow-btn-primary-hover hover:-translate-y-1 focus:outline-none focus:ring-4 focus:ring-principal/25">
                    <span class="relative z-10 flex items-center justify-center gap-3">
                        <span>Cambiar Contrase√±a</span>
                        <span class="text-xl">üîí</span>
                    </span>
                </button>
            </div>
        </form>

    {% else %}
        <!-- Enlace inv√°lido o expirado -->
        <div class="text-center mb-8">
            <div class="w-14 h-14 mx-auto mb-4 text-error error-icon">
                <svg width="60" height="60" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-full h-full">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM13 17h-2v-6h2v6zm0-8h-2V7h2v2z" fill="currentColor"/>
                </svg>
            </div>
            <h2 class="text-3xl font-bold text-principal mb-3 tracking-wide">Enlace No V√°lido</h2>
            <p class="text-base text-gris-medio font-light opacity-90 leading-relaxed">
                El enlace ha expirado o no es v√°lido
            </p>
            <div class="w-20 h-0.5 bg-gradient-to-r from-secundario to-principal mx-auto mt-4 rounded-full"></div>
        </div>

        <div class="error-content max-w-lg mx-auto mb-8 px-4 opacity-0 translate-y-5">
            <div class="text-center p-6 bg-gradient-to-br from-error/5 to-error/10 rounded-xl border border-error/20">
                <div class="text-5xl mb-4">‚è∞</div>
                <h3 class="text-error text-2xl font-semibold mb-4">Enlace expirado</h3>
                <p class="text-gray-600 leading-relaxed">
                    El enlace de restablecimiento de contrase√±a ha expirado o ya fue utilizado. 
                    Los enlaces son v√°lidos por <strong class="text-error">1 hora</strong> por seguridad.
                </p>
            </div>
        </div>

        <div class="text-center">
            <a href="{% url 'accounts:password_reset' %}" 
               class="inline-flex items-center gap-3 bg-gradient-to-r from-principal to-slate-600 text-white border-none rounded-xl px-8 py-4 text-lg font-semibold cursor-pointer transition-all duration-300 relative overflow-hidden shadow-btn-primary hover:shadow-btn-primary-hover hover:-translate-y-1 focus:outline-none focus:ring-4 focus:ring-principal/25 hover:no-underline">
                <span class="relative z-10 flex items-center justify-center gap-3">
                    <span>Solicitar Nuevo Enlace</span>
                    <span class="text-xl">üìß</span>
                </span>
            </a>
        </div>
    {% endif %}

    <script>
        function togglePassword(inputId, button) {
            const input = document.getElementById(inputId);
            const icon = button.querySelector('.toggle-icon');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.textContent = 'üôà';
                button.setAttribute('aria-label', 'Ocultar contrase√±a');
            } else {
                input.type = 'password';
                icon.textContent = 'üëÅÔ∏è';
                button.setAttribute('aria-label', 'Mostrar contrase√±a');
            }
        }

        // Animaci√≥n de entrada escalonada
        document.addEventListener('DOMContentLoaded', function() {
            const formElements = document.querySelectorAll('.form-field-group, .form-submit-section, .password-strength-info, .error-content');
            formElements.forEach((element, index) => {
                setTimeout(() => {
                    element.style.transition = 'all 0.6s ease';
                    element.style.opacity = '1';
                    element.style.transform = 'translateY(0)';
                }, 200 * index);
            });

            // Efectos de l√≠nea de enfoque
            const inputs = document.querySelectorAll('input[type="password"]');
            inputs.forEach(input => {
                const focusLine = input.nextElementSibling;
                
                if (focusLine && focusLine.classList.contains('input-focus-line')) {
                    input.addEventListener('focus', function() {
                        focusLine.style.transform = 'scaleX(1)';
                    });
                    
                    input.addEventListener('blur', function() {
                        focusLine.style.transform = 'scaleX(0)';
                    });
                }
            });

            // Validaci√≥n de coincidencia de contrase√±as en tiempo real
            const password1 = document.getElementById('id_new_password1');
            const password2 = document.getElementById('id_new_password2');
            
            if (password1 && password2) {
                function checkPasswordMatch() {
                    if (password2.value === '') return;
                    
                    if (password1.value === password2.value) {
                        password2.style.borderColor = '#28A745';
                    } else {
                        password2.style.borderColor = '#DC3545';
                    }
                }
                
                password1.addEventListener('input', checkPasswordMatch);
                password2.addEventListener('input', checkPasswordMatch);
            }

            // Efecto de env√≠o del formulario
            const form = document.querySelector('form');
            const submitBtn = document.querySelector('.reset-submit-btn');
            
            if (form && submitBtn) {
                form.addEventListener('submit', function() {
                    submitBtn.innerHTML = `
                        <span class="relative z-10 flex items-center justify-center gap-3">
                            <span class="loading-spinner"></span>
                            <span>Cambiando...</span>
                        </span>
                    `;
                    submitBtn.disabled = true;
                });
            }
        });
    </script>
{% endblock %}