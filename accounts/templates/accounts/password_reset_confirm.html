{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}Nueva Contraseña - Pilates Gravity{% endblock %}

{% block content %}
    {% if validlink %}
        <!-- Formulario para establecer nueva contraseña -->
        <div class="text-center mb-8">
            <div class="w-14 h-14 mx-auto mb-4 text-principal animate-iconPulse">
                <svg width="60" height="60" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-full h-full">
                    <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zM10 17l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z" fill="currentColor"/>
                </svg>
            </div>
            <h2 class="text-3xl font-bold text-principal mb-3 tracking-wide">Nueva Contraseña</h2>
            <p class="text-base text-gris-medio font-light opacity-90 leading-relaxed">
                Crea tu nueva contraseña segura
            </p>
            <div class="w-20 h-0.5 bg-gradient-to-r from-secundario to-principal mx-auto mt-4 rounded-full"></div>
        </div>

        <form method="post" class="space-y-6">
            {% csrf_token %}
            
            <div class="form-field-group opacity-0 translate-y-5">
                <label for="id_new_password1" class="block text-sm font-semibold text-principal mb-3 flex items-center gap-2">
                    <span class="text-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                            <path fill-rule="evenodd" d="M12 1.5a5.25 5.25 0 0 0-5.25 5.25v3a3 3 0 0 0-3 3v6.75a3 3 0 0 0 3 3h10.5a3 3 0 0 0 3-3v-6.75a3 3 0 0 0-3-3v-3c0-2.9-2.35-5.25-5.25-5.25Zm3.75 8.25v-3a3.75 3.75 0 1 0-7.5 0v3h7.5Z" clip-rule="evenodd" />
                        </svg>
                    </span>
                    Nueva contraseña
                </label>
                <div class="relative h-16">
                    <input 
                        type="password" 
                        name="{{ form.new_password1.name }}" 
                        id="id_new_password1" 
                        class="absolute inset-0 w-full px-4 pr-12 border-2 border-gray-200 rounded-xl text-base bg-gris-claro focus:border-principal focus:outline-none focus:bg-white hover:border-secundario"
                        placeholder="Tu nueva contraseña"
                        value="{{ form.new_password1.value|default:'' }}"
                        required
                    >
                    <div class="absolute right-3 top-0 h-full flex items-center pointer-events-none z-30">
                        <button 
                            type="button" 
                            class="pointer-events-auto bg-transparent rounded-md cursor-pointer text-gris-medio hover:text-principal active:scale-125 transition-all duration-200 p-1 z-40"
                            onclick="togglePassword('id_new_password1', this)"
                            aria-label="Mostrar contraseña">
                            <!-- Ojo visible (mostrar cuando password está oculta) -->
                            <svg class="w-5 h-5 eye-visible" fill="currentColor" viewBox="0 0 512 512">
                                <path d="M256 105c-101.8 0-188.4 62.4-224 151 35.6 88.6 122.2 151 224 151s188.4-62.4 224-151c-35.6-88.6-122.2-151-224-151zM256 347c-50.6 0-91-40.4-91-91s40.4-91 91-91 91 40.4 91 91-40.4 91-91 91z"/>
                                <circle cx="256" cy="256" r="46"/>
                            </svg>
                            <!-- Ojo tachado (mostrar cuando password está visible) -->
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-5 eye-hidden hidden">
                                <path d="M3.53 2.47a.75.75 0 0 0-1.06 1.06l18 18a.75.75 0 1 0 1.06-1.06l-18-18ZM22.676 12.553a11.249 11.249 0 0 1-2.631 4.31l-3.099-3.099a5.25 5.25 0 0 0-6.71-6.71L7.759 4.577a11.217 11.217 0 0 1 4.242-.827c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113Z" />
                                <path d="M15.75 12c0 .18-.013.357-.037.53l-4.244-4.243A3.75 3.75 0 0 1 15.75 12ZM12.53 15.713l-4.243-4.244a3.75 3.75 0 0 0 4.244 4.243Z" />
                                <path d="M6.75 12c0-.619.107-1.213.304-1.764l-3.1-3.1a11.25 11.25 0 0 0-2.63 4.31c-.12.362-.12.752 0 1.114 1.489 4.467 5.704 7.69 10.675 7.69 1.5 0 2.933-.294 4.242-.827l-2.477-2.477A5.25 5.25 0 0 1 6.75 12Z" />
                            </svg>
                        </button>
                    </div>
                </div>
                {% if form.new_password1.errors %}
                    <div class="mt-2 space-y-1">
                        {% for error in form.new_password1.errors %}
                            <span class="block text-error text-sm flex items-center gap-1 animate-slideInError">
                                ⚠️ {{ error }}
                            </span>
                        {% endfor %}
                    </div>
                {% endif %}
                {% if form.new_password1.help_text %}
                    <div class="mt-3 flex items-start gap-2 p-3 bg-blue-50 rounded-lg border-l-4 border-info">
                        <span class="text-base text-secundario flex-shrink-0 mt-0.5">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-5">
                                <path d="M12 .75a8.25 8.25 0 0 0-4.135 15.39c.686.398 1.115 1.008 1.134 1.623a.75.75 0 0 0 .577.706c.352.083.71.148 1.074.195.323.041.6-.218.6-.544v-4.661a6.714 6.714 0 0 1-.937-.171.75.75 0 1 1 .374-1.453 5.261 5.261 0 0 0 2.626 0 .75.75 0 1 1 .374 1.452 6.712 6.712 0 0 1-.937.172v4.66c0 .327.277.586.6.545.364-.047.722-.112 1.074-.195a.75.75 0 0 0 .577-.706c.02-.615.448-1.225 1.134-1.623A8.25 8.25 0 0 0 12 .75Z" />
                                <path fill-rule="evenodd" d="M9.013 19.9a.75.75 0 0 1 .877-.597 11.319 11.319 0 0 0 4.22 0 .75.75 0 1 1 .28 1.473 12.819 12.819 0 0 1-4.78 0 .75.75 0 0 1-.597-.876ZM9.754 22.344a.75.75 0 0 1 .824-.668 13.682 13.682 0 0 0 2.844 0 .75.75 0 1 1 .156 1.492 15.156 15.156 0 0 1-3.156 0 .75.75 0 0 1-.668-.824Z" clip-rule="evenodd" />
                            </svg>
                        </span>
                        <span class="text-sm text-principal opacity-80 leading-relaxed">{{ form.new_password1.help_text }}</span>
                    </div>
                {% endif %}
            </div>

            <div class="form-field-group opacity-0 translate-y-5">
                <label for="id_new_password2" class="block text-sm font-semibold text-principal mb-3 flex items-center gap-2">
                    <span class="text-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                            <path fill-rule="evenodd" d="M12 1.5a5.25 5.25 0 0 0-5.25 5.25v3a3 3 0 0 0-3 3v6.75a3 3 0 0 0 3 3h10.5a3 3 0 0 0 3-3v-6.75a3 3 0 0 0-3-3v-3c0-2.9-2.35-5.25-5.25-5.25Zm3.75 8.25v-3a3.75 3.75 0 1 0-7.5 0v3h7.5Z" clip-rule="evenodd" />
                        </svg>
                    </span>
                    Confirmar contraseña
                </label>
                <div class="relative h-16">
                    <input type="password" 
                        name="{{ form.new_password2.name }}" 
                        id="id_new_password2" 
                        class="absolute inset-0 w-full px-4 pr-12 border-2 border-gray-200 rounded-xl text-base bg-gris-claro focus:border-principal focus:outline-none focus:bg-white hover:border-secundario"
                        placeholder="Confirma tu nueva contraseña"
                        value="{{ form.new_password2.value|default:'' }}"
                        required>
                    <div class="absolute right-3 top-0 h-full flex items-center pointer-events-none z-30">
                        <button 
                            type="button" 
                            class="pointer-events-auto bg-transparent rounded-md cursor-pointer text-gris-medio hover:text-principal active:scale-125 transition-all duration-200 p-1 z-40"
                            onclick="togglePassword('id_new_password2', this)"
                            aria-label="Mostrar contraseña">
                            <!-- Ojo visible (mostrar cuando password está oculta) -->
                            <svg class="w-5 h-5 eye-visible" fill="currentColor" viewBox="0 0 512 512">
                                <path d="M256 105c-101.8 0-188.4 62.4-224 151 35.6 88.6 122.2 151 224 151s188.4-62.4 224-151c-35.6-88.6-122.2-151-224-151zM256 347c-50.6 0-91-40.4-91-91s40.4-91 91-91 91 40.4 91 91-40.4 91-91 91z"/>
                                <circle cx="256" cy="256" r="46"/>
                            </svg>
                            <!-- Ojo tachado (mostrar cuando password está visible) -->
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-5 eye-hidden hidden">
                                <path d="M3.53 2.47a.75.75 0 0 0-1.06 1.06l18 18a.75.75 0 1 0 1.06-1.06l-18-18ZM22.676 12.553a11.249 11.249 0 0 1-2.631 4.31l-3.099-3.099a5.25 5.25 0 0 0-6.71-6.71L7.759 4.577a11.217 11.217 0 0 1 4.242-.827c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113Z" />
                                <path d="M15.75 12c0 .18-.013.357-.037.53l-4.244-4.243A3.75 3.75 0 0 1 15.75 12ZM12.53 15.713l-4.243-4.244a3.75 3.75 0 0 0 4.244 4.243Z" />
                                <path d="M6.75 12c0-.619.107-1.213.304-1.764l-3.1-3.1a11.25 11.25 0 0 0-2.63 4.31c-.12.362-.12.752 0 1.114 1.489 4.467 5.704 7.69 10.675 7.69 1.5 0 2.933-.294 4.242-.827l-2.477-2.477A5.25 5.25 0 0 1 6.75 12Z" />
                            </svg>
                        </button>
                    </div>
                </div>
                {% if form.new_password2.errors %}
                    <div class="mt-2 space-y-1">
                        {% for error in form.new_password2.errors %}
                            <span class="block text-error text-sm flex items-center gap-1 animate-slideInError">
                                ⚠️ {{ error }}
                            </span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="password-strength-info bg-gradient-to-br from-principal/5 to-secundario/5 rounded-lg p-4 my-6 border-l-4 border-secundario opacity-0 translate-y-5">
                <h4 class="text-principal text-sm font-semibold mb-3 m-0">Tu contraseña debe:</h4>
                <ul class="list-none p-0 m-0 space-y-2">
                    <li class="flex items-center gap-2 text-sm text-gray-600">
                        <span class="text-principal w-4 text-center mr-1">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                                <path fill-rule="evenodd" d="M12 2.25a.75.75 0 0 1 .75.75v.756a49.106 49.106 0 0 1 9.152 1 .75.75 0 0 1-.152 1.485h-1.918l2.474 10.124a.75.75 0 0 1-.375.84A6.723 6.723 0 0 1 18.75 18a6.723 6.723 0 0 1-3.181-.795.75.75 0 0 1-.375-.84l2.474-10.124H12.75v13.28c1.293.076 2.534.343 3.697.776a.75.75 0 0 1-.262 1.453h-8.37a.75.75 0 0 1-.262-1.453c1.162-.433 2.404-.7 3.697-.775V6.24H6.332l2.474 10.124a.75.75 0 0 1-.375.84A6.723 6.723 0 0 1 5.25 18a6.723 6.723 0 0 1-3.181-.795.75.75 0 0 1-.375-.84L4.168 6.241H2.25a.75.75 0 0 1-.152-1.485 49.105 49.105 0 0 1 9.152-1V3a.75.75 0 0 1 .75-.75Zm4.878 13.543 1.872-7.662 1.872 7.662h-3.744Zm-9.756 0L5.25 8.131l-1.872 7.662h3.744Z" clip-rule="evenodd" />
                            </svg>
                        </span>
                        Tener al menos 6 caracteres
                    </li>
                    <li class="flex items-center gap-2 text-sm text-gray-600">
                        <span class="text-principal w-4 text-center mr-1">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                                <path fill-rule="evenodd" d="M5.625 1.5c-1.036 0-1.875.84-1.875 1.875v17.25c0 1.035.84 1.875 1.875 1.875h12.75c1.035 0 1.875-.84 1.875-1.875V12.75A3.75 3.75 0 0 0 16.5 9h-1.875a1.875 1.875 0 0 1-1.875-1.875V5.25A3.75 3.75 0 0 0 9 1.5H5.625ZM7.5 15a.75.75 0 0 1 .75-.75h7.5a.75.75 0 0 1 0 1.5h-7.5A.75.75 0 0 1 7.5 15Zm.75 2.25a.75.75 0 0 0 0 1.5H12a.75.75 0 0 0 0-1.5H8.25Z" clip-rule="evenodd" />
                                <path d="M12.971 1.816A5.23 5.23 0 0 1 14.25 5.25v1.875c0 .207.168.375.375.375H16.5a5.23 5.23 0 0 1 3.434 1.279 9.768 9.768 0 0 0-6.963-6.963Z" />
                            </svg>
                        </span>
                        No ser demasiado común
                    </li>
                    <li class="flex items-center gap-2 text-sm text-gray-600">
                        <span class="w-4 text-center text-principal mr-1">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                                <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM3.751 20.105a8.25 8.25 0 0 1 16.498 0 .75.75 0 0 1-.437.695A18.683 18.683 0 0 1 12 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 0 1-.437-.695Z" clip-rule="evenodd" />
                            </svg>
                        </span>
                        No ser similar a tu información personal
                    </li>
                </ul>
            </div>

            <div class="form-submit-section opacity-0 translate-y-5">
                <button type="submit" class="reset-submit-btn w-full bg-gradient-to-r from-principal to-slate-600 text-white border-none rounded-xl px-8 py-4 text-lg font-semibold cursor-pointer transition-all duration-300 relative overflow-hidden shadow-btn-primary hover:shadow-btn-primary-hover hover:-translate-y-1 focus:outline-none focus:ring-4 focus:ring-principal/25">
                    <span class="relative z-10 flex items-center justify-center gap-3">
                        <span>Cambiar Contraseña</span>
                    </span>
                </button>
            </div>
        </form>

    {% else %}
        <!-- Enlace inválido o expirado -->
        <div class="text-center mb-8">
            <div class="w-14 h-14 mx-auto mb-4 text-error error-icon">
                <svg width="60" height="60" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-full h-full">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM13 17h-2v-6h2v6zm0-8h-2V7h2v2z" fill="currentColor"/>
                </svg>
            </div>
            <h2 class="text-3xl font-bold text-principal mb-3 tracking-wide">Enlace No Válido</h2>
            <p class="text-base text-gris-medio font-light opacity-90 leading-relaxed">
                El enlace ha expirado o no es válido
            </p>
            <div class="w-20 h-0.5 bg-gradient-to-r from-secundario to-principal mx-auto mt-4 rounded-full"></div>
        </div>

        <div class="error-content max-w-lg mx-auto mb-8 px-4 opacity-0 translate-y-5">
            <div class="text-center p-6 bg-gradient-to-br from-error/5 to-error/10 rounded-xl border border-error/20">
                <div class="text-5xl mb-4 text-principal items-center justify-center flex">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-8">
                        <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 0 0 0-1.5h-3.75V6Z" clip-rule="evenodd" />
                    </svg>
                </div>
                <h3 class="text-error text-2xl font-semibold mb-4">Enlace expirado</h3>
                <p class="text-gray-600 leading-relaxed">
                    El enlace de restablecimiento de contraseña ha expirado o ya fue utilizado. 
                    Los enlaces son válidos por <strong class="text-error">15 minutos</strong> por seguridad.
                </p>
            </div>
        </div>

        <div class="text-center">
            <a href="{% url 'accounts:password_reset' %}" 
               class="inline-flex items-center gap-3 bg-gradient-to-r from-principal to-slate-600 text-white border-none rounded-xl px-8 py-4 text-lg font-semibold cursor-pointer transition-all duration-300 relative overflow-hidden shadow-btn-primary hover:shadow-btn-primary-hover hover:-translate-y-1 focus:outline-none focus:ring-4 focus:ring-principal/25 hover:no-underline">
                <span class="relative z-10 flex items-center justify-center gap-3">
                    <span>Solicitar Nuevo Enlace</span>
                </span>
            </a>
        </div>
    {% endif %}

    <script>
        function togglePassword(inputId, button) {
            const input = document.getElementById(inputId);
            const eyeVisible = button.querySelector('.eye-visible');
            const eyeHidden = button.querySelector('.eye-hidden');
            
            if (input.type === 'password') {
                input.type = 'text';
                eyeVisible.classList.add('hidden');
                eyeHidden.classList.remove('hidden');
                button.setAttribute('aria-label', 'Ocultar contraseña');
            } else {
                input.type = 'password';
                eyeVisible.classList.remove('hidden');
                eyeHidden.classList.add('hidden');
                button.setAttribute('aria-label', 'Mostrar contraseña');
            }
        }

        // Animación de entrada escalonada
        document.addEventListener('DOMContentLoaded', function() {
            const formElements = document.querySelectorAll('.form-field-group, .form-submit-section, .password-strength-info, .error-content');
            formElements.forEach((element, index) => {
                setTimeout(() => {
                    element.style.transition = 'all 0.6s ease';
                    element.style.opacity = '1';
                    element.style.transform = 'translateY(0)';
                }, 200 * index);
            });

            // Efectos de línea de enfoque
            const inputs = document.querySelectorAll('input[type="password"]');
            inputs.forEach(input => {
                const focusLine = input.nextElementSibling;
                
                if (focusLine && focusLine.classList.contains('input-focus-line')) {
                    input.addEventListener('focus', function() {
                        focusLine.style.transform = 'scaleX(1)';
                    });
                    
                    input.addEventListener('blur', function() {
                        focusLine.style.transform = 'scaleX(0)';
                    });
                }
            });

            // Validación de coincidencia de contraseñas en tiempo real
            const password1 = document.getElementById('id_new_password1');
            const password2 = document.getElementById('id_new_password2');
            
            if (password1 && password2) {
                function checkPasswordMatch() {
                    if (password2.value === '') return;
                    
                    if (password1.value === password2.value) {
                        password2.style.borderColor = '#28A745';
                    } else {
                        password2.style.borderColor = '#DC3545';
                    }
                }
                
                password1.addEventListener('input', checkPasswordMatch);
                password2.addEventListener('input', checkPasswordMatch);
            }

            // Efecto de envío del formulario
            const form = document.querySelector('form');
            const submitBtn = document.querySelector('.reset-submit-btn');
            
            if (form && submitBtn) {
                form.addEventListener('submit', function() {
                    submitBtn.innerHTML = `
                        <span class="relative z-10 flex items-center justify-center gap-3">
                            <span class="loading-spinner"></span>
                            <span>Cambiando...</span>
                        </span>
                    `;
                    submitBtn.disabled = true;
                });
            }
        });
    </script>
{% endblock %}