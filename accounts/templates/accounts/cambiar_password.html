{% extends 'base.html' %}
{% load static %}

{% block title %}Cambiar Contraseña - Pilates Gravity{% endblock %}

{% block content %}
    <div class="min-h-screen bg-fondo p-4">
        <div class="text-center mt-4 mb-4 animate-slideInDown">
            <div class="header-content">
                <h1 class="text-4xl font-bold text-principal mb-2 flex items-center justify-center gap-4">
                    Cambiar Contraseña
                </h1>
                <p class="text-lg text-gris-medio font-light">
                    Actualiza tu contraseña para mantener tu cuenta segura
                </p>
            </div>
        </div>

        <div class="grid lg:grid-cols-[1fr_350px] gap-8 max-w-7xl mx-auto items-start">
            <div class="bg-blanco rounded-2xl shadow-wizard overflow-hidden animate-slideInLeft">
                <div class="bg-secundario text-white p-8 text-center">
                    <div class="w-15 h-15 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl backdrop-blur-sm">
                        <img src="{% static 'icons/security.png' %}" alt="Icono de Seguridad" class="w-[40px] h-auto">
                    </div>
                    <h2 class="text-2xl font-semibold mb-2">Seguridad de tu Cuenta</h2>
                    <p class="opacity-90 font-light">
                        Introduce tu contraseña actual y la nueva contraseña que deseas utilizar.
                    </p>
                </div>

                <form method="post" class="p-8" novalidate>
                    {% csrf_token %}
                    
                    <!-- Mostrar errores generales del formulario -->
                    {% if form.non_field_errors %}
                        <div class="mb-6 p-4 bg-gradient-to-r from-red-50 to-red-100 text-red-800 rounded-xl border border-red-200 flex items-center gap-2">
                            {% for error in form.non_field_errors %}
                                <p class="flex items-center gap-2 m-0">⚠️ {{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- Campo Contraseña Actual -->
                    <div class="mb-6">
                        <label for="{{ form.password_actual.id_for_label }}" class="block font-semibold text-gray-800 mb-2 text-sm">
                            {{ form.password_actual.label }}
                            <span class="text-error ml-1">*</span>
                        </label>
                        <div class="relative h-14">
                            <input 
                                type="password" 
                                name="{{ form.password_actual.name }}" 
                                id="{{ form.password_actual.id_for_label }}" 
                                class="absolute inset-0 w-full pr-12 p-4 border-2 border-gray-200 rounded-xl text-base bg-gray-50 hover:border-secundario focus:border-principal focus:outline-none focus:bg-white"
                                placeholder="{{ form.password_actual.label }}"
                                value="{{ form.password_actual.value|default:'' }}"
                            >
                            <div class="absolute right-3 top-0 h-full flex items-center z-20">
                                <button type="button" class="text-gris-medio hover:text-principal cursor-pointer p-1 toggle-password" data-target="{{ form.password_actual.id_for_label }}">
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 512 512">
                                        <path d="M256 105c-101.8 0-188.4 62.4-224 151 35.6 88.6 122.2 151 224 151s188.4-62.4 224-151c-35.6-88.6-122.2-151-224-151zM256 347c-50.6 0-91-40.4-91-91s40.4-91 91-91 91 40.4 91 91-40.4 91-91 91z"/>
                                        <circle cx="256" cy="256" r="46"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        {% if form.password_actual.errors %}
                            <div class="mt-2">
                                {% for error in form.password_actual.errors %}
                                    <span class="block text-error text-sm flex items-center gap-1">⚠️ {{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Campo Nueva Contraseña -->
                    <div class="mb-6">
                        <label for="{{ form.password_nueva.id_for_label }}" class="block font-semibold text-gray-800 mb-2 text-sm">
                            {{ form.password_nueva.label }}
                            <span class="text-error ml-1">*</span>
                        </label>
                        <div class="relative h-14">
                            <input 
                                type="password" 
                                name="{{ form.password_nueva.name }}" 
                                id="{{ form.password_nueva.id_for_label }}" 
                                class="absolute inset-0 w-full pr-12 p-4 border-2 border-gray-200 rounded-xl text-base bg-gray-50 hover:border-secundario focus:border-principal focus:outline-none focus:bg-white"
                                placeholder="{{ form.password_nueva.label }}"
                                value="{{ form.password_nueva.value|default:'' }}"
                            >
                            <div class="absolute right-3 top-0 h-full flex items-center z-20">
                                <button type="button" class="text-gris-medio hover:text-principal cursor-pointer p-1 toggle-password" data-target="{{ form.password_nueva.id_for_label }}">
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 512 512">
                                        <path d="M256 105c-101.8 0-188.4 62.4-224 151 35.6 88.6 122.2 151 224 151s188.4-62.4 224-151c-35.6-88.6-122.2-151-224-151zM256 347c-50.6 0-91-40.4-91-91s40.4-91 91-91 91 40.4 91 91-40.4 91-91 91z"/>
                                        <circle cx="256" cy="256" r="46"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="mt-2">
                            <div class="h-1 bg-gray-200 rounded-full overflow-hidden mb-1">
                                <div class="strength-fill h-full w-0 transition-all duration-300 rounded-full"></div>
                            </div>
                            <span class="text-sm text-gris-medio">Seguridad: <span class="strength-level font-semibold">-</span></span>
                        </div>
                        {% if form.password_nueva.help_text %}
                            <div class="mt-2 text-sm text-gris-medio flex items-center gap-1">
                                ℹ️ {{ form.password_nueva.help_text }}
                            </div>
                        {% endif %}
                        {% if form.password_nueva.errors %}
                            <div class="mt-2">
                                {% for error in form.password_nueva.errors %}
                                    <span class="block text-error text-sm flex items-center gap-1">⚠️ {{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Campo Confirmar Nueva Contraseña -->
                    <div class="mb-6">
                        <label for="{{ form.password_confirmacion.id_for_label }}" class="block font-semibold text-gray-800 mb-2 text-sm">
                            {{ form.password_confirmacion.label }}
                            <span class="text-error ml-1">*</span>
                        </label>
                        <div class="relative h-14">
                            <input 
                                type="password" 
                                name="{{ form.password_confirmacion.name }}" 
                                id="{{ form.password_confirmacion.id_for_label }}" 
                                class="absolute inset-0 w-full pr-12 p-4 border-2 border-gray-200 rounded-xl text-base bg-gray-50 hover:border-secundario focus:border-principal focus:outline-none focus:bg-white"
                                placeholder="{{ form.password_confirmacion.label }}"
                                value="{{ form.password_confirmacion.value|default:'' }}"
                            >
                            <div class="absolute right-3 top-0 h-full flex items-center z-20">
                                <button type="button" class="text-gris-medio hover:text-principal cursor-pointer p-1 toggle-password" data-target="{{ form.password_confirmacion.id_for_label }}">
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 512 512">
                                        <path d="M256 105c-101.8 0-188.4 62.4-224 151 35.6 88.6 122.2 151 224 151s188.4-62.4 224-151c-35.6-88.6-122.2-151-224-151zM256 347c-50.6 0-91-40.4-91-91s40.4-91 91-91 91 40.4 91 91-40.4 91-91 91z"/>
                                        <circle cx="256" cy="256" r="46"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="password-match mt-2 text-sm hidden items-center gap-1">
                            <span class="match-indicator flex items-center gap-1">
                                ✓ Las contraseñas coinciden
                            </span>
                        </div>
                        {% if form.password_confirmacion.errors %}
                            <div class="mt-2">
                                {% for error in form.password_confirmacion.errors %}
                                    <span class="block text-error text-sm flex items-center gap-1">⚠️ {{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Consejos de Seguridad -->
                    <div class="bg-gris-claro p-5 rounded-xl border-l-4 border-info my-6">
                        <h4 class="text-sm mb-3 text-gray-800 flex items-center gap-2">ℹ️ Consejos para una contraseña segura:</h4>
                        <ul class="list-none pl-5 m-0">
                            <li class="mb-1 text-sm text-gris-medio relative">Al menos 6 caracteres de longitud</li>
                            <li class="mb-1 text-sm text-gris-medio relative">Combina letras mayúsculas y minúsculas</li>
                            <li class="mb-1 text-sm text-gris-medio relative">Incluye números y símbolos</li>
                            <li class="mb-1 text-sm text-gris-medio relative">Evita información personal obvia</li>
                        </ul>
                    </div>

                    <!-- Botones de Acción -->
                    <div class="flex gap-4 mt-8 flex-wrap items-center justify-center">
                        <button type="submit" class="password-btn-primary px-6 py-4 border-none rounded-xl text-base font-semibold text-white inline-flex items-center gap-2 cursor-pointer transition-all duration-300 text-center justify-center min-w-36 shadow-btn-primary hover:shadow-btn-primary-hover hover:-translate-y-1">
                            Cambiar Contraseña
                        </button>
                        <a href="{% url 'accounts:profile' %}" class="password-btn-secondary px-6 py-4 border-none rounded-xl text-base font-semibold text-white inline-flex items-center gap-2 cursor-pointer transition-all duration-300 text-center justify-center min-w-36 bg-gris-medio hover:bg-gris-oscuro hover:-translate-y-0.5">
                            Cancelar
                        </a>
                    </div>
                </form>
            </div>

            <!-- Panel de Información Adicional -->
            <div class="flex flex-col gap-6 animate-slideInRight">
                <div class="bg-blanco rounded-2xl p-6 shadow-card-hover text-center transition-all duration-300 hover:-translate-y-1 hover:shadow-lg">
                    <div class="w-12 h-12 bg-gradient-to-br from-principal to-slate-600 rounded-full flex items-center justify-center mx-auto mb-4 text-xl text-white">
                        <svg class="w-6 h-6 text-secundario" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <h3 class="text-lg mb-3 text-gray-800 font-semibold">Seguridad de tu Cuenta</h3>
                    <p class="text-sm text-gris-medio leading-relaxed mb-4">
                        Tu contraseña es la primera línea de defensa para proteger tu cuenta. 
                        Te recomendamos cambiarla regularmente y no compartirla con nadie.
                    </p>
                    <ul class="list-none p-0 mt-4">
                        <li class="flex items-center gap-2 mb-2 text-sm text-gris-medio">
                            ✓ Encriptación de datos
                        </li>
                        <li class="flex items-center gap-2 mb-2 text-sm text-gris-medio">
                            ✓ Autenticación segura
                        </li>
                        <li class="flex items-center gap-2 mb-2 text-sm text-gris-medio">
                            ✓ Protección de privacidad
                        </li>
                    </ul>
                </div>

                <div class="bg-blanco rounded-2xl p-6 shadow-card-hover text-center transition-all duration-300 hover:-translate-y-1 hover:shadow-lg">
                    <div class="w-12 h-12 bg-secundario rounded-full flex items-center justify-center mx-auto mb-4 text-xl text-white">
                        <svg class="w-8 h-8 text-principal" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <h3 class="text-lg mb-3 text-gray-800 font-semibold">¿Olvidaste tu Contraseña?</h3>
                    <p class="text-sm text-gris-medio leading-relaxed mb-4">
                        Si has olvidado tu contraseña actual, puedes solicitar un 
                        restablecimiento por correo electrónico.
                    </p>
                    <a href="{% url 'accounts:password_reset' %}" class="password-btn-outline bg-transparent text-principal border-2 border-principal px-6 py-3 rounded-xl text-sm font-semibold inline-flex items-center gap-2 cursor-pointer transition-all duration-300 hover:bg-principal hover:text-white">
                        Restablecer Contraseña
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Toggle para mostrar/ocultar contraseñas
            const toggleButtons = document.querySelectorAll('.toggle-password');
            toggleButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('data-target');
                    const input = document.getElementById(targetId);
                    const icon = this;
                    
                    if (input.type === 'password') {
                        input.type = 'text';
                        icon.style.opacity = '0.7';
                    } else {
                        input.type = 'password';
                        icon.style.opacity = '1';
                    }
                });
            });

            // Validación de fuerza de contraseña
            const passwordInput = document.getElementById('{{ form.password_nueva.id_for_label }}');
            const strengthBar = document.querySelector('.strength-fill');
            const strengthText = document.querySelector('.strength-level');
            
            if (passwordInput) {
                passwordInput.addEventListener('input', function() {
                    const password = this.value;
                    const strength = calculatePasswordStrength(password);
                    updateStrengthIndicator(strength, strengthBar, strengthText);
                });
            }

            // Validación de coincidencia de contraseñas
            const confirmInput = document.getElementById('{{ form.password_confirmacion.id_for_label }}');
            const matchIndicator = document.querySelector('.password-match');
            
            if (confirmInput && passwordInput) {
                function checkPasswordMatch() {
                    const password = passwordInput.value;
                    const confirm = confirmInput.value;
                    
                    if (confirm === '') {
                        matchIndicator.style.display = 'none';
                        return;
                    }
                    
                    matchIndicator.style.display = 'flex';
                    
                    if (password === confirm) {
                        matchIndicator.classList.remove('no-match');
                        matchIndicator.classList.add('match');
                        matchIndicator.innerHTML = '<span class="match-indicator flex items-center gap-1">✓ Las contraseñas coinciden</span>';
                    } else {
                        matchIndicator.classList.remove('match');
                        matchIndicator.classList.add('no-match');
                        matchIndicator.innerHTML = '<span class="match-indicator flex items-center gap-1">⚠️ Las contraseñas no coinciden</span>';
                    }
                }
                
                passwordInput.addEventListener('input', checkPasswordMatch);
                confirmInput.addEventListener('input', checkPasswordMatch);
            }

            function calculatePasswordStrength(password) {
                let score = 0;
                
                if (password.length >= 8) score += 1;
                if (password.length >= 12) score += 1;
                if (/[a-z]/.test(password)) score += 1;
                if (/[A-Z]/.test(password)) score += 1;
                if (/[0-9]/.test(password)) score += 1;
                if (/[^A-Za-z0-9]/.test(password)) score += 1;
                
                return score;
            }

            function updateStrengthIndicator(strength, bar, text) {
                const levels = ['Muy débil', 'Débil', 'Regular', 'Buena', 'Fuerte', 'Muy fuerte'];
                const colors = ['#ff4444', '#ff8800', '#ffaa00', '#88cc00', '#44cc00', '#00aa44'];
                
                if (strength === 0) {
                    bar.style.width = '0%';
                    text.textContent = '-';
                    return;
                }
                
                const percentage = (strength / 6) * 100;
                bar.style.width = percentage + '%';
                bar.style.backgroundColor = colors[strength - 1];
                text.textContent = levels[strength - 1];
                text.style.color = colors[strength - 1];
            }
        });
    </script>
{% endblock %}