{% extends 'base.html' %}
{% load static %}

{% block title %}Cambiar Contrase√±a - Pilates Gravity{% endblock %}

{% block content %}
    <div class="min-h-screen bg-fondo p-4">
        <div class="text-center mt-4 mb-4 animate-slideInDown">
            <div class="header-content">
                <h1 class="text-4xl font-bold text-principal mb-2 flex items-center justify-center gap-4">
                    üõ°Ô∏è Cambiar Contrase√±a
                </h1>
                <p class="text-lg text-gris-medio font-light">
                    Actualiza tu contrase√±a para mantener tu cuenta segura
                </p>
            </div>
        </div>

        <div class="grid lg:grid-cols-[1fr_350px] gap-8 max-w-7xl mx-auto items-start">
            <div class="bg-blanco rounded-2xl shadow-wizard overflow-hidden animate-slideInLeft">
                <div class="bg-secundario text-white p-8 text-center">
                    <div class="w-15 h-15 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl backdrop-blur-sm">
                        üõ°Ô∏è
                    </div>
                    <h2 class="text-2xl font-semibold mb-2">Seguridad de tu Cuenta</h2>
                    <p class="opacity-90 font-light">
                        Introduce tu contrase√±a actual y la nueva contrase√±a que deseas utilizar.
                    </p>
                </div>

                <form method="post" class="p-8" novalidate>
                    {% csrf_token %}
                    
                    <!-- Mostrar errores generales del formulario -->
                    {% if form.non_field_errors %}
                        <div class="mb-6 p-4 bg-gradient-to-r from-red-50 to-red-100 text-red-800 rounded-xl border border-red-200 flex items-center gap-2">
                            {% for error in form.non_field_errors %}
                                <p class="flex items-center gap-2 m-0">‚ö†Ô∏è {{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- Campo Contrase√±a Actual -->
                    <div class="mb-6">
                        <label for="{{ form.password_actual.id_for_label }}" class="block font-semibold text-gray-800 mb-2 text-sm">
                            {{ form.password_actual.label }}
                            <span class="text-error ml-1">*</span>
                        </label>
                        <div class="relative flex items-center">
                            <input type="password" name="{{ form.password_actual.name }}" id="{{ form.password_actual.id_for_label }}" 
                                   class="w-full pr-12 p-4 border-2 border-gray-200 rounded-xl text-base transition-all duration-300 bg-gray-50 hover:border-secundario focus:border-principal focus:outline-none focus:ring-4 focus:ring-principal/10 focus:bg-white focus:-translate-y-0.5"
                                   placeholder="{{ form.password_actual.label }}"
                                   value="{{ form.password_actual.value|default:'' }}">
                            <button type="button" class="absolute right-3 top-1/2 -translate-y-1/2 bg-none border-none cursor-pointer text-gris-medio text-lg transition-all duration-200 flex items-center justify-center w-6 h-6 hover:text-principal hover:scale-125 toggle-password" data-target="{{ form.password_actual.id_for_label }}">
                                üëÅÔ∏è
                            </button>
                        </div>
                        {% if form.password_actual.errors %}
                            <div class="mt-2">
                                {% for error in form.password_actual.errors %}
                                    <span class="block text-error text-sm flex items-center gap-1">‚ö†Ô∏è {{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Campo Nueva Contrase√±a -->
                    <div class="mb-6">
                        <label for="{{ form.password_nueva.id_for_label }}" class="block font-semibold text-gray-800 mb-2 text-sm">
                            {{ form.password_nueva.label }}
                            <span class="text-error ml-1">*</span>
                        </label>
                        <div class="relative flex items-center">
                            <input type="password" name="{{ form.password_nueva.name }}" id="{{ form.password_nueva.id_for_label }}" 
                                   class="w-full pr-12 p-4 border-2 border-gray-200 rounded-xl text-base transition-all duration-300 bg-gray-50 hover:border-secundario focus:border-principal focus:outline-none focus:ring-4 focus:ring-principal/10 focus:bg-white focus:-translate-y-0.5"
                                   placeholder="{{ form.password_nueva.label }}"
                                   value="{{ form.password_nueva.value|default:'' }}">
                            <button type="button" class="absolute right-3 top-1/2 -translate-y-1/2 bg-none border-none cursor-pointer text-gris-medio text-lg transition-all duration-200 flex items-center justify-center w-6 h-6 hover:text-principal hover:scale-125 toggle-password" data-target="{{ form.password_nueva.id_for_label }}">
                                üëÅÔ∏è
                            </button>
                        </div>
                        <div class="mt-2">
                            <div class="h-1 bg-gray-200 rounded-full overflow-hidden mb-1">
                                <div class="strength-fill h-full w-0 transition-all duration-300 rounded-full"></div>
                            </div>
                            <span class="text-sm text-gris-medio">Seguridad: <span class="strength-level font-semibold">-</span></span>
                        </div>
                        {% if form.password_nueva.help_text %}
                            <div class="mt-2 text-sm text-gris-medio flex items-center gap-1">
                                ‚ÑπÔ∏è {{ form.password_nueva.help_text }}
                            </div>
                        {% endif %}
                        {% if form.password_nueva.errors %}
                            <div class="mt-2">
                                {% for error in form.password_nueva.errors %}
                                    <span class="block text-error text-sm flex items-center gap-1">‚ö†Ô∏è {{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Campo Confirmar Nueva Contrase√±a -->
                    <div class="mb-6">
                        <label for="{{ form.password_confirmacion.id_for_label }}" class="block font-semibold text-gray-800 mb-2 text-sm">
                            {{ form.password_confirmacion.label }}
                            <span class="text-error ml-1">*</span>
                        </label>
                        <div class="relative flex items-center">
                            <input type="password" name="{{ form.password_confirmacion.name }}" id="{{ form.password_confirmacion.id_for_label }}" 
                                   class="w-full pr-12 p-4 border-2 border-gray-200 rounded-xl text-base transition-all duration-300 bg-gray-50 hover:border-secundario focus:border-principal focus:outline-none focus:ring-4 focus:ring-principal/10 focus:bg-white focus:-translate-y-0.5"
                                   placeholder="{{ form.password_confirmacion.label }}"
                                   value="{{ form.password_confirmacion.value|default:'' }}">
                            <button type="button" class="absolute right-3 top-1/2 -translate-y-1/2 bg-none border-none cursor-pointer text-gris-medio text-lg transition-all duration-200 flex items-center justify-center w-6 h-6 hover:text-principal hover:scale-125 toggle-password" data-target="{{ form.password_confirmacion.id_for_label }}">
                                üëÅÔ∏è
                            </button>
                        </div>
                        <div class="password-match mt-2 text-sm hidden items-center gap-1">
                            <span class="match-indicator flex items-center gap-1">
                                ‚úì Las contrase√±as coinciden
                            </span>
                        </div>
                        {% if form.password_confirmacion.errors %}
                            <div class="mt-2">
                                {% for error in form.password_confirmacion.errors %}
                                    <span class="block text-error text-sm flex items-center gap-1">‚ö†Ô∏è {{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Consejos de Seguridad -->
                    <div class="bg-gris-claro p-5 rounded-xl border-l-4 border-info my-6">
                        <h4 class="text-sm mb-3 text-gray-800 flex items-center gap-2">‚ÑπÔ∏è Consejos para una contrase√±a segura:</h4>
                        <ul class="list-none pl-5 m-0">
                            <li class="mb-1 text-sm text-gris-medio relative">Al menos 6 caracteres de longitud</li>
                            <li class="mb-1 text-sm text-gris-medio relative">Combina letras may√∫sculas y min√∫sculas</li>
                            <li class="mb-1 text-sm text-gris-medio relative">Incluye n√∫meros y s√≠mbolos</li>
                            <li class="mb-1 text-sm text-gris-medio relative">Evita informaci√≥n personal obvia</li>
                        </ul>
                    </div>

                    <!-- Botones de Acci√≥n -->
                    <div class="flex gap-4 mt-8 flex-wrap items-center justify-center">
                        <button type="submit" class="password-btn-primary px-6 py-4 border-none rounded-xl text-base font-semibold text-white inline-flex items-center gap-2 cursor-pointer transition-all duration-300 text-center justify-center min-w-36 shadow-btn-primary hover:shadow-btn-primary-hover hover:-translate-y-1">
                            üíæ Cambiar Contrase√±a
                        </button>
                        <a href="{% url 'accounts:profile' %}" class="password-btn-secondary px-6 py-4 border-none rounded-xl text-base font-semibold text-white inline-flex items-center gap-2 cursor-pointer transition-all duration-300 text-center justify-center min-w-36 bg-gris-medio hover:bg-gris-oscuro hover:-translate-y-0.5">
                            ‚Üê Cancelar
                        </a>
                    </div>
                </form>
            </div>

            <!-- Panel de Informaci√≥n Adicional -->
            <div class="flex flex-col gap-6 animate-slideInRight">
                <div class="bg-blanco rounded-2xl p-6 shadow-card-hover text-center transition-all duration-300 hover:-translate-y-1 hover:shadow-lg">
                    <div class="w-12 h-12 bg-gradient-to-br from-principal to-slate-600 rounded-full flex items-center justify-center mx-auto mb-4 text-xl text-white">
                        ‚úÖ
                    </div>
                    <h3 class="text-lg mb-3 text-gray-800 font-semibold">Seguridad de tu Cuenta</h3>
                    <p class="text-sm text-gris-medio leading-relaxed mb-4">
                        Tu contrase√±a es la primera l√≠nea de defensa para proteger tu cuenta. 
                        Te recomendamos cambiarla regularmente y no compartirla con nadie.
                    </p>
                    <ul class="list-none p-0 mt-4">
                        <li class="flex items-center gap-2 mb-2 text-sm text-gris-medio">
                            ‚úì Encriptaci√≥n de datos
                        </li>
                        <li class="flex items-center gap-2 mb-2 text-sm text-gris-medio">
                            ‚úì Autenticaci√≥n segura
                        </li>
                        <li class="flex items-center gap-2 mb-2 text-sm text-gris-medio">
                            ‚úì Protecci√≥n de privacidad
                        </li>
                    </ul>
                </div>

                <div class="bg-blanco rounded-2xl p-6 shadow-card-hover text-center transition-all duration-300 hover:-translate-y-1 hover:shadow-lg">
                    <div class="w-12 h-12 bg-gradient-to-br from-advertencia to-orange-500 rounded-full flex items-center justify-center mx-auto mb-4 text-xl text-white">
                        üö®
                    </div>
                    <h3 class="text-lg mb-3 text-gray-800 font-semibold">¬øOlvidaste tu Contrase√±a?</h3>
                    <p class="text-sm text-gris-medio leading-relaxed mb-4">
                        Si has olvidado tu contrase√±a actual, puedes solicitar un 
                        restablecimiento por correo electr√≥nico.
                    </p>
                    <a href="{% url 'accounts:password_reset' %}" class="password-btn-outline bg-transparent text-principal border-2 border-principal px-6 py-3 rounded-xl text-sm font-semibold inline-flex items-center gap-2 cursor-pointer transition-all duration-300 hover:bg-principal hover:text-white">
                        ‚úâÔ∏è Restablecer Contrase√±a
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Toggle para mostrar/ocultar contrase√±as
            const toggleButtons = document.querySelectorAll('.toggle-password');
            toggleButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('data-target');
                    const input = document.getElementById(targetId);
                    const icon = this;
                    
                    if (input.type === 'password') {
                        input.type = 'text';
                        icon.style.opacity = '0.7';
                    } else {
                        input.type = 'password';
                        icon.style.opacity = '1';
                    }
                });
            });

            // Validaci√≥n de fuerza de contrase√±a
            const passwordInput = document.getElementById('{{ form.password_nueva.id_for_label }}');
            const strengthBar = document.querySelector('.strength-fill');
            const strengthText = document.querySelector('.strength-level');
            
            if (passwordInput) {
                passwordInput.addEventListener('input', function() {
                    const password = this.value;
                    const strength = calculatePasswordStrength(password);
                    updateStrengthIndicator(strength, strengthBar, strengthText);
                });
            }

            // Validaci√≥n de coincidencia de contrase√±as
            const confirmInput = document.getElementById('{{ form.password_confirmacion.id_for_label }}');
            const matchIndicator = document.querySelector('.password-match');
            
            if (confirmInput && passwordInput) {
                function checkPasswordMatch() {
                    const password = passwordInput.value;
                    const confirm = confirmInput.value;
                    
                    if (confirm === '') {
                        matchIndicator.style.display = 'none';
                        return;
                    }
                    
                    matchIndicator.style.display = 'flex';
                    
                    if (password === confirm) {
                        matchIndicator.classList.remove('no-match');
                        matchIndicator.classList.add('match');
                        matchIndicator.innerHTML = '<span class="match-indicator flex items-center gap-1">‚úì Las contrase√±as coinciden</span>';
                    } else {
                        matchIndicator.classList.remove('match');
                        matchIndicator.classList.add('no-match');
                        matchIndicator.innerHTML = '<span class="match-indicator flex items-center gap-1">‚ö†Ô∏è Las contrase√±as no coinciden</span>';
                    }
                }
                
                passwordInput.addEventListener('input', checkPasswordMatch);
                confirmInput.addEventListener('input', checkPasswordMatch);
            }

            function calculatePasswordStrength(password) {
                let score = 0;
                
                if (password.length >= 8) score += 1;
                if (password.length >= 12) score += 1;
                if (/[a-z]/.test(password)) score += 1;
                if (/[A-Z]/.test(password)) score += 1;
                if (/[0-9]/.test(password)) score += 1;
                if (/[^A-Za-z0-9]/.test(password)) score += 1;
                
                return score;
            }

            function updateStrengthIndicator(strength, bar, text) {
                const levels = ['Muy d√©bil', 'D√©bil', 'Regular', 'Buena', 'Fuerte', 'Muy fuerte'];
                const colors = ['#ff4444', '#ff8800', '#ffaa00', '#88cc00', '#44cc00', '#00aa44'];
                
                if (strength === 0) {
                    bar.style.width = '0%';
                    text.textContent = '-';
                    return;
                }
                
                const percentage = (strength / 6) * 100;
                bar.style.width = percentage + '%';
                bar.style.backgroundColor = colors[strength - 1];
                text.textContent = levels[strength - 1];
                text.style.color = colors[strength - 1];
            }
        });
    </script>
{% endblock %}