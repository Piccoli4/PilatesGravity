{% extends 'base.html' %}
{% load static %}

{% block title %}Mis Planes - Pilates Gravity{% endblock %}

{% block content %}
<div class="min-h-screen bg-fondo py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-principal mb-4 font-cinzel">
                Mis Planes de Pilates
            </h1>
            <p class="text-xl text-gris-oscuro max-w-3xl mx-auto">
                Gestiona tus planes, revisa tu estado actual y consulta tu historial de membresías.
            </p>
        </div>

        <!-- Estadísticas de la semana actual -->
        <div class="bg-blanco rounded-2xl shadow-lg border border-secundario/30 p-6 mb-8">
            <h2 class="text-xl font-bold text-principal mb-6 font-cinzel flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" class="w-10 h-10 text-secundario mr-3" fill="currentColor" stroke="currentColor">
                    <path d="M424 64C437.3 64 448 74.7 448 88L448 128L480 128C515.3 128 544 156.7 544 192L544 480C544 515.3 515.3 544 480 544L160 544C124.7 544 96 515.3 96 480L96 192C96 156.7 124.7 128 160 128L192 128L192 88C192 74.7 202.7 64 216 64C229.3 64 240 74.7 240 88L240 128L400 128L400 88C400 74.7 410.7 64 424 64zM160 176C151.2 176 144 183.2 144 192L144 480C144 488.8 151.2 496 160 496L480 496C488.8 496 496 488.8 496 480L496 192C496 183.2 488.8 176 480 176L160 176zM390.7 241.9C398.5 231.2 413.5 228.8 424.2 236.6C434.9 244.4 437.3 259.4 429.5 270.1L307.4 438.1C303.3 443.8 296.9 447.4 289.9 447.9C282.9 448.4 276 445.9 271.1 441L215.2 385.1C205.8 375.7 205.8 360.5 215.2 351.2C224.6 341.9 239.8 341.8 249.1 351.2L285.1 387.2L390.7 242z"/>
                </svg>
                Estado Semanal
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="bg-fondo rounded-xl p-5 border border-principal/20 text-center">
                    <div class="text-3xl font-black text-principal mb-2">{{ clases_disponibles }}</div>
                    <div class="text-sm font-medium text-gris-medio">Clases Disponibles</div>
                    <div class="text-xs text-gris-medio mt-1">Esta semana</div>
                </div>
                <div class="bg-fondo rounded-xl p-5 border border-principal/20 text-center">
                    <div class="text-3xl font-black text-exito mb-2">{{ reservas_actuales }}</div>
                    <div class="text-sm font-medium text-gris-medio">Clases Reservadas</div>
                    <div class="text-xs text-gris-medio mt-1">Actualmente</div>
                </div>
                <div class="bg-fondo rounded-xl p-5 border border-principal/20 text-center">
                    <div class="text-3xl font-black text-secundario mb-2">{{ clases_restantes }}</div>
                    <div class="text-sm font-medium text-gris-medio">Clases Restantes</div>
                    <div class="text-xs text-gris-medio mt-1">Por usar</div>
                </div>
                <div class="bg-fondo rounded-xl p-5 border border-principal/20 text-center">
                    <div class="text-3xl font-black text-info mb-2">{{ planes_activos|length }}</div>
                    <div class="text-sm font-medium text-gris-medio">Planes Activos</div>
                    <div class="text-xs text-gris-medio mt-1">Vigentes</div>
                </div>
            </div>
        </div>

        <!-- Contenido principal en dos columnas -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Columna izquierda: Planes Activos -->
            <div class="lg:col-span-2">
                <div class="bg-blanco rounded-2xl shadow-lg border border-secundario/30 p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-principal font-cinzel flex items-center">
                            <svg class="w-6 h-6 text-exito mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Planes Activos
                        </h2>
                        <a href="{% url 'gravity:seleccionar_plan' %}" class="bg-principal text-blanco px-4 py-2 rounded-lg text-sm font-semibold hover:bg-principal-dark transition-colors duration-200 shadow-md">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Agregar Plan
                        </a>
                    </div>

                    {% if planes_activos %}
                        <div class="space-y-4">
                            {% for plan_usuario in planes_activos %}
                            <div class="border border-secundario/30 rounded-xl p-5 hover:shadow-md transition-all duration-300 hover:border-principal/50">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center">
                                        <div class="w-3 h-3 bg-exito rounded-full mr-3"></div>
                                        <h3 class="text-lg font-bold text-principal">{{ plan_usuario.plan.nombre }}</h3>
                                        {% if plan_usuario.tipo_plan == 'temporal' %}
                                        <span class="ml-3 bg-info/20 text-info px-2 py-1 rounded-full text-xs font-medium">
                                            Temporal
                                        </span>
                                        {% endif %}
                                    </div>
                                    <div class="text-right">
                                        <div class="text-lg font-bold text-exito precio-formato">${{ plan_usuario.plan.precio_mensual }}</div>
                                        <div class="text-xs text-gris-medio">por mes</div>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                    <div class="text-center">
                                        <div class="text-xl font-bold text-principal">{{ plan_usuario.plan.clases_por_semana }}</div>
                                        <div class="text-xs text-gris-medio">Clases/semana</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-sm font-semibold text-gris-oscuro">{{ plan_usuario.get_estado_display }}</div>
                                        <div class="text-xs text-gris-medio">Estado</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-sm font-semibold text-gris-oscuro">{{ plan_usuario.dias_restantes }}</div>
                                        <div class="text-xs text-gris-medio">Días restantes</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-sm font-semibold text-gris-oscuro">{{ plan_usuario.fecha_fin|date:"d/m" }}</div>
                                        <div class="text-xs text-gris-medio">Vence</div>
                                    </div>
                                </div>

                                <!-- Barra de progreso temporal -->
                                {% if plan_usuario.dias_restantes <= 7 %}
                                    <div class="mb-3">
                                        <div class="flex justify-between text-xs text-gris-medio mb-1">
                                            <span>Tiempo restante</span>
                                            <span>{{ plan_usuario.dias_restantes }} días</span>
                                        </div>
                                        <div class="w-full bg-gris-claro rounded-full h-2">
                                            {% if plan_usuario.dias_restantes <= 1 %}
                                                <div class="h-2 rounded-full bg-error w-1/12"></div>
                                            {% elif plan_usuario.dias_restantes <= 2 %}
                                                <div class="h-2 rounded-full bg-error w-2/12"></div>
                                            {% elif plan_usuario.dias_restantes <= 3 %}
                                                <div class="h-2 rounded-full bg-advertencia w-3/12"></div>
                                            {% elif plan_usuario.dias_restantes <= 5 %}
                                                <div class="h-2 rounded-full bg-advertencia w-5/12"></div>
                                            {% else %}
                                                <div class="h-2 rounded-full bg-exito w-full"></div>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endif %}

                                <div class="flex justify-end space-x-2">
                                    <a href="{% url 'gravity:cancelar_plan' plan_usuario.id %}" class="text-error hover:text-error/80 text-sm font-medium transition-colors duration-200">
                                        Cancelar Plan
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-12">
                            <svg class="w-16 h-16 text-gris-medio mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                            </svg>
                            <h3 class="text-lg font-medium text-principal mb-2">No tienes planes activos</h3>
                            <p class="text-gris-medio mb-6">Selecciona un plan para empezar a reservar tus clases de Pilates.</p>
                            <a href="{% url 'gravity:seleccionar_plan' %}" class="inline-block bg-principal text-blanco py-3 px-6 rounded-lg font-semibold hover:bg-principal-dark transition-colors duration-200 shadow-md">
                                Seleccionar Plan
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Columna derecha: Reservas Actuales e Historial -->
            <div class="space-y-6">
                <!-- Reservas Actuales -->
                <div class="bg-blanco rounded-2xl shadow-lg border border-secundario/30 p-6">
                    <h3 class="text-lg font-bold text-principal mb-4 font-cinzel flex items-center">
                        <svg class="w-5 h-5 text-secundario mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 0h6M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-2"></path>
                        </svg>
                        Mis Reservas
                    </h3>
                    
                    {% if reservas_activas %}
                        <div class="space-y-3">
                            {% for reserva in reservas_activas %}
                            <div class="border border-secundario/20 rounded-lg p-3 text-sm">
                                <div class="font-semibold text-principal">{{ reserva.clase.get_nombre_display }}</div>
                                <div class="text-gris-medio">{{ reserva.clase.dia }} - {{ reserva.clase.horario|time:"H:i" }}</div>
                                <div class="text-xs text-gris-medio">{{ reserva.clase.get_direccion_corta }}</div>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="mt-4 pt-3 border-t border-secundario/20">
                            <a href="{% url 'gravity:reservar_clase' %}" class="text-principal hover:text-principal-dark text-sm font-medium">
                                Ver todas las reservas →
                            </a>
                        </div>
                    {% else %}
                        <div class="text-center py-8">
                            <svg class="w-12 h-12 text-gris-medio mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 0h6M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-2"></path>
                            </svg>
                            <p class="text-gris-medio text-sm">No tienes reservas activas</p>
                            {% if tiene_planes_activos %}
                            <a href="{% url 'gravity:reservar_clase' %}" class="inline-block mt-3 text-principal hover:text-principal-dark text-sm font-medium">
                                Reservar Clase →
                            </a>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>

                <!-- Historial de Planes -->
                {% if planes_vencidos %}
                <div class="bg-blanco rounded-2xl shadow-lg border border-secundario/30 p-6">
                    <h3 class="text-lg font-bold text-principal mb-4 font-cinzel flex items-center">
                        <svg class="w-5 h-5 text-gris-medio mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Historial
                    </h3>
                    
                    <div class="space-y-3">
                        {% for plan_vencido in planes_vencidos %}
                        <div class="border border-gris-claro rounded-lg p-3 text-sm opacity-75">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="font-medium text-gris-oscuro">{{ plan_vencido.plan.nombre }}</div>
                                    <div class="text-xs text-gris-medio">
                                        {{ plan_vencido.fecha_inicio|date:"d/m/Y" }} - {{ plan_vencido.fecha_fin|date:"d/m/Y" }}
                                    </div>
                                </div>
                                <div class="text-xs bg-gris-claro text-gris-medio px-2 py-1 rounded">
                                    Vencido
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Botones de acción -->
        <div class="text-center mt-8 space-x-4">
            <a href="{% url 'gravity:reservar_clase' %}" class="inline-block bg-principal text-fondo py-3 px-6 rounded-lg font-semibold hover:bg-principal/90 transition-colors duration-200 shadow-md">
                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                Reservar Clase
            </a>
            <a href="{% url 'gravity:seleccionar_plan' %}" class="inline-block bg-gris-oscuro text-blanco py-3 px-6 rounded-lg font-semibold hover:bg-gris-medio transition-colors duration-200 shadow-md">
                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012 2v2M7 7h10"></path>
                </svg>
                Cambiar Plan
            </a>
        </div>
    </div>
</div>

<!-- Script para formatear precios -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const precios = document.querySelectorAll('.precio-formato');
    precios.forEach(function(precio) {
        const valor = precio.textContent.replace('$', '');
        const formateado = parseInt(valor).toLocaleString('es-AR');
        precio.textContent = '$' + formateado;
    });
});
</script>
{% endblock %}