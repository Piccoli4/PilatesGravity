{% extends "base.html" %}
{% load static %}

{% block title %}Reservar Clase - Pilates Gravity{% endblock %}

{% block extra_css %}
    <style>
        .form-floating-label {
            position: relative;
        }
        
        .form-floating-label label {
            position: absolute;
            top: 50%;
            left: 12px;
            transform: translateY(-50%);
            color: #6C757D;
            transition: all 0.3s ease;
            pointer-events: none;
            background: white;
            padding: 0 4px;
        }
        
        .form-floating-label select:focus + label,
        .form-floating-label select:not(:invalid) + label {
            top: 0;
            font-size: 0.75rem;
            color: #5D768B;
            transform: translateY(-50%);
        }
        
        .availability-success {
            background: linear-gradient(135deg, #28A745 0%, #20C997 100%);
        }
        
        .availability-warning {
            background: linear-gradient(135deg, #FFC107 0%, #FD7E14 100%);
        }
        
        .availability-danger {
            background: linear-gradient(135deg, #DC3545 0%, #E74C3C 100%);
        }
        
        .availability-info {
            background: linear-gradient(135deg, #17A2B8 0%, #6F42C1 100%);
        }

        .form-step {
            opacity: 0.5;
            pointer-events: none;
            transition: all 0.3s ease;
        }
        
        .form-step.active {
            opacity: 1;
            pointer-events: all;
        }
        
        /* Estilos para la secci√≥n de planes */
        .plan-progress-bar {
            transition: width 0.5s ease-in-out;
        }
        
        .plan-stat-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .plan-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(93, 118, 139, 0.15);
        }
    </style>
{% endblock %}

{% block content %}
    <!-- Data container para JavaScript (invisible) -->
    <div id="page-data" 
         data-tiene-planes="{% if planes_activos %}true{% else %}false{% endif %}"
         data-clases-restantes="{{ clases_restantes|default:0 }}"
         data-reservas-actuales="{{ reservas_actuales|default:0 }}"
         data-clases-disponibles="{{ clases_disponibles|default:1 }}"
         style="display: none;">
    </div>

    <section class="min-h-screen bg-fondo pt-10 pb-12">
        <div class="container mx-auto px-4">
            <div class="max-w-4xl mx-auto">
                <!-- Encabezado de la p√°gina -->
                <div class="text-center mb-12">
                    <h1 class="text-4xl md:text-5xl font-cinzel font-bold text-principal mb-4 animate-fadeInUp">
                        Reserv√° tu Clase
                    </h1>
                    <div class="w-24 h-1 bg-gradient-to-r from-principal to-secundario mx-auto mb-6"></div>
                    <p class="text-lg text-gris-oscuro max-w-2xl mx-auto animate-fadeInUp" style="animation-delay: 0.2s;">
                        Complet√° el formulario para reservar tu lugar fijo. Tu reserva ser√° recurrente, 
                        asistir√°s todas las semanas al mismo d√≠a y horario en la sede elegida.
                    </p>
                </div>

                <!-- Formulario de reserva -->
                <div class="bg-white rounded-2xl shadow-wizard p-8 animate-fadeInUp" style="animation-delay: 0.4s;">
                    <form method="post" novalidate class="space-y-8">
                        {% csrf_token %}
                        
                        <!-- Datos del Usuario -->
                        <div class="space-y-6">
                            <h2 class="text-2xl font-bold text-principal border-b-2 border-gris-claro pb-3">
                                Datos Personales
                            </h2>
                            
                            <div class="bg-gris-claro rounded-xl p-6">
                                <!-- Primera fila: Nombre y Apellido -->
                                <div class="grid md:grid-cols-2 gap-6 mb-4">
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium text-gris-oscuro">Nombre:</label>
                                        <div class="bg-white rounded-lg p-3 border border-gris-medio/30">
                                            <span class="text-principal font-medium">
                                                {{ user_info.first_name|default:"No registrado" }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium text-gris-oscuro">Apellido:</label>
                                        <div class="bg-white rounded-lg p-3 border border-gris-medio/30">
                                            <span class="text-principal font-medium">
                                                {{ user_info.last_name|default:"No registrado" }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Segunda fila: Usuario -->
                                <div class="mb-4">
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium text-gris-oscuro">Usuario:</label>
                                        <div class="bg-white rounded-lg p-3 border border-gris-medio/30">
                                            <span class="text-principal font-medium">{{ user_info.username }}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Tercera fila: Email y Tel√©fono -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium text-gris-oscuro">Email:</label>
                                        <div class="bg-white rounded-lg p-3 border border-gris-medio/30">
                                            <span class="text-principal font-medium block truncate" title="{{ user_info.email|default:'No registrado' }}">
                                                {{ user_info.email|default:"No registrado" }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium text-gris-oscuro">Tel√©fono:</label>
                                        <div class="bg-white rounded-lg p-3 border border-gris-medio/30">
                                            <span class="text-principal font-medium">
                                                {{ user_info.telefono|default:"No registrado" }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {% if not user_info.telefono or not user_info.email %}
                            <div class="bg-info/10 border border-info/30 rounded-lg p-4 flex items-start space-x-3">
                                <div class="text-info text-xl">‚ÑπÔ∏è</div>
                                <div>
                                    <p class="text-info font-medium mb-1">Informaci√≥n incompleta</p>
                                    <p class="text-gris-oscuro text-sm">
                                        Te recomendamos completar tu informaci√≥n en tu 
                                        <a href="{% url 'accounts:profile' %}" class="text-principal hover:text-principal/80 font-medium underline">
                                            perfil de usuario
                                        </a> 
                                        para recibir notificaciones sobre tus clases.
                                    </p>
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Estado de Planes del Usuario -->
                        <div class="space-y-6">
                            <h2 class="text-2xl font-bold text-principal border-b-2 border-gris-claro pb-3 flex items-center">
                                <i class="fas fa-credit-card mr-3"></i>
                                Tu Plan Actual
                            </h2>
                            
                            <!-- Estado del plan activo -->
                            <div class="bg-gradient-to-r from-fondo to-white rounded-xl border border-secundario/20 p-6">
                                <!-- Si tiene planes activos -->
                                {% if planes_activos %}
                                    <div class="flex items-center justify-between flex-wrap gap-4">
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center space-x-3 mb-2">
                                                <div class="flex-shrink-0">
                                                    <div class="w-10 h-10 bg-gradient-to-br from-principal to-secundario rounded-full flex items-center justify-center">
                                                        <i class="fas fa-check text-white text-sm"></i>
                                                    </div>
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <h3 class="text-lg font-semibold text-principal truncate">
                                                        {{ planes_activos.first.plan.nombre }}
                                                    </h3>
                                                    <p class="text-sm text-gris-medio">
                                                        V√°lido hasta {{ planes_activos.first.fecha_fin|date:"d/m/Y" }}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Estad√≠sticas de uso -->
                                        <div class="flex items-center space-x-6">
                                            <div class="text-center px-4 py-2 bg-white/80 rounded-lg border border-principal/20 plan-stat-card">
                                                <div class="text-2xl font-bold text-principal">
                                                    {{ clases_disponibles|default:0 }}
                                                </div>
                                                <div class="text-xs text-gris-medio font-medium">Disponibles</div>
                                            </div>
                                            <div class="text-center px-4 py-2 bg-white/80 rounded-lg border border-gris-medio/20 plan-stat-card">
                                                <div class="text-2xl font-bold text-gris-oscuro">
                                                    {{ reservas_actuales|default:0 }}
                                                </div>
                                                <div class="text-xs text-gris-medio font-medium">Usadas</div>
                                            </div>
                                            <div class="text-center px-4 py-2 bg-white/80 rounded-lg border border-exito/20 plan-stat-card">
                                                <div class="text-2xl font-bold {% if clases_restantes > 0 %}text-exito{% else %}text-error{% endif %}">
                                                    {{ clases_restantes|default:0 }}
                                                </div>
                                                <div class="text-xs text-gris-medio font-medium">Restantes</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Barra de progreso visual -->
                                    <div class="mt-4">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-sm font-medium text-gris-oscuro">Uso semanal</span>
                                            <span class="text-sm text-gris-medio">
                                                {{ reservas_actuales|default:0 }}/{{ clases_disponibles|default:0 }} clases
                                            </span>
                                        </div>
                                        <div class="w-full bg-gris-claro rounded-full h-2">
                                            <div id="progress-bar" class="bg-gradient-to-r from-principal to-secundario h-2 rounded-full plan-progress-bar" 
                                                 style="width: 0%;">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Enlace a gesti√≥n de planes -->
                                    <div class="mt-4 text-center">
                                        <a href="{% url 'gravity:mis_planes' %}" 
                                           class="inline-flex items-center px-4 py-2 text-sm font-medium text-principal hover:text-secundario transition-colors duration-200 group">
                                            <i class="fas fa-cog mr-2"></i>
                                            Gestionar mis planes
                                            <i class="fas fa-arrow-right ml-2 transform group-hover:translate-x-1 transition-transform duration-200"></i>
                                        </a>
                                    </div>
                                    
                                {% else %}
                                    <!-- No tiene planes activos -->
                                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-6">
                                        <div class="text-center">
                                            <div class="w-16 h-16 bg-gradient-to-br from-principal to-secundario rounded-full flex items-center justify-center mx-auto mb-4">
                                                <i class="fas fa-info text-white text-xl"></i>
                                            </div>
                                            <h3 class="text-lg font-semibold text-principal mb-2">
                                                Necesitas seleccionar un plan
                                            </h3>
                                            <p class="text-gris-oscuro text-sm mb-4">
                                                Para poder reservar clases, primero debes seleccionar un plan de pago que se ajuste a tus necesidades.
                                            </p>
                                            <a href="{% url 'gravity:seleccionar_plan' %}?next=reservar" 
                                               class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-principal to-secundario text-white font-semibold rounded-lg hover:shadow-lg transform hover:scale-105 transition-all duration-200">
                                                <i class="fas fa-credit-card mr-2"></i>
                                                Seleccionar Plan
                                                <i class="fas fa-arrow-right ml-2"></i>
                                            </a>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Advertencia si no puede reservar -->
                            {% if planes_activos and clases_restantes == 0 %}
                                <div class="bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-xl p-4">
                                    <div class="flex items-start space-x-3">
                                        <div class="flex-shrink-0">
                                            <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.96-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <h4 class="text-amber-800 font-semibold mb-1">L√≠mite de clases alcanzado</h4>
                                            <p class="text-amber-700 text-sm mb-3">
                                                Ya has usado todas las clases disponibles en tu plan para esta semana. 
                                                Tu plan se renovar√° el {{ planes_activos.first.fecha_fin|date:"d/m/Y" }}.
                                            </p>
                                            <div class="flex flex-wrap gap-2">
                                                <a href="{% url 'gravity:seleccionar_plan' %}" 
                                                   class="inline-flex items-center px-3 py-1 bg-amber-600 text-white text-sm font-medium rounded-lg hover:bg-amber-700 transition-colors duration-200">
                                                    <i class="fas fa-plus mr-1"></i>
                                                    Agregar plan adicional
                                                </a>
                                                <a href="{% url 'gravity:mis_planes' %}" 
                                                   class="inline-flex items-center px-3 py-1 bg-white border border-amber-600 text-amber-600 text-sm font-medium rounded-lg hover:bg-amber-50 transition-colors duration-200">
                                                    <i class="fas fa-cog mr-1"></i>
                                                    Gestionar planes
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Selecci√≥n de Clase -->
                        <div class="space-y-6" id="seccion-formulario">
                            <h2 class="text-2xl font-bold text-principal border-b-2 border-gris-claro pb-3">
                                Selecci√≥n de Clase
                                <span id="form-status-indicator" class="text-sm font-normal text-error ml-2 hidden">(Requiere plan activo)</span>
                            </h2>
                            
                            <!-- Indicador de progreso -->
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center space-x-2">
                                    <div class="step-indicator step-active" data-step="1">
                                        <span class="step-number">1</span>
                                        <span class="step-text">Tipo de Clase</span>
                                    </div>
                                    <div class="step-connector"></div>
                                    <div class="step-indicator" data-step="2">
                                        <span class="step-number">2</span>
                                        <span class="step-text">Sede</span>
                                    </div>
                                    <div class="step-connector"></div>
                                    <div class="step-indicator" data-step="3">
                                        <span class="step-number">3</span>
                                        <span class="step-text">D√≠a</span>
                                    </div>
                                    <div class="step-connector"></div>
                                    <div class="step-indicator" data-step="4">
                                        <span class="step-number">4</span>
                                        <span class="step-text">Horario</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Formulario de selecci√≥n -->
                            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <!-- Tipo de Clase -->
                                <div class="form-step active">
                                    <label for="id_tipo_clase" class="block text-sm font-medium text-gris-oscuro mb-2">
                                        Tipo de Clase
                                    </label>
                                    {{ form.tipo_clase }}
                                    {% if form.tipo_clase.errors %}
                                        <div class="mt-2 text-error text-sm">
                                            {% for error in form.tipo_clase.errors %}
                                                <span class="block">{{ error }}</span>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Sede -->
                                <div class="form-step">
                                    <label for="id_sede" class="block text-sm font-medium text-gris-oscuro mb-2">
                                        Sede
                                    </label>
                                    {{ form.sede }}
                                    {% if form.sede.errors %}
                                        <div class="mt-2 text-error text-sm">
                                            {% for error in form.sede.errors %}
                                                <span class="block">{{ error }}</span>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- D√≠a -->
                                <div class="form-step">
                                    <label for="id_dia" class="block text-sm font-medium text-gris-oscuro mb-2">
                                        D√≠a de la Semana
                                    </label>
                                    {{ form.dia }}
                                    {% if form.dia.errors %}
                                        <div class="mt-2 text-error text-sm">
                                            {% for error in form.dia.errors %}
                                                <span class="block">{{ error }}</span>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Horario -->
                                <div class="form-step">
                                    <label for="id_horario" class="block text-sm font-medium text-gris-oscuro mb-2">
                                        Horario
                                    </label>
                                    {{ form.horario }}
                                    {% if form.horario.errors %}
                                        <div class="mt-2 text-error text-sm">
                                            {% for error in form.horario.errors %}
                                                <span class="block">{{ error }}</span>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Informaci√≥n de disponibilidad -->
                            <div id="disponibilidad-info" class="hidden mt-6">
                                <div id="disponibilidad-mensaje" class="rounded-lg p-4 text-principal font-medium flex items-center space-x-3">
                                    <div>
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <span id="disponibilidad-text"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Bot√≥n de env√≠o -->
                            <div class="text-center pt-6">
                                <button type="submit" id="btn-reservar"
                                        class="inline-flex items-center px-8 py-4 text-white font-bold rounded-md transition-all duration-300 hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-principal/25 relative overflow-hidden group"
                                        style="background: linear-gradient(135deg, #C8B39B, #5D768B);">
                                    <!-- √çcono y texto en la misma fila -->
                                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    <span id="btn-text">Confirmar Reserva Recurrente</span>
                                    
                                    <!-- Efecto de brillo -->
                                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent transform -skew-x-12 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-1000"></div>
                                </button>
                            </div>

                            <!-- Informaci√≥n importante -->
                            <div id="info-importante" class="bg-gradient-to-r from-info/5 to-blue-50 border border-info/20 rounded-xl p-4 mt-6">
                                <div class="flex items-start space-x-3">
                                    <div class="text-info text-xl">üí°</div>
                                    <div>
                                        <p class="text-info font-medium mb-1">Informaci√≥n importante</p>
                                        <ul class="text-gris-oscuro text-sm space-y-1">
                                            <li>‚Ä¢ Tu reserva ser√° <strong>recurrente</strong>: asistir√°s cada semana al mismo d√≠a y horario</li>
                                            <li>‚Ä¢ Puedes modificar o cancelar con 12 horas de anticipaci√≥n</li>
                                            <li>‚Ä¢ Recibir√°s un recordatorio 24 horas antes de cada clase</li>
                                            <li id="limite-clases-info">‚Ä¢ Esta reserva contar√° contra tu l√≠mite semanal</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Enlaces de navegaci√≥n adicionales -->
                <div class="text-center mt-8 space-y-2">
                    <p class="text-gris-medio">
                        ¬øNecesitas ajustar tu plan?
                        <a href="{% url 'gravity:mis_planes' %}" class="text-principal hover:text-secundario font-medium underline">
                            Gestiona tus planes aqu√≠
                        </a>
                    </p>
                    <p class="text-gris-medio text-sm">
                        ¬øDudas?
                        <a href="{% url 'gravity:conoce_mas' %}#contacto" class="text-principal hover:text-secundario font-medium underline">
                            Cont√°ctanos
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Obtener datos desde data attributes
            const pageData = document.getElementById('page-data');
            const tienePlanesActivos = pageData.dataset.tienePlanes === 'true';
            const clasesRestantes = parseInt(pageData.dataset.clasesRestantes) || 0;
            const reservasActuales = parseInt(pageData.dataset.reservasActuales) || 0;
            const clasesDisponibles = parseInt(pageData.dataset.clasesDisponibles) || 1;

            // Elementos del DOM
            const tipoClase = document.getElementById('id_tipo_clase');
            const sede = document.getElementById('id_sede');
            const dia = document.getElementById('id_dia');
            const horario = document.getElementById('id_horario');
            const btnReservar = document.getElementById('btn-reservar');
            const btnText = document.getElementById('btn-text');
            const disponibilidadInfo = document.getElementById('disponibilidad-info');
            const disponibilidadMensaje = document.getElementById('disponibilidad-mensaje');
            const disponibilidadText = document.getElementById('disponibilidad-text');
            const seccionFormulario = document.getElementById('seccion-formulario');
            const formStatusIndicator = document.getElementById('form-status-indicator');
            const infoImportante = document.getElementById('info-importante');
            const limiteClasesInfo = document.getElementById('limite-clases-info');

            // Configurar estado inicial del formulario
            function configurarEstadoFormulario() {
                if (!tienePlanesActivos || clasesRestantes <= 0) {
                    // Deshabilitar formulario
                    seccionFormulario.style.opacity = '0.5';
                    seccionFormulario.style.pointerEvents = 'none';
                    formStatusIndicator.classList.remove('hidden');
                    
                    // Cambiar texto del bot√≥n
                    if (!tienePlanesActivos) {
                        btnText.innerHTML = 'Selecciona un plan primero';
                    } else if (clasesRestantes <= 0) {
                        btnText.innerHTML = 'Sin clases disponibles';
                    }
                    
                    btnReservar.disabled = true;
                    btnReservar.classList.add('opacity-50', 'cursor-not-allowed');
                    
                    // Ocultar informaci√≥n importante
                    if (infoImportante) {
                        infoImportante.style.display = 'none';
                    }
                    
                    // Deshabilitar campos del formulario
                    const formElements = document.querySelectorAll('select');
                    formElements.forEach(element => {
                        element.disabled = true;
                        element.classList.add('opacity-50');
                    });
                } else {
                    // Actualizar informaci√≥n de l√≠mite de clases
                    if (limiteClasesInfo) {
                        limiteClasesInfo.textContent = `‚Ä¢ Esta reserva contar√° contra tu l√≠mite semanal de ${clasesDisponibles} clases`;
                    }
                }
            }

            // Actualizar barra de progreso
            function actualizarBarraProgreso() {
                const progressBar = document.getElementById('progress-bar');
                if (progressBar && clasesDisponibles > 0) {
                    const percentage = Math.min((reservasActuales / clasesDisponibles) * 100, 100);
                    progressBar.style.width = percentage + '%';
                }
            }

            // Clase principal para manejar el formulario
            class ReservaFormHandler {
                constructor() {
                    this.currentStep = 1;
                    this.initEventListeners();
                    this.updateStepVisual(1);
                }

                initEventListeners() {
                    // Event listeners para los selects
                    tipoClase?.addEventListener('change', () => this.onTipoClaseChange());
                    sede?.addEventListener('change', () => this.onSedeChange());
                    dia?.addEventListener('change', () => this.onDiaChange());
                    horario?.addEventListener('change', () => this.onHorarioChange());
                    
                    // Event listener para el formulario
                    document.querySelector('form')?.addEventListener('submit', (e) => this.onFormSubmit(e));
                }

                // Paso 1: Cambio de tipo de clase
                onTipoClaseChange() {
                    if (tipoClase.value) {
                        this.mostrarCargando('Cargando sedes disponibles...');
                        this.currentStep = 2;
                        this.updateStepVisual(2);
                        
                        // Cargar sedes para el tipo seleccionado
                        this.cargarSedes(tipoClase.value);
                    } else {
                        this.resetearFormulario();
                    }
                }

                // Paso 2: Cambio de sede
                onSedeChange() {
                    if (sede.value) {
                        this.mostrarCargando('Cargando d√≠as disponibles...');
                        this.currentStep = 3;
                        this.updateStepVisual(3);
                        
                        // Cargar d√≠as para la combinaci√≥n tipo-sede
                        this.cargarDias(tipoClase.value, sede.value);
                    } else {
                        this.resetearDiasYHorarios();
                    }
                }

                // Paso 3: Cambio de d√≠a
                onDiaChange() {
                    if (dia.value) {
                        this.mostrarCargando('Cargando horarios disponibles...');
                        this.currentStep = 4;
                        this.updateStepVisual(4);
                        
                        // Cargar horarios para la combinaci√≥n tipo-sede-d√≠a
                        this.cargarHorarios(tipoClase.value, sede.value, dia.value);
                    } else {
                        this.resetearSelectHorario();
                        this.currentStep = 3;
                        this.updateStepVisual(3);
                    }
                }

                // Paso 4: Cambio de horario
                onHorarioChange() {
                    if (horario.value) {
                        this.mostrarCargando('Verificando disponibilidad...');
                        
                        // Verificar disponibilidad de la combinaci√≥n completa
                        this.verificarDisponibilidad(tipoClase.value, sede.value, dia.value, horario.value);
                    } else {
                        this.ocultarDisponibilidad();
                    }
                }

                // Actualizar indicador visual de pasos
                updateStepVisual(activeStep) {
                    // Actualizar indicadores de paso
                    const stepIndicators = document.querySelectorAll('.step-indicator');
                    stepIndicators.forEach((indicator, index) => {
                        const stepNumber = index + 1;
                        if (stepNumber <= activeStep) {
                            indicator.classList.add('step-active');
                        } else {
                            indicator.classList.remove('step-active');
                        }
                    });

                    // Habilitar/deshabilitar campos de formulario
                    const formSteps = document.querySelectorAll('.form-step');
                    formSteps.forEach((step, index) => {
                        const stepNumber = index + 1;
                        if (stepNumber <= activeStep) {
                            step.classList.add('active');
                        } else {
                            step.classList.remove('active');
                        }
                    });
                }

                // M√©todo para cargar sedes via AJAX
                async cargarSedes(tipo) {
                    try {
                        const response = await fetch('/api/sedes-disponibles/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCSRFToken()
                            },
                            body: JSON.stringify({tipo: tipo})
                        });

                        if (!response.ok) {
                            throw new Error(`Error HTTP: ${response.status}`);
                        }

                        const data = await response.json();
                        this.actualizarSelectSedes(data.sedes);
                        this.ocultarDisponibilidad();

                    } catch (error) {
                        console.error('Error cargando sedes:', error);
                        this.mostrarError('Error al cargar las sedes. Intenta nuevamente.');
                    }
                }

                // M√©todo para cargar d√≠as via AJAX
                async cargarDias(tipo, sedeSeleccionada) {
                    try {
                        const response = await fetch('/api/dias-disponibles/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCSRFToken()
                            },
                            body: JSON.stringify({
                                tipo: tipo,
                                sede: sedeSeleccionada
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`Error HTTP: ${response.status}`);
                        }

                        const data = await response.json();
                        this.actualizarSelectDias(data.dias);
                        this.ocultarDisponibilidad();

                    } catch (error) {
                        console.error('Error cargando d√≠as:', error);
                        this.mostrarError('Error al cargar los d√≠as disponibles. Intenta nuevamente.');
                    }
                }

                // M√©todo para cargar horarios via AJAX
                async cargarHorarios(tipo, sedeSeleccionada, diaSeleccionado) {
                    try {
                        const response = await fetch('/api/horarios-disponibles/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCSRFToken()
                            },
                            body: JSON.stringify({
                                tipo: tipo,
                                sede: sedeSeleccionada,
                                dia: diaSeleccionado
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`Error HTTP: ${response.status}`);
                        }

                        const data = await response.json();
                        this.actualizarSelectHorarios(data.horarios);
                        this.ocultarDisponibilidad();

                    } catch (error) {
                        console.error('Error cargando horarios:', error);
                        this.mostrarError('Error al cargar los horarios disponibles. Intenta nuevamente.');
                    }
                }

                // M√©todo para verificar disponibilidad via AJAX
                async verificarDisponibilidad(tipo, sedeSeleccionada, diaSeleccionado, horarioSeleccionado) {
                    try {
                        const response = await fetch('/api/verificar-disponibilidad/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCSRFToken()
                            },
                            body: JSON.stringify({
                                tipo: tipo,
                                sede: sedeSeleccionada,
                                dia: diaSeleccionado,
                                horario: horarioSeleccionado
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`Error HTTP: ${response.status}`);
                        }

                        const data = await response.json();
                        this.mostrarDisponibilidad(data);

                    } catch (error) {
                        console.error('Error verificando disponibilidad:', error);
                        this.mostrarError('Error al verificar disponibilidad. Intenta nuevamente.');
                    }
                }

                actualizarSelectSedes(sedes) {
                    this.limpiarSelect(sede, 'Selecciona la sede');
                    
                    sedes.forEach(sedeInfo => {
                        const option = document.createElement('option');
                        option.value = sedeInfo.value;
                        option.textContent = sedeInfo.text;
                        sede.appendChild(option);
                    });
                }

                actualizarSelectDias(diasDisponibles) {
                    this.limpiarSelect(dia, 'Selecciona el d√≠a');
                    
                    diasDisponibles.forEach(diaDisponible => {
                        const option = document.createElement('option');
                        option.value = diaDisponible;
                        option.textContent = diaDisponible;
                        dia.appendChild(option);
                    });
                }

                actualizarSelectHorarios(horariosDisponibles) {
                    this.limpiarSelect(horario, 'Selecciona el horario');
                    
                    horariosDisponibles.forEach(horarioInfo => {
                        const option = document.createElement('option');
                        option.value = horarioInfo.value;
                        option.textContent = horarioInfo.text;
                        option.disabled = !horarioInfo.disponible;
                        if (!horarioInfo.disponible) {
                            option.classList.add('text-gris-medio');
                        }
                        horario.appendChild(option);
                    });
                }

                limpiarSelect(selectElement, placeholderText) {
                    selectElement.innerHTML = '';
                    const placeholderOption = document.createElement('option');
                    placeholderOption.value = '';
                    placeholderOption.textContent = placeholderText;
                    selectElement.appendChild(placeholderOption);
                }

                resetearSelectHorario() {
                    this.limpiarSelect(horario, 'Selecciona el horario');
                }

                resetearDiasYHorarios() {
                    this.limpiarSelect(dia, 'Selecciona el d√≠a');
                    this.resetearSelectHorario();
                    this.currentStep = 1;
                    this.updateStepVisual(1);
                }

                resetearFormulario() {
                    sede.selectedIndex = 0;
                    dia.selectedIndex = 0;
                    horario.selectedIndex = 0;
                    this.resetearSelectHorario();
                    this.ocultarDisponibilidad();
                    this.currentStep = 1;
                    this.updateStepVisual(0);
                }

                // Estados de disponibilidad
                mostrarDisponibilidad(disponibilidad) {
                    disponibilidadInfo.classList.remove('hidden');
                    
                    // Remover clases anteriores
                    disponibilidadMensaje.className = 'rounded-lg p-4 text-principal font-medium flex items-center space-x-3';
                    
                    if (disponibilidad.disponible) {
                        disponibilidadMensaje.classList.add('availability-success');
                        const sedeText = disponibilidad.sede ? ` en ${disponibilidad.sede}` : '';
                        disponibilidadText.textContent = `¬°Clase Disponible! ${disponibilidad.cupos_disponibles} lugares restantes${sedeText}`;
                    } else {
                        disponibilidadMensaje.classList.add('availability-warning');
                        disponibilidadText.textContent = disponibilidad.mensaje;
                    }
                }

                mostrarCargando(mensaje) {
                    disponibilidadInfo.classList.remove('hidden');
                    disponibilidadMensaje.className = 'rounded-lg p-4 text-principal font-medium flex items-center space-x-3 availability-info';
                    disponibilidadText.textContent = mensaje;
                }

                mostrarError(mensaje) {
                    disponibilidadInfo.classList.remove('hidden');
                    disponibilidadMensaje.className = 'rounded-lg p-4 text-principal font-medium flex items-center space-x-3 availability-danger';
                    disponibilidadText.textContent = mensaje;
                }

                ocultarDisponibilidad() {
                    disponibilidadInfo.classList.add('hidden');
                }

                // Maneja el env√≠o del formulario
                onFormSubmit(e) {
                    if (!this.validarFormulario()) {
                        e.preventDefault();
                        return false;
                    }

                    // Deshabilita el bot√≥n y muestra indicador de carga
                    btnReservar.disabled = true;
                    btnText.innerHTML = '‚è≥ Procesando reserva...';
                    btnReservar.classList.add('opacity-75', 'cursor-not-allowed');
                }

                // Validaci√≥n
                validarFormulario() {
                    const campos = [
                        { element: tipoClase, nombre: 'tipo de clase' },
                        { element: sede, nombre: 'sede' },
                        { element: dia, nombre: 'd√≠a' },
                        { element: horario, nombre: 'horario' }
                    ];

                    for (const campo of campos) {
                        if (!campo.element.value) {
                            // Mostrar error visual
                            campo.element.classList.add('border-error', 'animate-errorShake');
                            setTimeout(() => {
                                campo.element.classList.remove('border-error', 'animate-errorShake');
                            }, 3000);
                            
                            campo.element.focus();
                            this.mostrarError(`Por favor selecciona ${campo.nombre}.`);
                            return false;
                        }
                    }

                    return true;
                }

                getCSRFToken() {
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
                    return csrfToken ? csrfToken.value : '';
                }
            }

            // Configurar estado inicial
            configurarEstadoFormulario();
            actualizarBarraProgreso();

            // Inicializar formulario solo si tiene planes activos y clases disponibles
            if (tienePlanesActivos && clasesRestantes > 0) {
                new ReservaFormHandler();
            }

            // Validaci√≥n en tiempo real
            const selectFields = document.querySelectorAll('select');
            selectFields.forEach(field => {
                field.addEventListener('change', function() {
                    this.classList.remove('border-error');
                });
                
                field.addEventListener('focus', function() {
                    if (!this.disabled) {
                        this.classList.add('ring-2', 'ring-principal/20', 'border-principal');
                    }
                });
                
                field.addEventListener('blur', function() {
                    this.classList.remove('ring-2', 'ring-principal/20', 'border-principal');
                });
            });

            // Smooth scroll para evitar problemas con header fijo
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        const headerHeight = 80;
                        const targetPosition = target.offsetTop - headerHeight;
                        
                        window.scrollTo({
                            top: targetPosition,
                            behavior: 'smooth'
                        });
                    }
                });
            });
        });
    </script>
{% endblock %}