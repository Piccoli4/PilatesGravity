{% extends "base.html" %}
{% load static %}

{% block title %}Reservar Clase - Pilates Gravity{% endblock %}

{% block extra_css %}
<style>
    .form-floating-label {
        position: relative;
    }
    
    .form-floating-label label {
        position: absolute;
        top: 50%;
        left: 12px;
        transform: translateY(-50%);
        color: #6C757D;
        transition: all 0.3s ease;
        pointer-events: none;
        background: white;
        padding: 0 4px;
    }
    
    .form-floating-label select:focus + label,
    .form-floating-label select:not(:invalid) + label {
        top: 0;
        font-size: 0.75rem;
        color: #5D768B;
        transform: translateY(-50%);
    }
    
    .availability-success {
        background: linear-gradient(135deg, #28A745 0%, #20C997 100%);
    }
    
    .availability-warning {
        background: linear-gradient(135deg, #FFC107 0%, #FD7E14 100%);
    }
    
    .availability-danger {
        background: linear-gradient(135deg, #DC3545 0%, #E74C3C 100%);
    }
    
    .availability-info {
        background: linear-gradient(135deg, #17A2B8 0%, #6F42C1 100%);
    }
</style>
{% endblock %}

{% block content %}
    <section class="min-h-screen bg-fondo pt-10 pb-12">
        <div class="container mx-auto px-4">
            <div class="max-w-4xl mx-auto">
                <!-- Encabezado de la página -->
                <div class="text-center mb-12">
                    <h1 class="text-4xl md:text-5xl font-cinzel font-bold text-principal mb-4 animate-fadeInUp">
                        Reservá tu Clase
                    </h1>
                    <div class="w-24 h-1 bg-gradient-to-r from-principal to-secundario mx-auto mb-6"></div>
                    <p class="text-lg text-gris-oscuro max-w-2xl mx-auto animate-fadeInUp" style="animation-delay: 0.2s;">
                        Completá el formulario para reservar tu lugar fijo. Tu reserva será recurrente, 
                        asistirás todas las semanas al mismo día y horario.
                    </p>
                </div>

                <!-- Formulario de reserva -->
                <div class="bg-white rounded-2xl shadow-wizard p-8 animate-fadeInUp" style="animation-delay: 0.4s;">
                    <form method="post" novalidate class="space-y-8">
                        {% csrf_token %}
                        
                        <!-- Datos del Usuario -->
                        <div class="space-y-6">
                            <h2 class="text-2xl font-bold text-principal border-b-2 border-gris-claro pb-3">
                                Datos Personales
                            </h2>
                            
                            <div class="bg-gris-claro rounded-xl p-6">
                                <!-- Primera fila: Nombre y Apellido -->
                                <div class="grid md:grid-cols-2 gap-6 mb-4">
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium text-gris-oscuro">Nombre:</label>
                                        <div class="bg-white rounded-lg p-3 border border-gris-medio/30">
                                            <span class="text-principal font-medium">
                                                {{ user_info.first_name|default:"No registrado" }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium text-gris-oscuro">Apellido:</label>
                                        <div class="bg-white rounded-lg p-3 border border-gris-medio/30">
                                            <span class="text-principal font-medium">
                                                {{ user_info.last_name|default:"No registrado" }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Segunda fila: Usuario -->
                                <div class="mb-4">
                                    <div class="space-y-2">
                                        <label class="text-sm font-medium text-gris-oscuro">Usuario:</label>
                                        <div class="bg-white rounded-lg p-3 border border-gris-medio/30">
                                            <span class="text-principal font-medium">{{ user_info.username }}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Tercera fila: Email y Teléfono -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="space-y-2">
                                            <label class="text-sm font-medium text-gris-oscuro">Email:</label>
                                            <div class="bg-white rounded-lg p-3 border border-gris-medio/30">
                                                <span class="text-principal font-medium block truncate" title="{{ user_info.email|default:'No registrado' }}">
                                                    {{ user_info.email|default:"No registrado" }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="space-y-2">
                                            <label class="text-sm font-medium text-gris-oscuro">Teléfono:</label>
                                            <div class="bg-white rounded-lg p-3 border border-gris-medio/30">
                                                <span class="text-principal font-medium">
                                                    {{ user_info.telefono|default:"No registrado" }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                            </div>
                            
                            {% if not user_info.telefono or not user_info.email %}
                            <div class="bg-info/10 border border-info/30 rounded-lg p-4 flex items-start space-x-3">
                                <div class="text-info text-xl">ℹ️</div>
                                <div>
                                    <p class="text-info font-medium mb-1">Información incompleta</p>
                                    <p class="text-gris-oscuro text-sm">
                                        Te recomendamos completar tu información en tu 
                                        <a href="{% url 'accounts:profile' %}" class="text-principal hover:text-principal/80 font-medium underline">
                                            perfil de usuario
                                        </a> 
                                        para recibir notificaciones sobre tus clases.
                                    </p>
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Selección de Clase -->
                        <div class="space-y-6">
                            <h2 class="text-2xl font-bold text-principal border-b-2 border-gris-claro pb-3">
                                Selección de Clase
                            </h2>
                            
                            <div class="grid md:grid-cols-3 gap-6">
                                <!-- Tipo de Clase -->
                                <div class="space-y-2">
                                    <label for="{{ form.tipo_clase.id_for_label }}" class="block text-sm font-medium text-gris-oscuro">
                                        {{ form.tipo_clase.label }}
                                    </label>
                                    <div class="relative">
                                        {{ form.tipo_clase }}
                                    </div>
                                    {% for error in form.tipo_clase.errors %}
                                        <p class="text-error text-sm animate-slideInError">{{ error }}</p>
                                    {% endfor %}
                                </div>
                                
                                <!-- Día -->
                                <div class="space-y-2">
                                    <label for="{{ form.dia.id_for_label }}" class="block text-sm font-medium text-gris-oscuro">
                                        {{ form.dia.label }}
                                    </label>
                                    <div class="relative">
                                        {{ form.dia }}
                                    </div>
                                    {% for error in form.dia.errors %}
                                        <p class="text-error text-sm animate-slideInError">{{ error }}</p>
                                    {% endfor %}
                                </div>
                                
                                <!-- Horario -->
                                <div class="space-y-2">
                                    <label for="{{ form.horario.id_for_label }}" class="block text-sm font-medium text-gris-oscuro">
                                        {{ form.horario.label }}
                                    </label>
                                    <div class="relative">
                                        {{ form.horario }}
                                    </div>
                                    {% for error in form.horario.errors %}
                                        <p class="text-error text-sm animate-slideInError">{{ error }}</p>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Indicador de disponibilidad -->
                            <div id="disponibilidad-info" class="hidden">
                                <div id="disponibilidad-mensaje" class="rounded-lg p-4 text-white font-medium flex items-center space-x-3">
                                    <span id="disponibilidad-icon"></span>
                                    <span id="disponibilidad-text"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Errores generales del formulario -->
                        {% if form.non_field_errors %}
                            <div class="bg-error/10 border border-error/30 rounded-lg p-4 flex items-start space-x-3 animate-slideInError">
                                <div class="text-error text-xl">⚠️</div>
                                <div>
                                    <p class="text-error font-medium mb-1">Error en la reserva</p>
                                    <div class="text-gris-oscuro text-sm">
                                        {{ form.non_field_errors }}
                                    </div>
                                </div>
                            </div>
                        {% endif %}

                        <!-- Botón de envío -->
                        <div class="text-center pt-6">
                            <button type="submit" 
                                    id="btn-reservar"
                                    class="bg-principal hover:bg-principal/90 text-white px-12 py-4 rounded-lg font-semibold text-lg transition-all duration-300 hover:shadow-btn-primary-hover transform hover:-translate-y-1 focus:outline-none focus:ring-4 focus:ring-principal/20">
                                <span id="btn-text">Reservar Clase</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos del formulario
            const tipoClase = document.getElementById('id_tipo_clase');
            const dia = document.getElementById('id_dia');
            const horario = document.getElementById('id_horario');
            const disponibilidadInfo = document.getElementById('disponibilidad-info');
            const disponibilidadMensaje = document.getElementById('disponibilidad-mensaje');
            const disponibilidadIcon = document.getElementById('disponibilidad-icon');
            const disponibilidadText = document.getElementById('disponibilidad-text');
            const btnReservar = document.getElementById('btn-reservar');
            const btnText = document.getElementById('btn-text');
            const form = document.querySelector('form');

            // Configuración
            const API_ENDPOINTS = {
                diasDisponibles: '/api/dias-disponibles/',
                horariosDisponibles: '/api/horarios-disponibles/',
                verificarDisponibilidad: '/api/verificar-disponibilidad/'
            };

            // Clase principal para manejar el formulario
            class ReservaFormHandler {
                constructor() {
                    this.initEventListeners();
                    this.manejarPreseleccion();
                }

                // Inicializa los event listeners
                initEventListeners() {
                    if (tipoClase) {
                        tipoClase.addEventListener('change', () => this.onTipoClaseChange());
                    }
                    if (dia) {
                        dia.addEventListener('change', () => this.onDiaChange());
                    }
                    if (horario) {
                        horario.addEventListener('change', () => this.onHorarioChange());
                    }
                    if (form) {
                        form.addEventListener('submit', (e) => this.onFormSubmit(e));
                    }
                }

                // Maneja el cambio de tipo de clase
                async onTipoClaseChange() {
                    const tipoSeleccionado = tipoClase.value;
                    
                    if (!tipoSeleccionado) {
                        this.resetearFormulario();
                        return;
                    }

                    try {
                        this.mostrarCargando('Cargando días disponibles...');
                        const diasDisponibles = await this.obtenerDiasDisponibles(tipoSeleccionado);
                        this.actualizarSelectDias(diasDisponibles);
                        this.resetearSelectHorario();
                        this.ocultarDisponibilidad();
                    } catch (error) {
                        console.error('Error al obtener días disponibles:', error);
                        this.mostrarError('Error al cargar días disponibles');
                    }
                }

                // Maneja la preselección de tipo de clase desde la URL
                manejarPreseleccion() {
                    const tipoPreseleccionado = '{{ tipo_preseleccionado|default:"" }}';
                    
                    if (tipoPreseleccionado && tipoClase) {
                        const opciones = tipoClase.options;
                        for (let i = 0; i < opciones.length; i++) {
                            if (opciones[i].value === tipoPreseleccionado) {
                                tipoClase.selectedIndex = i;
                                tipoClase.dispatchEvent(new Event('change'));
                                break;
                            }
                        }
                    }
                }

                // Maneja el cambio de día
                async onDiaChange() {
                    const tipoSeleccionado = tipoClase.value;
                    const diaSeleccionado = dia.value;

                    if (!tipoSeleccionado || !diaSeleccionado) {
                        this.resetearSelectHorario();
                        this.ocultarDisponibilidad();
                        return;
                    }

                    try {
                        this.mostrarCargando('Cargando horarios disponibles...');
                        const horariosDisponibles = await this.obtenerHorariosDisponibles(tipoSeleccionado, diaSeleccionado);
                        this.actualizarSelectHorarios(horariosDisponibles);
                        this.ocultarDisponibilidad();
                    } catch (error) {
                        console.error('Error al obtener horarios disponibles:', error);
                        this.mostrarError('Error al cargar horarios disponibles');
                    }
                }

                // Maneja el cambio de horario
                async onHorarioChange() {
                    const tipoSeleccionado = tipoClase.value;
                    const diaSeleccionado = dia.value;
                    const horarioSeleccionado = horario.value;

                    if (!tipoSeleccionado || !diaSeleccionado || !horarioSeleccionado) {
                        this.ocultarDisponibilidad();
                        return;
                    }

                    try {
                        this.mostrarCargando('Verificando disponibilidad...');
                        const disponibilidad = await this.verificarDisponibilidad(tipoSeleccionado, diaSeleccionado, horarioSeleccionado);
                        this.mostrarDisponibilidad(disponibilidad);
                    } catch (error) {
                        console.error('Error al verificar disponibilidad:', error);
                        this.mostrarError('Error al verificar disponibilidad');
                    }
                }

                // Maneja el envío del formulario
                onFormSubmit(e) {
                    if (!this.validarFormulario()) {
                        e.preventDefault();
                        return false;
                    }

                    // Deshabilita el botón y muestra indicador de carga
                    btnReservar.disabled = true;
                    btnText.innerHTML = '⏳ Procesando reserva...';
                    btnReservar.classList.add('opacity-75', 'cursor-not-allowed');
                }

                // APIs
                async obtenerDiasDisponibles(tipo) {
                    const response = await fetch(API_ENDPOINTS.diasDisponibles, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCSRFToken()
                        },
                        body: JSON.stringify({ tipo })
                    });

                    if (!response.ok) {
                        throw new Error('Error en la respuesta del servidor');
                    }

                    const data = await response.json();
                    return data.dias || [];
                }

                async obtenerHorariosDisponibles(tipo, dia) {
                    const response = await fetch(API_ENDPOINTS.horariosDisponibles, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCSRFToken()
                        },
                        body: JSON.stringify({ tipo, dia })
                    });

                    if (!response.ok) {
                        throw new Error('Error en la respuesta del servidor');
                    }

                    const data = await response.json();
                    return data.horarios || [];
                }

                async verificarDisponibilidad(tipo, dia, horario) {
                    const response = await fetch(API_ENDPOINTS.verificarDisponibilidad, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCSRFToken()
                        },
                        body: JSON.stringify({ tipo, dia, horario })
                    });

                    if (!response.ok) {
                        throw new Error('Error en la respuesta del servidor');
                    }

                    return await response.json();
                }

                // UI Updates
                actualizarSelectDias(diasDisponibles) {
                    this.limpiarSelect(dia, 'Selecciona el día');
                    
                    diasDisponibles.forEach(diaDisponible => {
                        const option = document.createElement('option');
                        option.value = diaDisponible;
                        option.textContent = diaDisponible;
                        dia.appendChild(option);
                    });
                }

                actualizarSelectHorarios(horariosDisponibles) {
                    this.limpiarSelect(horario, 'Selecciona el horario');
                    
                    horariosDisponibles.forEach(horarioInfo => {
                        const option = document.createElement('option');
                        option.value = horarioInfo.value;
                        option.textContent = horarioInfo.text;
                        horario.appendChild(option);
                    });
                }

                limpiarSelect(selectElement, placeholderText) {
                    selectElement.innerHTML = '';
                    const placeholderOption = document.createElement('option');
                    placeholderOption.value = '';
                    placeholderOption.textContent = placeholderText;
                    selectElement.appendChild(placeholderOption);
                }

                resetearSelectHorario() {
                    this.limpiarSelect(horario, 'Selecciona el horario');
                }

                resetearFormulario() {
                    dia.selectedIndex = 0;
                    horario.selectedIndex = 0;
                    this.resetearSelectHorario();
                    this.ocultarDisponibilidad();
                }

                // Estados de disponibilidad
                mostrarDisponibilidad(disponibilidad) {
                    disponibilidadInfo.classList.remove('hidden');
                    
                    // Remover clases anteriores
                    disponibilidadMensaje.className = 'rounded-lg p-4 text-white font-medium flex items-center space-x-3';
                    
                    if (disponibilidad.disponible) {
                        disponibilidadMensaje.classList.add('availability-success');
                        disponibilidadIcon.textContent = '✅';
                        disponibilidadText.textContent = `¡Disponible! ${disponibilidad.cupos_disponibles} lugares restantes`;
                    } else {
                        disponibilidadMensaje.classList.add('availability-warning');
                        disponibilidadIcon.textContent = '⚠️';
                        disponibilidadText.textContent = disponibilidad.mensaje;
                    }
                }

                mostrarCargando(mensaje) {
                    disponibilidadInfo.classList.remove('hidden');
                    disponibilidadMensaje.className = 'rounded-lg p-4 text-white font-medium flex items-center space-x-3 availability-info';
                    disponibilidadIcon.textContent = '⏳';
                    disponibilidadText.textContent = mensaje;
                }

                mostrarError(mensaje) {
                    disponibilidadInfo.classList.remove('hidden');
                    disponibilidadMensaje.className = 'rounded-lg p-4 text-white font-medium flex items-center space-x-3 availability-danger';
                    disponibilidadIcon.textContent = '❌';
                    disponibilidadText.textContent = mensaje;
                }

                ocultarDisponibilidad() {
                    disponibilidadInfo.classList.add('hidden');
                }

                // Validación
                validarFormulario() {
                    const campos = [
                        { element: tipoClase, nombre: 'tipo de clase' },
                        { element: dia, nombre: 'día' },
                        { element: horario, nombre: 'horario' }
                    ];

                    for (const campo of campos) {
                        if (!campo.element.value) {
                            // Mostrar error visual
                            campo.element.classList.add('border-error', 'animate-errorShake');
                            setTimeout(() => {
                                campo.element.classList.remove('border-error', 'animate-errorShake');
                            }, 3000);
                            
                            campo.element.focus();
                            this.mostrarError(`Por favor selecciona el ${campo.nombre}.`);
                            return false;
                        }
                    }

                    return true;
                }

                getCSRFToken() {
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
                    return csrfToken ? csrfToken.value : '';
                }
            }

            // Inicializar el manejador del formulario
            new ReservaFormHandler();
        });
    </script>
{% endblock %}

{% block extra_js %}
    <script>
        // Smooth scroll para evitar problemas con header fijo
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    const headerHeight = 80;
                    const targetPosition = target.offsetTop - headerHeight;
                    
                    window.scrollTo({
                        top: targetPosition,
                        behavior: 'smooth'
                    });
                }
            });
        });
    </script>
{% endblock %}