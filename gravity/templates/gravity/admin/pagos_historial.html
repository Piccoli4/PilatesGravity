{% extends "gravity/admin/base_admin.html" %}

{% block title %}Historial de Pagos{% endblock %}

{% block breadcrumb %}
    <li class="flex items-center gap-1">
        <span class="text-gris-medio">/</span>
        <span class="text-gris-medio">Pagos</span>
    </li>
    <li class="flex items-center">
        <span class="text-gris-medio">/</span>
        <span class="ml-1 text-gris-medio">Historial de {{ cliente.get_full_name|default:cliente.username }}</span>
    </li>
{% endblock %}

{% block content %}
    <!-- HEADER -->
    <div class="card p-3 flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-6">
        <div>
            <div class="flex items-center gap-2 text-principal">
                <svg class="size-10" fill="currentColor" viewBox="0 0 640 640" xmlns="http://www.w3.org/2000/svg">
                    <path d="M128 128C92.7 128 64 156.7 64 192L64 448C64 483.3 92.7 512 128 512L512 512C547.3 512 576 483.3 576 448L576 192C576 156.7 547.3 128 512 128L128 128zM360 352L488 352C501.3 352 512 362.7 512 376C512 389.3 501.3 400 488 400L360 400C346.7 400 336 389.3 336 376C336 362.7 346.7 352 360 352zM336 264C336 250.7 346.7 240 360 240L488 240C501.3 240 512 250.7 512 264C512 277.3 501.3 288 488 288L360 288C346.7 288 336 277.3 336 264zM212 208C223 208 232 217 232 228L232 232L240 232C251 232 260 241 260 252C260 263 251 272 240 272L192.5 272C185.6 272 180 277.6 180 284.5C180 290.6 184.4 295.8 190.4 296.8L232.1 303.8C257.4 308 276 329.9 276 355.6C276 381.7 257 403.3 232 407.4L232 412.1C232 423.1 223 432.1 212 432.1C201 432.1 192 423.1 192 412.1L192 408.1L168 408.1C157 408.1 148 399.1 148 388.1C148 377.1 157 368.1 168 368.1L223.5 368.1C230.4 368.1 236 362.5 236 355.6C236 349.5 231.6 344.3 225.6 343.3L183.9 336.3C158.5 332 140 310.1 140 284.5C140 255.7 163.2 232.3 192 232L192 228C192 217 201 208 212 208z"/>
                </svg>
                <h1 class="text-3xl font-bold text-principal">Historial de Pagoso</h1>
            </div>
            <p class="text-gris-medio">
                Cliente: <strong class="text-principal">{{ cliente.get_full_name|default:cliente.username }}</strong>
            </p>
        </div>
        <div class="flex flex-col sm:flex-row gap-2 w-full lg:w-auto">
            <a href="{% url 'gravity:admin_pagos_registrar_pago' cliente.id %}" 
               class="btn-primary flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-medium transition-all duration-200 hover:shadow-btn-primary-hover">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Registrar Pago
            </a>
            <a href="{% url 'gravity:admin_pagos_vista_principal' %}" 
               class="btn-secondary flex items-center justify-center gap-2 px-4 py-2 rounded-lg font-medium transition-all duration-200">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                Volver a Pagos
            </a>
        </div>
    </div>

    <!-- RESUMEN DEL CLIENTE -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="bg-blanco rounded-lg shadow-md border border-gray-100 p-6 text-center hover:shadow-lg transition-shadow duration-200">
            <h6 class="text-gris-medio text-sm font-medium mb-2">Total Pagado</h6>
            <h3 class="text-2xl font-bold text-principal money">${{ total_pagado }}</h3>
        </div>
        <div class="bg-blanco rounded-lg shadow-md border border-gray-100 p-6 text-center hover:shadow-lg transition-shadow duration-200">
            <h6 class="text-gris-medio text-sm font-medium mb-2">Total Pagos</h6>
            <h3 class="text-2xl font-bold text-info">{{ total_pagos }}</h3>
        </div>
        <div class="bg-blanco rounded-lg shadow-md border border-gray-100 p-6 text-center hover:shadow-lg transition-shadow duration-200">
            <h6 class="text-gris-medio text-sm font-medium mb-2">Saldo Actual</h6>
            {% if estado_pago.saldo_actual >= 0 %}
                <h3 class="text-2xl font-bold text-exito money">${{ estado_pago.saldo_actual }}</h3>
            {% else %}
                <h3 class="text-2xl font-bold text-error money">${{ estado_pago.saldo_actual }}</h3>
            {% endif %}
        </div>
        <div class="bg-blanco rounded-lg shadow-md border border-gray-100 p-6 text-center hover:shadow-lg transition-shadow duration-200">
            <h6 class="text-gris-medio text-sm font-medium mb-2">Plan Actual</h6>
            {% if estado_pago.plan_actual %}
                <div class="font-bold text-principal">{{ estado_pago.plan_actual.nombre }}</div>
                <small class="text-gris-medio money">${{ estado_pago.plan_actual.precio_mensual }}</small>
                <small class="text-gris-medio">/ mes</small>
            {% else %}
                <div class="text-gris-medio">Sin plan</div>
            {% endif %}
        </div>
    </div>

    <!-- HISTORIAL DE PAGOS -->
    <div class="card bg-blanco rounded-lg shadow-md border border-gray-100 overflow-hidden">
        <div class="card-header border-b border-gray-200 px-6 py-4">
            <div class="flex items-center gap-2 text-blanco">
                <svg class="size-6" fill="currentColor" viewBox="0 0 640 640" xmlns="http://www.w3.org/2000/svg">
                    <path d="M64 192C64 156.7 92.7 128 128 128L512 128C547.3 128 576 156.7 576 192L576 448C576 483.3 547.3 512 512 512L128 512C92.7 512 64 483.3 64 448L64 192zM160 376C160 389.3 170.7 400 184 400L328 400C341.3 400 352 389.3 352 376C352 362.7 341.3 352 328 352L184 352C170.7 352 160 362.7 160 376zM184 240C170.7 240 160 250.7 160 264C160 277.3 170.7 288 184 288L456 288C469.3 288 480 277.3 480 264C480 250.7 469.3 240 456 240L184 240z"/>
                </svg>
                <h5 class="text-lg">Historial de Pagos</h5>
            </div>
        </div>
        <div class="card-body p-3">
            {% if pagos %}
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gris-oscuro uppercase tracking-wider">Fecha</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gris-oscuro uppercase tracking-wider">Monto</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gris-oscuro uppercase tracking-wider">Tipo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gris-oscuro uppercase tracking-wider">Concepto</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gris-oscuro uppercase tracking-wider">Comprobante</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gris-oscuro uppercase tracking-wider">Estado</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gris-oscuro uppercase tracking-wider">Observaciones</th>
                        </tr>
                    </thead>
                    <tbody class="bg-blanco divide-y divide-gray-200">
                        {% for pago in pagos %}
                        <tr class="hover:bg-gray-50 transition-colors duration-150">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="font-semibold text-gris-oscuro">{{ pago.fecha_pago|date:"d/m/Y" }}</div>
                                <small class="text-gris-medio">{{ pago.fecha_registro|date:"H:i" }}</small>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="font-semibold text-exito money">${{ pago.monto }}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-info text-white">{{ pago.get_tipo_pago_display }}</span>
                            </td>
                            <td class="px-6 py-4 text-gris-oscuro">{{ pago.concepto }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if pago.comprobante %}
                                    <span class="font-mono text-sm text-gris-oscuro">{{ pago.comprobante }}</span>
                                {% else %}
                                    <span class="text-gris-medio">-</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if pago.estado == 'confirmado' %}
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-exito text-white">Confirmado</span>
                                {% elif pago.estado == 'pendiente' %}
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-advertencia text-white">Pendiente</span>
                                {% else %}
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-error text-white">Rechazado</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-gris-oscuro">
                                {% if pago.observaciones %}
                                    <span class="text-sm">{{ pago.observaciones|truncatechars:50 }}</span>
                                {% else %}
                                    <span class="text-gris-medio">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-12">
                <div class="mb-4">
                    <svg class="mx-auto h-16 w-16 text-gris-medio" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                </div>
                <h4 class="text-xl font-medium text-gris-medio mb-2">Sin pagos registrados</h4>
                <p class="text-gris-medio mb-6">Este cliente aún no tiene pagos registrados.</p>
                <a href="{% url 'gravity:admin_pagos_registrar_pago' cliente.id %}" 
                   class="btn-primary inline-flex items-center gap-2 px-6 py-3 rounded-lg font-medium transition-all duration-200 hover:shadow-btn-primary-hover">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Registrar Primer Pago
                </a>
            </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        // Función para formatear números como moneda
        function formatMoney(num) {
            return new Intl.NumberFormat('es-AR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
        }

        // Aplicar formato a todos los elementos con clase 'money'
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.money').forEach(function(el) {
                let text = el.textContent.trim();
                // Extraer solo la parte numérica después del símbolo $
                let match = text.match(/\$?\s*(\d+(?:\.\d{2})?)/);
                
                if (match) {
                    let value = parseFloat(match[1]);
                    if (!isNaN(value)) {
                        el.textContent = '$ ' + formatMoney(value);
                    }
                }
            });
        });
    </script>
{% endblock %}