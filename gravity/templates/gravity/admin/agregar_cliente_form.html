{% extends 'gravity/admin/base_admin.html' %}

{% block title %}Agregar Usuario al Sistema - Panel de Administración{% endblock %}

{% block breadcrumb %}
    <li class="flex items-center">
        <span class="text-gray-400">/</span>
        <a href="{% url 'gravity:admin_usuarios_lista' %}" class="ml-1 text-principal hover:text-principal/80 transition-colors duration-200">
            Usuarios
        </a>
    </li>
    <li class="flex items-center">
        <span class="text-gray-400">/</span>
        <span class="ml-1 text-gray-500">Agregar Usuario</span>
    </li>
{% endblock %}

{% block content %}
    {% load static %}
    <!-- Header Section -->
    <div class="grid grid-cols-1 gap-4 mb-6">
        <div class="card">
            <div class="card-body p-3">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                    <div class="mb-4 md:mb-0">
                        <h2 class="text-2xl text-principal mb-2 flex items-center gap-2">
                            <svg class="size-8 mb-1" fill="currentColor" viewBox="0 0 640 640" xmlns="http://www.w3.org/2000/svg">
                                <path d="M136 192C136 125.7 189.7 72 256 72C322.3 72 376 125.7 376 192C376 258.3 322.3 312 256 312C189.7 312 136 258.3 136 192zM48 546.3C48 447.8 127.8 368 226.3 368L285.7 368C384.2 368 464 447.8 464 546.3C464 562.7 450.7 576 434.3 576L77.7 576C61.3 576 48 562.7 48 546.3zM544 160C557.3 160 568 170.7 568 184L568 232L616 232C629.3 232 640 242.7 640 256C640 269.3 629.3 280 616 280L568 280L568 328C568 341.3 557.3 352 544 352C530.7 352 520 341.3 520 328L520 280L472 280C458.7 280 448 269.3 448 256C448 242.7 458.7 232 472 232L520 232L520 184C520 170.7 530.7 160 544 160z"/>
                            </svg>
                            Agregar Usuario al Sistema
                        </h2>
                        <p class="text-gris-medio">
                            Crea un nuevo usuario en el sistema con contraseña temporal y réservalo directamente en una clase
                        </p>
                    </div>
                    <div class="flex items-center">
                        <a 
                            href="{% url 'gravity:admin_usuarios_lista' %}" 
                            class="flex items-center gap-1 border border-principal text-principal hover:bg-principal hover:text-fondo font-medium py-2 px-4 rounded-l transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"
                        >
                            <svg class="size-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                            </svg>
                            Ver Lista
                        </a>
                        <a 
                            href="{% url 'gravity:admin_clases_lista' %}" 
                            class="flex items-center gap-1 border border-secundario bg-secundario text-fondo hover:bg-blanco hover:text-secundario font-medium py-2 px-4 rounded-r transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:ring-opacity-50"
                        >
                            <svg class="size-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            Ver Clases
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Banner Información -->
    <div class="grid grid-cols-1 gap-4 mb-6">
        <div class="bg-info/10 border border-info/20 rounded-lg p-4">
            <div class="flex items-start gap-2">
                <svg class="size-10 text-info" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                </svg>
                <div>
                    <h6 class="font-semibold text-gris-oscuro mb-1">¿Cuándo usar esta función?</h6>
                    <p class="text-gris-medio">
                        <strong>Úsala para:</strong> Crear usuarios rápidamente desde el panel administrativo, reservas telefónicas, clases de prueba, o cuando un cliente quiere empezar de inmediato.<br> 
                        Se generará automáticamente un nombre de usuario. <br>
                        El email es opcional pero recomendado para futuras comunicaciones.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Grid Contenido Principal -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Formulario Principal - 2/3 del ancho en pantallas grandes -->
        <div class="lg:col-span-2">
            <div class="card">
                <div class="card-header">
                    <h5 class="flex items-center gap-2">
                        <svg class="size-6" fill="currentColor" viewBox="0 0 640 640" xmlns="http://www.w3.org/2000/svg">
                            <path d="M256.1 312C322.4 312 376.1 258.3 376.1 192C376.1 125.7 322.4 72 256.1 72C189.8 72 136.1 125.7 136.1 192C136.1 258.3 189.8 312 256.1 312zM226.4 368C127.9 368 48.1 447.8 48.1 546.3C48.1 562.7 61.4 576 77.8 576L274.3 576L285.2 521.5C289.5 499.8 300.2 479.9 315.8 464.3L383.1 397C355.1 378.7 321.7 368.1 285.7 368.1L226.3 368.1zM332.3 530.9L320.4 590.5C320.2 591.4 320.1 592.4 320.1 593.4C320.1 601.4 326.6 608 334.7 608C335.7 608 336.6 607.9 337.6 607.7L397.2 595.8C409.6 593.3 421 587.2 429.9 578.3L548.8 459.4L468.8 379.4L349.9 498.3C341 507.2 334.9 518.6 332.4 531zM600.1 407.9C622.2 385.8 622.2 350 600.1 327.9C578 305.8 542.2 305.8 520.1 327.9L491.3 356.7L571.3 436.7L600.1 407.9z"/>
                        </svg>
                        Datos del Usuario
                    </h5>
                </div>
                <div class="card-body p-3">
                    <form method="post" id="clienteForm">
                        {% csrf_token %}
                        
                        <!-- Información del Usuario -->
                        <div class="mb-6">
                            <div class="mb-4">
                                <h6 class="text-lg font-semibold text-principal flex items-center gap-1">
                                    <svg class="size-5 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    Información Personal
                                </h6>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="nombre" class="flex items-center gap-1 text-sm font-medium text-gris-oscuro mb-2">
                                        <svg class="size-4 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                        Nombre *
                                    </label>
                                    <input type="text" 
                                        name="nombre" 
                                        id="nombre" 
                                        class="w-full px-4 py-3 border border-gris-medio/30 rounded-lg focus:ring-2 focus:ring-principal/20 focus:border-principal transition-colors duration-200" 
                                        placeholder="Ej: María"
                                        value="{{ form_data.nombre|default:'' }}"
                                        required>
                                    <div class="mt-1">
                                        <small class="text-gris-medio">Nombre de pila del usuario</small>
                                    </div>
                                </div>
                                
                                <div>
                                    <label for="apellido" class="flex items-center gap-1 text-sm font-medium text-gris-oscuro mb-2">
                                        <svg class="size-4 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                        Apellido *
                                    </label>
                                    <input type="text" 
                                        name="apellido" 
                                        id="apellido" 
                                        class="w-full px-4 py-3 border border-gris-medio/30 rounded-lg focus:ring-2 focus:ring-principal/20 focus:border-principal transition-colors duration-200" 
                                        placeholder="Ej: González"
                                        value="{{ form_data.apellido|default:'' }}"
                                        required>
                                    <div class="mt-1">
                                        <small class="text-gris-medio">Apellido del usuario</small>
                                    </div>
                                </div>
                                
                                <div>
                                    <label for="telefono" class="flex items-center gap-1 text-sm font-medium text-gris-oscuro mb-2">
                                        <svg class="size-4 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                        </svg>
                                        Teléfono *
                                    </label>
                                    <input type="tel" 
                                        name="telefono" 
                                        id="telefono" 
                                        class="w-full px-4 py-3 border border-gris-medio/30 rounded-lg focus:ring-2 focus:ring-principal/20 focus:border-principal transition-colors duration-200" 
                                        placeholder="Ej: +54 11 1234-5678"
                                        value="{{ form_data.telefono|default:'' }}"
                                        required>
                                    <div class="mt-1">
                                        <small class="text-gris-medio">Número de contacto del usuario</small>
                                    </div>
                                </div>
                                
                                <div>
                                    <label for="email" class="flex items-center gap-1 text-sm font-medium text-gris-oscuro mb-2">
                                        <svg class="size-4 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                        </svg>
                                        Email (Opcional)
                                    </label>
                                    <input type="email" 
                                        name="email" 
                                        id="email" 
                                        class="w-full px-4 py-3 border border-gris-medio/30 rounded-lg focus:ring-2 focus:ring-principal/20 focus:border-principal transition-colors duration-200" 
                                        placeholder="Ej: maria@email.com"
                                        value="{{ form_data.email|default:'' }}">
                                    <div class="mt-1">
                                        <small class="text-gris-medio">Para enviar confirmaciones y recordatorios</small>
                                    </div>
                                </div>
                                
                                <div>
                                    <label for="password" class="flex items-center gap-1 text-sm font-medium text-gris-oscuro mb-2">
                                        <svg class="size-5 mb-0.5" fill="currentColor" viewBox="0 0 640 640" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M272 240C272 169.3 329.3 112 400 112C470.7 112 528 169.3 528 240C528 310.7 470.7 368 400 368C389.6 368 379.5 366.8 369.9 364.4C361.8 362.4 353.2 364.9 347.3 370.8L318.1 400L264 400C250.7 400 240 410.7 240 424L240 464L200 464C186.7 464 176 474.7 176 488L176 528L112 528L112 449.9L269.2 292.7C275.1 286.8 277.5 278.2 275.6 270.1C273.3 260.5 272 250.4 272 240zM400 64C302.8 64 224 142.8 224 240C224 249.5 224.7 258.8 226.2 267.9L71 423C66.5 427.5 64 433.6 64 440L64 552C64 565.3 74.7 576 88 576L200 576C213.3 576 224 565.3 224 552L224 512L264 512C277.3 512 288 501.3 288 488L288 448L328 448C334.4 448 340.5 445.5 345 441L372.2 413.8C381.3 415.2 390.6 416 400.1 416C497.3 416 576.1 337.2 576.1 240C576.1 142.8 497.2 64 400 64zM432 240C449.7 240 464 225.7 464 208C464 190.3 449.7 176 432 176C414.3 176 400 190.3 400 208C400 225.7 414.3 240 432 240z"/>
                                        </svg>
                                        Contraseña *
                                    </label>
                                    <input type="password" 
                                        name="password" 
                                        id="password" 
                                        class="w-full px-4 py-3 border border-gris-medio/30 rounded-lg focus:ring-2 focus:ring-principal/20 focus:border-principal transition-colors duration-200" 
                                        placeholder="Contraseña temporal"
                                        required>
                                    <div class="mt-1">
                                        <small class="text-gris-medio">Contraseña que el usuario usará para acceder</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Selección de Sede y Clase -->
                        <div class="mb-6">
                            <div class="mb-4">
                                <h6 class="text-lg font-semibold text-principal flex items-center gap-1.5">
                                    <svg class="size-5 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                    </svg>
                                    Selección de Sede y Clase
                                </h6>
                            </div>
                            
                            <!-- Selección de Sede -->
                            <div class="mb-4">
                                <label for="sede" class="flex items-center gap-1 text-sm font-medium text-gris-oscuro mb-2">
                                    <svg class="size-4 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    Sede *
                                </label>
                                <select name="sede" 
                                        id="sede" 
                                        class="w-full px-4 py-3 border border-gris-medio/30 rounded-lg focus:ring-2 focus:ring-principal/20 focus:border-principal transition-colors duration-200 bg-white" 
                                        required>
                                    <option value="">Selecciona una sede</option>
                                    <option value="sede_principal">Sede Principal - La Rioja 3044</option>
                                    <option value="sede_2">Sede 2 - 9 de julio 3698</option>
                                </select>
                                <div class="mt-1">
                                    <small class="text-gris-medio">Selecciona la sede donde se realizará la clase</small>
                                </div>
                            </div>
                            
                            <!-- Selección de Clase Dividida -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <!-- Tipo de Clase -->
                                <div>
                                    <label for="tipo_clase" class="flex items-center gap-1 text-sm font-medium text-gris-oscuro mb-2">
                                        <svg class="size-4 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                        </svg>
                                        Tipo de Clase *
                                    </label>
                                    <select name="tipo_clase" 
                                            id="tipo_clase" 
                                            class="w-full px-4 py-3 border border-gris-medio/30 rounded-lg focus:ring-2 focus:ring-principal/20 focus:border-principal transition-colors duration-200 bg-white" 
                                            required 
                                            disabled>
                                        <option value="">Selecciona sede primero</option>
                                    </select>
                                    <div class="mt-1">
                                        <small class="text-gris-medio">Tipo de clase de pilates</small>
                                    </div>
                                </div>
                                
                                <!-- Día -->
                                <div>
                                    <label for="dia_clase" class="flex items-center gap-1 text-sm font-medium text-gris-oscuro mb-2">
                                        <svg class="size-4 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                        Día *
                                    </label>
                                    <select name="dia_clase" 
                                            id="dia_clase" 
                                            class="w-full px-4 py-3 border border-gris-medio/30 rounded-lg focus:ring-2 focus:ring-principal/20 focus:border-principal transition-colors duration-200 bg-white" 
                                            required 
                                            disabled>
                                        <option value="">Selecciona tipo primero</option>
                                    </select>
                                    <div class="mt-1">
                                        <small class="text-gris-medio">Día de la semana</small>
                                    </div>
                                </div>
                                
                                <!-- Horario -->
                                <div>
                                    <label for="horario_clase" class="flex items-center gap-1 text-sm font-medium text-gris-oscuro mb-2">
                                        <svg class="size-4 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        Horario *
                                    </label>
                                    <select name="horario_clase" 
                                            id="horario_clase" 
                                            class="w-full px-4 py-3 border border-gris-medio/30 rounded-lg focus:ring-2 focus:ring-principal/20 focus:border-principal transition-colors duration-200 bg-white" 
                                            required 
                                            disabled>
                                        <option value="">Selecciona día primero</option>
                                    </select>
                                    <div class="mt-1">
                                        <small class="text-gris-medio">Hora de inicio</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Campo oculto para el ID de la clase final -->
                            <input type="hidden" name="clase_id" id="clase_id_final" value="">
                        </div>

                        <!-- Vista Previa de la Clase -->
                        <div class="mb-6">
                            <div class="card bg-gris-claro border-0" id="clasePreview" style="display: none;">
                                <div class="card-header bg-exito text-white">
                                    <h6 class="flex items-center gap-1 font-semibold">
                                        <svg class="size-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                        Vista Previa de la Reserva
                                    </h6>
                                </div>
                                <div class="card-body p-3">
                                    <div id="previewContent" class="text-center">
                                        <!-- La Vista previa de la clase seleccionada se mostrará aquí -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Notas Adicionales -->
                        <div class="mb-6">
                            <div class="mb-4">
                                <h6 class="text-lg font-semibold text-principal flex items-center gap-1">
                                    <svg class="size-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v6a2 2 0 01-2 2h-2l-4 4z"></path>
                                    </svg>
                                    Información Adicional (Opcional)
                                </h6>
                            </div>
                            
                            <div>
                                <label for="notas" class="flex items-center gap-1 text-sm font-medium text-gris-oscuro mb-2">
                                    <svg class="size-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                    </svg>
                                    Notas
                                </label>
                                <textarea name="notas" 
                                        id="notas" 
                                        class="w-full px-4 py-3 border border-gris-medio/30 rounded-lg focus:ring-2 focus:ring-principal/20 focus:border-principal transition-colors duration-200 resize-none" 
                                        rows="3" 
                                        placeholder="Notas adicionales sobre este usuario (ej: derivado por..., primera vez, necesidades especiales, etc.)">{{ form_data.notas|default:'' }}</textarea>
                                <div class="ml-1">
                                    <small class="text-gris-medio">Información que puede ser útil para las clases</small>
                                </div>
                            </div>
                        </div>

                        <!-- Opciones -->
                        <div class="mb-6">
                            <div class="mb-4">
                                <h6 class="text-lg font-semibold text-principal flex items-center gap-1">
                                    <svg class="size-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    Opciones
                                </h6>
                            </div>
                            
                            <div class="space-y-3">
                                <div class="flex items-start">
                                    <input type="checkbox" 
                                        name="enviar_confirmacion" 
                                        id="enviar_confirmacion" 
                                        class="mt-1 h-4 w-4 text-principal border-gris-medio rounded focus:ring-principal/20"
                                        checked>
                                    <label class="ml-3 text-sm text-gris-oscuro flex items-center" for="enviar_confirmacion">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                        </svg>
                                        Enviar confirmación por email (si se proporcionó email)
                                    </label>
                                </div>
                                
                                <div class="flex items-start">
                                    <input type="checkbox" 
                                        name="crear_como_recurrente" 
                                        id="crear_como_recurrente" 
                                        class="mt-1 h-4 w-4 text-principal border-gris-medio rounded focus:ring-principal/20"
                                        checked>
                                    <label class="ml-3 text-sm text-gris-oscuro flex items-center" for="crear_como_recurrente">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        Crear como reserva recurrente (cada semana en el mismo horario)
                                    </label>
                                </div>
                                
                                <div class="flex items-start">
                                    <input type="checkbox" 
                                        name="sugerir_registro" 
                                        id="sugerir_registro"
                                        class="mt-1 h-4 w-4 text-principal border-gris-medio rounded focus:ring-principal/20">
                                    <label class="ml-3 text-sm text-gris-oscuro flex items-center" for="sugerir_registro">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                                        </svg>
                                        Incluir datos de acceso en email de confirmación
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Warning Section -->
                        <div class="mb-6">
                            <div class="bg-advertencia/10 border border-advertencia/70 rounded-lg p-4">
                                <div class="flex items-start">
                                    <svg class="w-5 h-5 text-advertencia mr-3 mt-1 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                    <div>
                                        <strong class="text-gris-oscuro">Importante:</strong>
                                        <ul class="mt-2 text-sm text-gris-medio space-y-1">
                                            <li>• Se creará un usuario real con username autogenerado y contraseña temporal</li>
                                            <li>• El usuario podrá iniciar sesión si conoce sus credenciales</li>
                                            <li>• Se recomienda informar al usuario sus datos de acceso</li>
                                            <li>• El usuario aparecerá en la lista de usuarios del sistema</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="flex items-center justify-center gap-3">
                            <a href="{% url 'gravity:admin_usuarios_lista' %}" 
                            class="flex items-center gap-1 border border-gray-400 text-gray-700 hover:bg-gray-300 font-medium py-2 px-4 rounded transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50">
                                <svg class="size-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                Cancelar
                            </a>
                            
                            <button type="submit" 
                                    class="flex items-center gap-1 bg-principal text-fondo hover:bg-fondo hover:text-principal font-medium py-2 px-4 rounded transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50" 
                                    id="submitBtn">
                                <svg class="size-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                                </svg>
                                <span id="submitText">Agregar Usuario y Reservar</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Barra lateral de información - 1/3 del ancho en pantallas grandes -->
        <div class="space-y-6">
            <!-- Tips Rápidos -->
            <div class="card">
                <div class="card-header text-blanco">
                    <h6 class="flex items-center gap-2">
                        <svg class="size-5 mb-0.5" fill="currentColor" viewBox="0 0 640 640" xmlns="http://www.w3.org/2000/svg">
                            <path d="M420.9 448C428.2 425.7 442.8 405.5 459.3 388.1C492 353.7 512 307.2 512 256C512 150 426 64 320 64C214 64 128 150 128 256C128 307.2 148 353.7 180.7 388.1C197.2 405.5 211.9 425.7 219.1 448L420.8 448zM416 496L224 496L224 512C224 556.2 259.8 592 304 592L336 592C380.2 592 416 556.2 416 512L416 496zM312 176C272.2 176 240 208.2 240 248C240 261.3 229.3 272 216 272C202.7 272 192 261.3 192 248C192 181.7 245.7 128 312 128C325.3 128 336 138.7 336 152C336 165.3 325.3 176 312 176z"/>
                        </svg>
                        Consejos Rápidos
                    </h6>
                </div>
                <div class="card-body p-3">
                    <div class="space-y-4">
                        
                        <div class="flex flex-col items-start">
                            <div class="flex items-center gap-1">
                                <svg class="size-5 text-principal" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                <strong class="text-gris-oscuro">Seleccionar sede primero:</strong>
                            </div>
                            <small class="block text-gris-medio">Esto filtrará las clases disponibles por ubicación</small>
                        </div>
                        
                        <div class="flex flex-col items-start">
                            <div class="flex items-center gap-1">
                                <svg class="size-5 text-principal" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                </svg>
                                <strong class="text-gris-oscuro">Email opcional:</strong>
                            </div>
                            <small class="block text-gris-medio">Pero muy recomendado para confirmaciones</small>
                        </div>
                        
                        <div class="flex flex-col items-start">
                            <div class="flex items-center gap-1">
                                <svg class="size-5 text-advertencia" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                <strong class="text-gris-oscuro">Reservas recurrentes:</strong>
                            </div>
                            <small class="block text-gris-medio">El usuario asistirá cada semana hasta cancelar</small>
                        </div>
                        
                        <div class="flex flex-col items-start">
                            <div class="flex items-center gap-1">
                                <svg class="size-5 text-info" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 3a3 3 0 00-3 3v3a3 3 0 003 3h3a3 3 0 003-3V6a3 3 0 00-3-3h-3z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 15a3 3 0 00-3 3v3a3 3 0 003 3h3a3 3 0 003-3v-3a3 3 0 00-3-3H9z"></path>
                                </svg>
                                <strong class="text-gris-oscuro">Gestión posterior:</strong>
                            </div>
                            <small class="block text-gris-medio">Podrás modificar o cancelar desde la lista de usuarios</small>
                        </div>
                        
                    </div>
                </div>
            </div>

            <!-- Información de Sedes -->
            <div class="card">
                <div class="card-header text-blanco">
                    <h6 class="flex items-center gap-2">
                        <svg class="size-5 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        Nuestras Sedes
                    </h6>
                </div>
                <div class="card-body p-3">
                    <div class="space-y-4">
                        <div class="border-l-4 border-principal pl-3">
                            <h4 class="font-semibold text-gris-oscuro">Sede Principal</h4>
                            <p class="text-sm text-gris-medio">La Rioja 3044</p>
                            <p class="text-sm text-gris-medio">Tel: +54 342 511 4448</p>
                        </div>
                        
                        <div class="border-l-4 border-secundario pl-3">
                            <h4 class="font-semibold text-gris-oscuro">Sede 2</h4>
                            <p class="text-sm text-gris-medio">9 de julio 3698</p>
                            <p class="text-sm text-gris-medio">Tel: +54 342 511 4448</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estado de las Clases -->
            <div class="card">
                <div class="card-header text-blanco">
                    <h6 class="flex items-center gap-2">
                        <svg class="size-5 mb-0.5" fill="currentColor" viewBox="0 0 576 512" xmlns="http://www.w3.org/2000/svg">
                            <path d="M512.4 240l-176 0c-17.7 0-32-14.3-32-32l0-176c0-17.7 14.4-32.2 31.9-29.9 107 14.2 191.8 99 206 206 2.3 17.5-12.2 31.9-29.9 31.9zM222.6 37.2c18.1-3.8 33.8 11 33.8 29.5l0 197.3c0 5.6 2 11 5.5 15.3L394 438.7c11.7 14.1 9.2 35.4-6.9 44.1-34.1 18.6-73.2 29.2-114.7 29.2-132.5 0-240-107.5-240-240 0-115.5 81.5-211.9 190.2-234.8zM477.8 288l64 0c18.5 0 33.3 15.7 29.5 33.8-10.2 48.4-35 91.4-69.6 124.2-12.3 11.7-31.6 9.2-42.4-3.9L374.9 340.4c-17.3-20.9-2.4-52.4 24.6-52.4l78.2 0z"/>
                        </svg>
                        Estado de las Clases
                    </h6>
                </div>
                <div class="card-body p-3">
                    <div class="space-y-3">
                        <div class="text-center">
                            <p class="text-sm text-gris-medio mb-2">Selecciona una sede para ver las clases disponibles</p>
                            <div id="clasesDisponiblesCount" class="text-2xl font-bold text-principal">-</div>
                            <small class="text-gris-medio">clases disponibles</small>
                        </div>
                        
                        <hr class="border-principal/20">
                        
                        <div class="text-center">
                            <a href="{% url 'gravity:admin_clase_crear' %}" 
                            class="flex items-center justify-center gap-1 border border-principal text-principal hover:bg-principal hover:text-fondo text-sm py-2 px-3 rounded transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50"
                            >
                                <svg class="size-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Crear Nueva Clase
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // Referencias a elementos del DOM
            const form = document.getElementById('clienteForm');
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const sedeSelect = document.getElementById('sede');
            const tipoClaseSelect = document.getElementById('tipo_clase');
            const diaClaseSelect = document.getElementById('dia_clase');
            const horarioClaseSelect = document.getElementById('horario_clase');
            const claseIdFinal = document.getElementById('clase_id_final');
            const previewCard = document.getElementById('clasePreview');
            const previewContent = document.getElementById('previewContent');
            const emailInput = document.getElementById('email');
            const enviarConfirmacion = document.getElementById('enviar_confirmacion');
            const clasesCount = document.getElementById('clasesDisponiblesCount');
            
            // Variables de estado
            let todasLasClases = [];
            let claseSeleccionada = null;
            
            // Verificar que todos los elementos existen
            const elementos = {
                form, sedeSelect, tipoClaseSelect, diaClaseSelect, 
                horarioClaseSelect, clasesCount, emailInput, enviarConfirmacion
            };
            
            // Verificar CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            
            
            // Carga todas las clases disponibles desde la API
            function loadAllClasses() {
                
                fetch('/api/clases-disponibles/', {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrfToken.value
                    }
                })
                .then(response => {
                    console.log('Response status:', response.status);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {

                    todasLasClases = data;
                    
                    // Actualizar contador total
                    const clasesDisponibles = data.filter(clase => clase.cupos_disponibles > 0);
                    clasesCount.textContent = clasesDisponibles.length;
                })
                .catch(error => {
                    clasesCount.textContent = '0';
                });
            }
            
            
            // Carga los tipos disponibles para la sede seleccionada
            function loadTiposPorSede() {
                const sedeSeleccionada = sedeSelect.value;
                
                // Resetear select
                tipoClaseSelect.innerHTML = '<option value="">Cargando tipos...</option>';
                tipoClaseSelect.disabled = true;
                
                if (!sedeSeleccionada) {
                    tipoClaseSelect.innerHTML = '<option value="">Primero selecciona una sede</option>';
                    clasesCount.textContent = '-';
                    return;
                }
                
                if (!todasLasClases || !Array.isArray(todasLasClases)) {
                    tipoClaseSelect.innerHTML = '<option value="">Error: No se han cargado las clases</option>';
                    return;
                }
                
                try {
                    // Filtrar clases por sede y con cupos disponibles
                    const clasesPorSede = todasLasClases.filter(clase => 
                        clase.direccion === sedeSeleccionada && clase.cupos_disponibles > 0
                    );
                    
                    if (clasesPorSede.length > 0) {
                        // Obtener tipos únicos
                        const tiposUnicos = [...new Set(clasesPorSede.map(clase => clase.tipo))];
                        
                        // Llenar select de tipos
                        tipoClaseSelect.innerHTML = '<option value="">Selecciona un tipo</option>';
                        
                        tiposUnicos.forEach(tipo => {
                            const option = document.createElement('option');
                            option.value = tipo;
                            
                            const claseEjemplo = clasesPorSede.find(clase => clase.tipo === tipo);
                            const displayName = claseEjemplo.tipo_display || tipo;
                            
                            option.textContent = displayName;
                            tipoClaseSelect.appendChild(option);
                        });
                        
                        tipoClaseSelect.disabled = false;
                        clasesCount.textContent = clasesPorSede.length;
                        
                    } else {
                        tipoClaseSelect.innerHTML = '<option value="">No hay clases disponibles en esta sede</option>';
                        clasesCount.textContent = '0';
                    }
                    
                } catch (error) {
                    tipoClaseSelect.innerHTML = '<option value="">Error al cargar tipos</option>';
                    clasesCount.textContent = 'Error';
                }
            }
            
            
            // Carga los días disponibles usando la API existente
            function loadDiasPorTipo() {
                const sedeSeleccionada = sedeSelect.value;
                const tipoSeleccionado = tipoClaseSelect.value;
                
                diaClaseSelect.innerHTML = '<option value="">Cargando días...</option>';
                diaClaseSelect.disabled = true;
                
                if (!tipoSeleccionado) {
                    diaClaseSelect.innerHTML = '<option value="">Selecciona tipo primero</option>';
                    return;
                }
                
                fetch('/api/dias-disponibles/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrfToken.value
                    },
                    body: JSON.stringify({
                        tipo: tipoSeleccionado,
                        sede: sedeSeleccionada
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    
                    if (data.dias && data.dias.length > 0) {
                        diaClaseSelect.innerHTML = '<option value="">Selecciona un día</option>';
                        data.dias.forEach(dia => {
                            const option = document.createElement('option');
                            option.value = dia;
                            option.textContent = dia;
                            diaClaseSelect.appendChild(option);
                        });
                        diaClaseSelect.disabled = false;
                    } else {
                        diaClaseSelect.innerHTML = '<option value="">No hay días disponibles</option>';
                    }
                })
                .catch(error => {
                    diaClaseSelect.innerHTML = '<option value="">Error al cargar días</option>';
                });
            }
            
            
            // Carga los horarios disponibles usando la API existente
            function loadHorariosPorDia() {
                const sedeSeleccionada = sedeSelect.value;
                const tipoSeleccionado = tipoClaseSelect.value;
                const diaSeleccionado = diaClaseSelect.value;
                
                horarioClaseSelect.innerHTML = '<option value="">Cargando horarios...</option>';
                horarioClaseSelect.disabled = true;
                
                if (!diaSeleccionado) {
                    horarioClaseSelect.innerHTML = '<option value="">Selecciona día primero</option>';
                    return;
                }
                
                fetch('/api/horarios-disponibles/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrfToken.value
                    },
                    body: JSON.stringify({
                        tipo: tipoSeleccionado,
                        sede: sedeSeleccionada,
                        dia: diaSeleccionado
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    
                    if (data.horarios && data.horarios.length > 0) {
                        horarioClaseSelect.innerHTML = '<option value="">Selecciona un horario</option>';
                        data.horarios.forEach(horario => {
                            if (horario.disponible && horario.cupos > 0) {
                                const option = document.createElement('option');
                                option.value = horario.value;
                                option.textContent = `${horario.value} (${horario.cupos} cupos disponibles)`;
                                horarioClaseSelect.appendChild(option);
                            }
                        });
                        horarioClaseSelect.disabled = false;
                    } else {
                        horarioClaseSelect.innerHTML = '<option value="">No hay horarios disponibles</option>';
                    }
                })
                .catch(error => {
                    horarioClaseSelect.innerHTML = '<option value="">Error al cargar horarios</option>';
                });
            }
            
            
            // Selecciona la clase final y actualiza la vista previa
            function selectClaseFinal() {
                const sedeSeleccionada = sedeSelect.value;
                const tipoSeleccionado = tipoClaseSelect.value;
                const diaSeleccionado = diaClaseSelect.value;
                const horarioSeleccionado = horarioClaseSelect.value;
                
                if (horarioSeleccionado) {
                    claseSeleccionada = todasLasClases.find(clase => 
                        clase.direccion === sedeSeleccionada &&
                        clase.tipo === tipoSeleccionado &&
                        clase.dia === diaSeleccionado &&
                        clase.horario === horarioSeleccionado
                    );
                    
                    if (claseSeleccionada) {
                        claseIdFinal.value = claseSeleccionada.id;
                        updateClassPreview();
                    }
                } else {
                    claseIdFinal.value = '';
                    claseSeleccionada = null;
                    hideClassPreview();
                }
            }
            
            
            // Resetea la cascada desde un punto específico
            function resetCascada(desde) {
                switch(desde) {
                    case 'sede':
                        tipoClaseSelect.innerHTML = '<option value="">Primero selecciona una sede</option>';
                        tipoClaseSelect.disabled = true;
                    case 'tipo':
                        diaClaseSelect.innerHTML = '<option value="">Selecciona tipo primero</option>';
                        diaClaseSelect.disabled = true;
                    case 'dia':
                        horarioClaseSelect.innerHTML = '<option value="">Selecciona día primero</option>';
                        horarioClaseSelect.disabled = true;
                        break;
                }
                
                claseIdFinal.value = '';
                claseSeleccionada = null;
                hideClassPreview();
            }
            
            
            // Actualiza la vista previa de la clase
            function updateClassPreview() {
                if (!claseSeleccionada) {
                    hideClassPreview();
                    return;
                }
                
                const cupos = claseSeleccionada.cupos_disponibles;
                
                let imageName;
                switch(claseSeleccionada.tipo) {
                    case 'Reformer':
                        imageName = 'reformer.png';
                        break;
                    case 'Cadillac':
                        imageName = 'cadillac.png';
                        break;
                    default:
                        imageName = 'especial.png';
                }
                
                previewContent.innerHTML = `
                    <div class="flex flex-col md:flex-row gap-4 items-center justify-evenly">
                        <div class="text-center">
                            <img src="/static/icons/${imageName}" alt="${claseSeleccionada.tipo}" class="w-16 h-16 mx-auto mb-2 object-contain">
                            <h6 class="font-semibold mt-2 text-principal">${claseSeleccionada.tipo_display}</h6>
                        </div>
                        <div>
                            <h6 class="text-principal text-left font-semibold mb-3">Detalles de la Reserva:</h6>
                            <div class="text-left space-y-2">
                                <div class="flex items-center gap-1">
                                    <svg class="size-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    <strong>Sede:</strong> ${claseSeleccionada.direccion_display}
                                </div>
                                <div class="flex items-center gap-1">
                                    <svg class="size-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                    </svg>
                                    <strong>Tipo:</strong> ${claseSeleccionada.tipo_display}
                                </div>
                                <div class="flex items-center gap-1">
                                    <svg class="size-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <strong>Día:</strong> ${claseSeleccionada.dia}
                                </div>
                                <div class="flex items-center gap-1">
                                    <svg class="size-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <strong>Horario:</strong> ${claseSeleccionada.horario}
                                </div>
                                <div class="flex items-center gap-1">
                                    <svg class="size-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                    <strong>Cupos disponibles:</strong> ${cupos}
                                </div>
                                <div class="flex items-center gap-1">
                                    <svg class="size-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    <strong>Recurrencia:</strong> Cada ${claseSeleccionada.dia} a las ${claseSeleccionada.horario}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                previewCard.style.display = 'block';
                updateEmailOptions();
            }
            
            
            // Oculta la vista previa de la clase
            function hideClassPreview() {
                previewCard.style.display = 'none';
            }
            
            
            // Actualiza las opciones relacionadas con email
            function updateEmailOptions() {
                const hasEmail = emailInput.value.trim() !== '';
                enviarConfirmacion.disabled = !hasEmail;
                
                const label = document.querySelector('label[for="enviar_confirmacion"]');
                if (hasEmail) {
                    label.classList.remove('text-gris-medio');
                    label.classList.add('text-gris-oscuro');
                    enviarConfirmacion.checked = true;
                } else {
                    label.classList.add('text-gris-medio');
                    label.classList.remove('text-gris-oscuro');
                    enviarConfirmacion.checked = false;
                }
            }
            
            
            // Valida el formato de email
            function isValidEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }
            
            // Event listeners
            sedeSelect.addEventListener('change', function() {
                console.log('=== Cambio en sede detectado ===');
                
                // PRIMERO resetear solo los selects posteriores
                diaClaseSelect.innerHTML = '<option value="">Selecciona tipo primero</option>';
                diaClaseSelect.disabled = true;
                horarioClaseSelect.innerHTML = '<option value="">Selecciona día primero</option>';
                horarioClaseSelect.disabled = true;
                claseIdFinal.value = '';
                claseSeleccionada = null;
                hideClassPreview();
                
                // LUEGO cargar los tipos (esto llenará el select)
                loadTiposPorSede();
            });
            
            tipoClaseSelect.addEventListener('change', function() {
                loadDiasPorTipo();
                resetCascada('tipo');
            });
            
            diaClaseSelect.addEventListener('change', function() {
                loadHorariosPorDia();
                resetCascada('dia');
            });
            
            horarioClaseSelect.addEventListener('change', function() {
                selectClaseFinal();
            });
            
            emailInput.addEventListener('input', updateEmailOptions);
            
            // Envío del formulario
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const requiredFields = ['nombre', 'apellido', 'password', 'telefono', 'sede', 'tipo_clase', 'dia_clase', 'horario_clase'];
                let isValid = true;
                
                requiredFields.forEach(function(fieldId) {
                    const field = document.getElementById(fieldId);
                    if (!field.value.trim()) {
                        field.classList.add('border-error');
                        field.classList.remove('border-gris-medio/30');
                        isValid = false;
                    } else {
                        field.classList.remove('border-error');
                        field.classList.add('border-gris-medio/30');
                    }
                });
                
                if (!claseIdFinal.value) {
                    alert('Por favor, completa la selección de la clase (sede → tipo → día → horario).');
                    isValid = false;
                }
                
                const email = emailInput.value.trim();
                if (email && !isValidEmail(email)) {
                    emailInput.classList.add('border-error');
                    emailInput.classList.remove('border-gris-medio/30');
                    isValid = false;
                } else {
                    emailInput.classList.remove('border-error');
                    emailInput.classList.add('border-gris-medio/30');
                }
                
                // Validar contraseña
                const passwordInput = document.getElementById('password');
                const password = passwordInput.value;
                if (password.length < 6) {
                    passwordInput.classList.add('border-error');
                    passwordInput.classList.remove('border-gris-medio/30');
                    alert('La contraseña debe tener al menos 6 caracteres.');
                    isValid = false;
                } else {
                    passwordInput.classList.remove('border-error');
                    passwordInput.classList.add('border-gris-medio/30');
                }
                
                if (!isValid) {
                    alert('Por favor, completa todos los campos obligatorios correctamente.');
                    return;
                }
                
                submitText.textContent = 'Procesando...';
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>' + submitText.textContent;
                
                setTimeout(function() {
                    form.submit();
                }, 1000);
            });
            
            // Inicialización
            loadAllClasses();
            updateEmailOptions();
            
            // Auto-focus el primer campo
            const nombreField = document.getElementById('nombre');
            if (nombreField) {
                nombreField.focus();
            }
        });
    </script>
{% endblock %}