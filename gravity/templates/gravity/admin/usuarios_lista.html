{% extends 'gravity/admin/base_admin.html' %}

{% block title %}Gestión de Usuarios - Panel de Administración{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item active">Usuarios</li>
{% endblock %}

{% block content %}
    <!-- Header Section -->
    <div class="grid grid-cols-1 gap-4 mb-6">
        <div class="card">
            <div class="card-body p-3">
                <div class="flex flex-col md:flex-row md:items-center gap-4">
                    <div class="flex-1">
                        <h2 class="text-2xl text-principal mb-2 flex items-center gap-2">
                            <svg class="size-8 mb-1" fill="currentColor" viewBox="0 0 640 640" xmlns="http://www.w3.org/2000/svg">
                                <path d="M320 80C377.4 80 424 126.6 424 184C424 241.4 377.4 288 320 288C262.6 288 216 241.4 216 184C216 126.6 262.6 80 320 80zM96 152C135.8 152 168 184.2 168 224C168 263.8 135.8 296 96 296C56.2 296 24 263.8 24 224C24 184.2 56.2 152 96 152zM0 480C0 409.3 57.3 352 128 352C140.8 352 153.2 353.9 164.9 357.4C132 394.2 112 442.8 112 496L112 512C112 523.4 114.4 534.2 118.7 544L32 544C14.3 544 0 529.7 0 512L0 480zM521.3 544C525.6 534.2 528 523.4 528 512L528 496C528 442.8 508 394.2 475.1 357.4C486.8 353.9 499.2 352 512 352C582.7 352 640 409.3 640 480L640 512C640 529.7 625.7 544 608 544L521.3 544zM472 224C472 184.2 504.2 152 544 152C583.8 152 616 184.2 616 224C616 263.8 583.8 296 544 296C504.2 296 472 263.8 472 224zM160 496C160 407.6 231.6 336 320 336C408.4 336 480 407.6 480 496L480 512C480 529.7 465.7 544 448 544L192 544C174.3 544 160 529.7 160 512L160 496z"/>
                            </svg>
                            Gestión de Usuarios
                        </h2>
                        <p class="text-gris-medio mb-0">Administra todos los usuarios registrados en el sistema</p>
                    </div>
                    <div class="flex items-center">
                        <button 
                            type="button" 
                            class="flex items-center gap-1 border border-green-500 text-green-600 hover:bg-green-500 hover:text-white font-medium py-2 px-4 rounded-l transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50" 
                            onclick="exportUsuarios()"
                        >
                            <svg class="size-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                            Exportar
                        </button>
                        <a 
                            href="{% url 'gravity:admin_agregar_cliente_no_registrado' %}" 
                            class="flex items-center gap-1 border border-principal bg-principal text-fondo hover:bg-principal/70 font-medium py-2 px-4 rounded-r transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"
                        >
                            <svg class="size-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                            </svg>
                            Agregar Cliente
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters Section -->
    <div class="grid grid-cols-1 gap-4 mb-6">
        <div class="card">
            <div class="card-header">
                <h5 class="flex items-center gap-2 text-xl font-semibold">
                    <svg class="size-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                    </svg>
                    Búsqueda y Filtros
                </h5>
            </div>
            <div class="card-body p-3">
                <form method="get" id="searchForm">
                    <div class="flex flex-col md:flex-row gap-3">
                        <div class="w-full">
                            <label for="busqueda" class="block text-sm font-medium text-gris-oscuro mb-2">Buscar Usuario</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg class="w-5 h-5 text-gris-medio" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <input type="text" 
                                    name="busqueda" 
                                    id="busqueda" 
                                    class="w-full pl-10 pr-4 py-3 border border-gris-medio/30 rounded-lg focus:ring-2 focus:ring-principal/20 focus:border-principal transition-colors duration-200" 
                                    placeholder="Nombre, apellido, email o username..."
                                    value="{{ busqueda }}">
                                <button type="submit" class="absolute inset-y-0 right-0 px-4 bg-principal text-blanco rounded-r-lg hover:bg-principal/90 transition-colors duration-200">
                                    Buscar
                                </button>
                            </div>
                            <p class="flex items-center gap-1 mt-2 text-sm text-gris-medio">
                                <svg class="size-4 mb-0.5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                </svg>
                                Busca por nombre, apellido, email o nombre de usuario
                            </p>
                        </div>
                        
                        <div class="w-full">
                            <label class="block text-sm font-medium text-gris-oscuro mb-2">Filtros Rápidos</label>
                            <div class="flex flex-wrap gap-2">
                                <button 
                                    type="button" 
                                    class="flex items-center gap-1 border border-blue-500 text-blue-600 hover:bg-blue-500 hover:text-blanco font-medium text-sm py-3.5 px-2 rounded transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50" 
                                    onclick="filterBy('con_reservas')"
                                >
                                    <svg class="size-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"/>
                                    </svg>
                                    Con Reservas
                                </button>
                                <button 
                                    type="button" 
                                    class="flex items-center gap-1 border border-cyan-500 text-cyan-600 hover:bg-cyan-500 hover:text-blanco font-medium text-sm py-3.5 px-2 rounded transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:ring-opacity-50" 
                                    onclick="filterBy('nuevos')"
                                >
                                    <svg class="size-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                    </svg>
                                    Nuevos (7 días)
                                </button>
                                <button 
                                    type="button" 
                                    class="flex items-center gap-1 border border-green-500 text-green-600 hover:bg-green-500 hover:text-blanco font-medium text-sm py-3.5 px-2 rounded transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50" 
                                    onclick="filterBy('activos')"
                                >
                                    <svg class="size-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                    Activos
                                </button>
                                <button 
                                    type="button" 
                                    class="flex items-center gap-1 border border-yellow-500 text-yellow-600 hover:bg-yellow-500 hover:text-blanco font-medium text-sm py-3.5 px-2 rounded transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-opacity-50" 
                                    onclick="filterBy('sin_perfil')"
                                >
                                    <svg class="size-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"/>
                                    </svg>
                                    Sin Perfil
                                </button>
                                <a 
                                    href="{% url 'gravity:admin_usuarios_lista' %}" 
                                    class="flex items-center gap-1 border border-gray-400 text-gray-700 hover:bg-gray-50 font-medium text-sm py-3.5 px-2 rounded transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50"
                                >
                                    <svg class="size-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                    </svg>
                                    Limpiar
                                </a>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Results Summary -->
    {% if page_obj.object_list %}
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
        <div>
            <h6 class="text-lg font-semibold text-gris-oscuro flex items-center gap-2">
                <svg class="size-5" fill="currentColor" viewBox="0 0 640 640" xmlns="http://www.w3.org/2000/svg">
                    <path d="M104 112C90.7 112 80 122.7 80 136L80 184C80 197.3 90.7 208 104 208L152 208C165.3 208 176 197.3 176 184L176 136C176 122.7 165.3 112 152 112L104 112zM256 128C238.3 128 224 142.3 224 160C224 177.7 238.3 192 256 192L544 192C561.7 192 576 177.7 576 160C576 142.3 561.7 128 544 128L256 128zM256 288C238.3 288 224 302.3 224 320C224 337.7 238.3 352 256 352L544 352C561.7 352 576 337.7 576 320C576 302.3 561.7 288 544 288L256 288zM256 448C238.3 448 224 462.3 224 480C224 497.7 238.3 512 256 512L544 512C561.7 512 576 497.7 576 480C576 462.3 561.7 448 544 448L256 448zM80 296L80 344C80 357.3 90.7 368 104 368L152 368C165.3 368 176 357.3 176 344L176 296C176 282.7 165.3 272 152 272L104 272C90.7 272 80 282.7 80 296zM104 432C90.7 432 80 442.7 80 456L80 504C80 517.3 90.7 528 104 528L152 528C165.3 528 176 517.3 176 504L176 456C176 442.7 165.3 432 152 432L104 432z"/>
                </svg>
                Resultados: {{ page_obj.paginator.count }} usuario{{ page_obj.paginator.count|pluralize }}
                {% if busqueda %}
                    <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-secundario text-blanco">Búsqueda activa</span>
                {% endif %}
            </h6>
            <p class="text-sm text-gris-medio">
                Mostrando {{ page_obj.start_index }}-{{ page_obj.end_index }} de {{ page_obj.paginator.count }}
            </p>
        </div>
        
        <!-- Display Options -->
        <div class="flex rounded-md shadow-sm" role="group">
            <button type="button" class="px-4 py-2 text-sm font-medium text-gris-oscuro bg-blanco border border-gris-medio/30 rounded-l-md hover:bg-gris-claro hover:text-principal focus:z-10 focus:ring-2 focus:ring-principal/20 focus:border-principal transition-colors duration-200 active" onclick="toggleView('cards')">
                <svg class="size-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                </svg>
            </button>
            <button type="button" class="px-4 py-2 text-sm font-medium text-gris-oscuro bg-blanco border border-gris-medio/30 rounded-r-md hover:bg-gris-claro hover:text-principal focus:z-10 focus:ring-2 focus:ring-principal/20 focus:border-principal transition-colors duration-200" onclick="toggleView('table')">
                <svg class="size-4" fill="currentColor" viewBox="0 0 640 640" xmlns="http://www.w3.org/2000/svg">
                    <path d="M104 112C90.7 112 80 122.7 80 136L80 184C80 197.3 90.7 208 104 208L152 208C165.3 208 176 197.3 176 184L176 136C176 122.7 165.3 112 152 112L104 112zM256 128C238.3 128 224 142.3 224 160C224 177.7 238.3 192 256 192L544 192C561.7 192 576 177.7 576 160C576 142.3 561.7 128 544 128L256 128zM256 288C238.3 288 224 302.3 224 320C224 337.7 238.3 352 256 352L544 352C561.7 352 576 337.7 576 320C576 302.3 561.7 288 544 288L256 288zM256 448C238.3 448 224 462.3 224 480C224 497.7 238.3 512 256 512L544 512C561.7 512 576 497.7 576 480C576 462.3 561.7 448 544 448L256 448zM80 296L80 344C80 357.3 90.7 368 104 368L152 368C165.3 368 176 357.3 176 344L176 296C176 282.7 165.3 272 152 272L104 272C90.7 272 80 282.7 80 296zM104 432C90.7 432 80 442.7 80 456L80 504C80 517.3 90.7 528 104 528L152 528C165.3 528 176 517.3 176 504L176 456C176 442.7 165.3 432 152 432L104 432z"/>
                </svg>
            </button>
        </div>
    </div>
    {% endif %}

    <!-- Results Section -->
    <div class="w-full">
        {% if page_obj.object_list %}
            <!-- Cards View (Default) -->
            <div id="cardsView">
                <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                    {% for item in page_obj.object_list %}
                        <div class="card h-full user-card">
                            <div class="card-body p-3">
                                <!-- User Header -->
                                <div class="flex items-center mb-4">
                                    <div class="w-12 h-12 rounded-full mr-3 overflow-hidden">
                                        {% if item.profile.avatar %}
                                            <img src="{{ item.profile.avatar.url }}" 
                                                alt="Avatar de {{ item.usuario.get_full_name|default:item.usuario.username }}"
                                                class="w-full h-full object-cover">
                                        {% else %}
                                            <div class="w-full h-full bg-principal/10 flex items-center justify-center text-principal font-bold text-lg">
                                                {% if item.usuario.first_name and item.usuario.last_name %}
                                                    {{ item.usuario.first_name.0|upper }}{{ item.usuario.last_name.0|upper }}
                                                {% elif item.usuario.first_name %}
                                                    {{ item.usuario.first_name.0|upper }}{{ item.usuario.first_name.1|upper|default:'' }}
                                                {% else %}
                                                    {{ item.usuario.username.0|upper }}{{ item.usuario.username.1|upper|default:'' }}
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <h6 class="text-lg font-semibold text-gris-oscuro truncate">{{ item.usuario.get_full_name|default:item.usuario.username }}</h6>
                                        <p class="text-sm text-gris-medio">@{{ item.usuario.username }}</p>
                                        {% if not item.usuario.is_active %}
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-error text-blanco ml-2">Inactivo</span>
                                        {% endif %}
                                    </div>
                                    <div class="relative">
                                        <button class="p-2 text-gris-medio hover:text-gris-oscuro rounded-md hover:bg-principal/40 transition-colors duration-200" 
                                                type="button" 
                                                data-bs-toggle="dropdown">
                                            <svg class="size-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
                                            </svg>
                                        </button>
                                        <div class="absolute right-0 mt-2 w-48 bg-blanco rounded-md shadow-lg z-10 border border-gris-medio/20 hidden" data-dropdown-menu>
                                            <div class="py-1">
                                                <a class="flex items-center gap-1 px-4 py-2 text-sm text-gris-oscuro hover:bg-principal/40 transition-colors duration-200" 
                                                   href="{% url 'gravity:admin_usuario_detalle' item.usuario.id %}">
                                                    <svg class="size-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                                                        <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                                                    </svg>
                                                    Ver Detalle
                                                </a>
                                                <a class="flex items-center gap-1 px-4 py-2 text-sm text-gris-oscuro hover:bg-principal/40 transition-colors duration-200" 
                                                   href="{% url 'gravity:admin_reservas_lista' %}?usuario={{ item.usuario.username }}">
                                                    <svg class="size-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                        <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"/>
                                                    </svg>
                                                    Ver Reservas
                                                </a>
                                                <hr class="my-1 border-gris-medio/20">
                                                <a class="flex items-center gap-1 px-4 py-2 text-sm text-gris-oscuro hover:bg-principal/40 transition-colors duration-200" 
                                                   href="mailto:{{ item.usuario.email }}">
                                                    <svg class="size-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                        <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                                                        <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                                                    </svg>
                                                    Enviar Email
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- User Info -->
                                <div class="space-y-2 mb-4">
                                    <div class="flex items-center gap-1 text-sm text-gris-medio">
                                        <svg class="size-4 text-principal" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                                            <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                                        </svg>
                                        {{ item.usuario.email }}
                                    </div>
                                    {% if item.profile.telefono %}
                                        <div class="flex items-center gap-1 text-sm text-gris-medio">
                                            <svg class="size-4 text-exito" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                                            </svg>
                                            {{ item.profile.telefono }}
                                        </div>
                                    {% endif %}
                                    <div class="flex items-center gap-1 text-sm text-gris-medio">
                                        <svg class="size-4 text-info" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                                        </svg>
                                        Miembro desde {{ item.usuario.date_joined|date:"d/m/Y" }}
                                    </div>
                                    {% if item.profile.nivel_experiencia %}
                                        <div class="flex items-center gap-1 text-sm text-gris-medio">
                                            <svg class="size-4 text-advertencia" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                            </svg>
                                            {{ item.profile.get_nivel_experiencia_display }}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Stats -->
                                <div class="grid grid-cols-2 gap-4 text-center mb-4">
                                    <div>
                                        <div class="text-xl font-bold text-principal">{{ item.total_reservas }}</div>
                                        <div class="text-sm text-gris-medio">Reservas</div>
                                    </div>
                                    <div>
                                        <div class="text-lg font-bold {% if item.fecha_ultima_reserva %}text-exito{% else %}text-gris-medio{% endif %}">
                                            {% if item.fecha_ultima_reserva %}
                                                {{ item.fecha_ultima_reserva.fecha_reserva|timesince|truncatechars:25 }}
                                            {% else %}
                                                Nunca
                                            {% endif %}
                                        </div>
                                        <div class="text-sm text-gris-medio">Última reserva</div>
                                    </div>
                                </div>
                                
                                <!-- Health Alert -->
                                {% if item.profile.tiene_lesiones %}
                                    <div class="bg-advertencia/10 border border-advertencia/60 rounded-lg p-2 mb-4">
                                        <div class="flex items-center gap-1 text-yellow-600">
                                            <svg class="size-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                            </svg>
                                            <span class="text-sm">Tiene condiciones médicas</span>
                                        </div>
                                    </div>
                                {% endif %}
                                
                                <!-- Profile Status -->
                                <div class="flex flex-wrap justify-evenly gap-2 mb-4">
                                    {% if item.profile.perfil_completado %}
                                        <span class="flex items-center justify-center gap-1 px-2.5 py-0.5 rounded-md text-xs font-medium bg-exito text-blanco">
                                            <svg class="size-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                            </svg>
                                            Perfil Completo
                                        </span>
                                    {% else %}
                                        <span class="flex items-center justify-center gap-1 px-2.5 py-0.5 rounded-md text-xs font-medium bg-advertencia text-blanco">
                                            <svg class="size-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                            </svg>
                                            Perfil Incompleto
                                        </span>
                                    {% endif %}
                                    
                                    {% if item.profile.acepta_marketing %}
                                        <span class="flex items-center justify-center gap-1 px-2.5 py-0.5 rounded-md text-xs font-medium bg-info text-blanco">
                                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                                                <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                                            </svg>
                                            Marketing
                                        </span>
                                    {% endif %}
                                </div>
                                
                                <!-- Actions -->
                                <div class="flex items-center justify-evenly gap-2">
                                    <a href="{% url 'gravity:admin_usuario_detalle' item.usuario.id %}" 
                                       class="flex items-center gap-1 border border-blue-500 text-blue-600 hover:bg-blue-500 hover:text-white text-sm py-1.5 px-3 rounded transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                                            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                                        </svg>
                                        Ver Detalle
                                    </a>
                                    {% if item.total_reservas > 0 %}
                                        <a href="{% url 'gravity:admin_reservas_lista' %}?usuario={{ item.usuario.username }}" 
                                           class="flex items-center gap-1 border border-cyan-500 text-cyan-600 hover:bg-cyan-500 hover:text-white text-sm py-1.5 px-3 rounded transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:ring-opacity-50">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"/>
                                            </svg>
                                            Ver Reservas
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Table View (Hidden by default) -->
            <div id="tableView" style="display: none;">
                <div class="card">
                    <div class="card-body">
                        <div class="overflow-hidden p-4">
                            <table class="min-w-full divide-y divide-gris-medio/20" id="usuariosTable">
                                <thead class="bg-principal/10">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-gris-oscuro uppercase tracking-wider rounded-tl-lg">Usuario</th>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-gris-oscuro uppercase tracking-wider">Contacto</th>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-gris-oscuro uppercase tracking-wider">Registro</th>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-gris-oscuro uppercase tracking-wider">Perfil</th>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-gris-oscuro uppercase tracking-wider">Reservas</th>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-gris-oscuro uppercase tracking-wider">Estado</th>
                                        <th class="px-6 py-4 text-center text-xs font-medium text-gris-oscuro uppercase tracking-wider rounded-tr-lg">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-blanco divide-y divide-gris-medio/20">
                                    {% for item in page_obj.object_list %}
                                        <tr class="hover:bg-fondo/50 transition-colors duration-200 {% if not item.usuario.is_active %}bg-gris-claro/30{% endif %}">
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="flex items-center">
                                                    <div class="flex-shrink-0 w-10 h-10 rounded-full mr-3 overflow-hidden">
                                                        {% if item.profile.avatar %}
                                                            <img src="{{ item.profile.avatar.url }}" 
                                                                alt="Avatar de {{ item.usuario.get_full_name|default:item.usuario.username }}"
                                                                class="w-full h-full object-cover">
                                                        {% else %}
                                                            <div class="w-full h-full bg-principal/10 flex items-center justify-center text-principal font-bold text-sm">
                                                                {% if item.usuario.first_name and item.usuario.last_name %}
                                                                    {{ item.usuario.first_name.0|upper }}{{ item.usuario.last_name.0|upper }}
                                                                {% elif item.usuario.first_name %}
                                                                    {{ item.usuario.first_name.0|upper }}{{ item.usuario.first_name.1|upper|default:'' }}
                                                                {% else %}
                                                                    {{ item.usuario.username.0|upper }}{{ item.usuario.username.1|upper|default:'' }}
                                                                {% endif %}
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                    <div>
                                                        <div class="text-sm font-medium text-gris-oscuro">{{ item.usuario.get_full_name|default:item.usuario.username }}</div>
                                                        <div class="text-sm text-gris-medio">@{{ item.usuario.username }}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="space-y-1">
                                                    <div class="flex items-center text-sm text-gris-medio">
                                                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                            <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                                                            <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                                                        </svg>
                                                        {{ item.usuario.email }}
                                                    </div>
                                                    {% if item.profile.telefono %}
                                                        <div class="flex items-center text-sm text-gris-medio">
                                                            <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                                <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                                                            </svg>
                                                            {{ item.profile.telefono }}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div>
                                                    <div class="text-sm font-medium text-gris-oscuro">{{ item.usuario.date_joined|date:"d/m/Y" }}</div>
                                                    <div class="text-sm text-gris-medio">{{ item.usuario.date_joined|timesince }} atrás</div>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                {% if item.profile.perfil_completado %}
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-exito text-blanco">Completo</span>
                                                {% else %}
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-advertencia text-blanco">Incompleto</span>
                                                {% endif %}
                                                {% if item.profile.tiene_lesiones %}
                                                    <br><span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-error text-blanco mt-1">Lesiones</span>
                                                {% endif %}
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                                <div class="text-lg font-bold text-principal">{{ item.total_reservas }}</div>
                                                {% if item.fecha_ultima_reserva %}
                                                    <div class="text-sm text-exito">Última: {{ item.fecha_ultima_reserva.fecha_reserva|date:"d/m" }}</div>
                                                {% else %}
                                                    <div class="text-sm text-gris-medio">Sin reservas</div>
                                                {% endif %}
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                {% if item.usuario.is_active %}
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-exito text-blanco">
                                                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                                        </svg>
                                                        Activo
                                                    </span>
                                                {% else %}
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-error text-blanco">
                                                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                                        </svg>
                                                        Inactivo
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                                <div class="flex items-center justify-center gap-1">
                                                    <a href="{% url 'gravity:admin_usuario_detalle' item.usuario.id %}" 
                                                       class="p-2 border border-principal text-principal hover:bg-principal/10 rounded-md transition-colors duration-200" 
                                                       title="Ver detalle">
                                                        <svg class="size-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                                                            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                                                        </svg>
                                                    </a>
                                                    {% if item.total_reservas > 0 %}
                                                        <a href="{% url 'gravity:admin_reservas_lista' %}?usuario={{ item.usuario.username }}" 
                                                           class="p-2 border border-info text-info hover:bg-info/10 rounded-md transition-colors duration-200" 
                                                           title="Ver reservas">
                                                            <svg class="size-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                                <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"/>
                                                            </svg>
                                                        </a>
                                                    {% endif %}
                                                    <a href="mailto:{{ item.usuario.email }}" 
                                                       class="p-2 border border-exito text-exito hover:bg-exito/10 rounded-md transition-colors duration-200" 
                                                       title="Enviar email">
                                                        <svg class="size-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                            <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                                                            <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                                                        </svg>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
                <nav aria-label="Paginación de usuarios" class="mt-8">
                    <div class="flex items-center justify-between border-t border-gris-medio/20 bg-blanco px-4 py-3 sm:px-6">
                        <div class="flex flex-1 justify-between sm:hidden">
                            {% if page_obj.has_previous %}
                                <a href="?page={{ page_obj.previous_page_number }}{% if busqueda %}&busqueda={{ busqueda }}{% endif %}"
                                   class="relative inline-flex items-center rounded-md border border-gris-medio/30 bg-blanco px-4 py-2 text-sm font-medium text-gris-oscuro hover:bg-gris-claro transition-colors duration-200">
                                    Anterior
                                </a>
                            {% endif %}
                            {% if page_obj.has_next %}
                                <a href="?page={{ page_obj.next_page_number }}{% if busqueda %}&busqueda={{ busqueda }}{% endif %}"
                                   class="relative ml-3 inline-flex items-center rounded-md border border-gris-medio/30 bg-blanco px-4 py-2 text-sm font-medium text-gris-oscuro hover:bg-gris-claro transition-colors duration-200">
                                    Siguiente
                                </a>
                            {% endif %}
                        </div>
                        <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
                            <div>
                                <p class="text-sm text-gris-medio">
                                    Mostrando
                                    <span class="font-medium">{{ page_obj.start_index }}</span>
                                    a
                                    <span class="font-medium">{{ page_obj.end_index }}</span>
                                    de
                                    <span class="font-medium">{{ page_obj.paginator.count }}</span>
                                    resultados
                                </p>
                            </div>
                            <div>
                                <nav class="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
                                    {% if page_obj.has_previous %}
                                        <a href="?page=1{% if busqueda %}&busqueda={{ busqueda }}{% endif %}"
                                           class="relative inline-flex items-center rounded-l-md px-2 py-2 text-gris-medio ring-1 ring-inset ring-gris-medio/30 hover:bg-gris-claro focus:z-20 focus:outline-offset-0 transition-colors duration-200">
                                            <span class="sr-only">Primera página</span>
                                            <svg class="h-5 w-5" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" fill="currentColor" aria-hidden="true">
                                                <path fill-rule="evenodd" d="M15.79 14.77a.75.75 0 01-1.06.02l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 111.04 1.08L11.832 10l3.938 3.71a.75.75 0 01.02 1.06zm-6 0a.75.75 0 01-1.06.02l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 111.04 1.08L5.832 10l3.938 3.71a.75.75 0 01.02 1.06z" clip-rule="evenodd"/>
                                            </svg>
                                        </a>
                                        <a href="?page={{ page_obj.previous_page_number }}{% if busqueda %}&busqueda={{ busqueda }}{% endif %}"
                                           class="relative inline-flex items-center px-2 py-2 text-gris-medio ring-1 ring-inset ring-gris-medio/30 hover:bg-gris-claro focus:z-20 focus:outline-offset-0 transition-colors duration-200">
                                            <span class="sr-only">Página anterior</span>
                                            <svg class="h-5 w-5" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" fill="currentColor" aria-hidden="true">
                                                <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd"/>
                                            </svg>
                                        </a>
                                    {% endif %}

                                    {% for num in page_obj.paginator.page_range %}
                                        {% if page_obj.number == num %}
                                            <span class="relative z-10 inline-flex items-center bg-principal px-4 py-2 text-sm font-semibold text-blanco focus:z-20 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-principal">
                                                {{ num }}
                                            </span>
                                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                            <a href="?page={{ num }}{% if busqueda %}&busqueda={{ busqueda }}{% endif %}"
                                               class="relative inline-flex items-center px-4 py-2 text-sm font-semibold text-gris-oscuro ring-1 ring-inset ring-gris-medio/30 hover:bg-gris-claro focus:z-20 focus:outline-offset-0 transition-colors duration-200">
                                                {{ num }}
                                            </a>
                                        {% endif %}
                                    {% endfor %}

                                    {% if page_obj.has_next %}
                                        <a href="?page={{ page_obj.next_page_number }}{% if busqueda %}&busqueda={{ busqueda }}{% endif %}"
                                           class="relative inline-flex items-center px-2 py-2 text-gris-medio ring-1 ring-inset ring-gris-medio/30 hover:bg-gris-claro focus:z-20 focus:outline-offset-0 transition-colors duration-200">
                                            <span class="sr-only">Página siguiente</span>
                                            <svg class="h-5 w-5" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" fill="currentColor" aria-hidden="true">
                                                <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd"/>
                                            </svg>
                                        </a>
                                        <a href="?page={{ page_obj.paginator.num_pages }}{% if busqueda %}&busqueda={{ busqueda }}{% endif %}"
                                           class="relative inline-flex items-center rounded-r-md px-2 py-2 text-gris-medio ring-1 ring-inset ring-gris-medio/30 hover:bg-gris-claro focus:z-20 focus:outline-offset-0 transition-colors duration-200">
                                            <span class="sr-only">Última página</span>
                                            <svg class="h-5 w-5" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" fill="currentColor" aria-hidden="true">
                                                <path fill-rule="evenodd" d="M4.21 14.77a.75.75 0 01.02-1.06L8.168 10 4.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02zm6 0a.75.75 0 01.02-1.06L14.168 10 10.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd"/>
                                            </svg>
                                        </a>
                                    {% endif %}
                                </nav>
                            </div>
                        </div>
                    </div>
                </nav>
            {% endif %}

        {% else %}
            <!-- Empty State -->
            <div class="card">
                <div class="card-body">
                    <div class="text-center py-12">
                        <svg class="w-16 h-16 text-gris-medio mx-auto mb-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <h4 class="text-xl font-semibold text-gris-medio mb-3">No se encontraron usuarios</h4>
                        {% if busqueda %}
                            <p class="text-gris-medio mb-6">
                                No hay usuarios que coincidan con la búsqueda: 
                                <strong>"{{ busqueda }}"</strong>
                            </p>
                            <div class="flex gap-3 justify-center">
                                <a href="{% url 'gravity:admin_usuarios_lista' %}" class="btn btn-outline-secondary">
                                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                    </svg>
                                    Limpiar Búsqueda
                                </a>
                                <a href="{% url 'gravity:admin_agregar_cliente_no_registrado' %}" class="btn btn-primary">
                                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                                    </svg>
                                    Agregar Cliente
                                </a>
                            </div>
                        {% else %}
                            <p class="text-gris-medio mb-6">Aún no hay usuarios registrados en el sistema.</p>
                            <a href="{% url 'gravity:admin_agregar_cliente_no_registrado' %}" class="btn btn-primary">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                                </svg>
                                Agregar Primer Cliente
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tooltips
            const actionButtons = document.querySelectorAll('[title]');
            actionButtons.forEach(function(button) {
                // Simple tooltip implementation
                button.addEventListener('mouseenter', function() {
                    const tooltip = document.createElement('div');
                    tooltip.className = 'absolute z-50 px-2 py-1 text-xs text-blanco bg-gris-oscuro rounded shadow-lg';
                    tooltip.textContent = this.getAttribute('title');
                    tooltip.id = 'tooltip-' + Math.random().toString(36).substr(2, 9);
                    
                    const rect = this.getBoundingClientRect();
                    tooltip.style.left = rect.left + 'px';
                    tooltip.style.top = (rect.top - 30) + 'px';
                    
                    document.body.appendChild(tooltip);
                    this.tooltipId = tooltip.id;
                });
                
                button.addEventListener('mouseleave', function() {
                    if (this.tooltipId) {
                        const tooltip = document.getElementById(this.tooltipId);
                        if (tooltip) {
                            tooltip.remove();
                        }
                        this.tooltipId = null;
                    }
                });
            });
            
            // Handle dropdown menus
            const dropdownButtons = document.querySelectorAll('[data-bs-toggle="dropdown"]');
            dropdownButtons.forEach(function(button) {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const menu = this.parentNode.querySelector('[data-dropdown-menu]');
                    if (menu) {
                        menu.classList.toggle('hidden');
                    }
                });
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('[data-bs-toggle="dropdown"]')) {
                    const openMenus = document.querySelectorAll('[data-dropdown-menu]:not(.hidden)');
                    openMenus.forEach(function(menu) {
                        menu.classList.add('hidden');
                    });
                }
            });
            
            // Highlight search term in results
            const searchTerm = document.getElementById('busqueda').value;
            if (searchTerm.trim()) {
                highlightSearchTerm(searchTerm);
            }
            
            // Auto-focus search input
            document.getElementById('busqueda').focus();
        });

        // Function to toggle between card and table view
        function toggleView(viewType) {
            const cardsView = document.getElementById('cardsView');
            const tableView = document.getElementById('tableView');
            const buttons = document.querySelectorAll('.flex.rounded-md button');
            
            buttons.forEach(function(btn) {
                btn.classList.remove('bg-principal', 'text-blanco');
                btn.classList.add('bg-blanco', 'text-gris-oscuro');
            });
            
            if (viewType === 'cards') {
                cardsView.style.display = 'block';
                tableView.style.display = 'none';
                buttons[0].classList.remove('bg-blanco', 'text-gris-oscuro');
                buttons[0].classList.add('bg-principal', 'text-blanco');
            } else {
                cardsView.style.display = 'none';
                tableView.style.display = 'block';
                buttons[1].classList.remove('bg-blanco', 'text-gris-oscuro');
                buttons[1].classList.add('bg-principal', 'text-blanco');
            }
            
            // Save preference
            localStorage.setItem('userViewPreference', viewType);
        }

        // Function to filter users
        function filterBy(filterType) {
            const baseUrl = '{% url "gravity:admin_usuarios_lista" %}';
            let url = baseUrl;
            
            switch(filterType) {
                case 'con_reservas':
                    // This would need backend support
                    alert('Filtro en desarrollo: usuarios con reservas');
                    break;
                case 'nuevos':
                    // This would need backend support  
                    alert('Filtro en desarrollo: usuarios nuevos');
                    break;
                case 'activos':
                    // This would need backend support
                    alert('Filtro en desarrollo: usuarios activos');
                    break;
                case 'sin_perfil':
                    // This would need backend support
                    alert('Filtro en desarrollo: usuarios sin perfil completo');
                    break;
                default:
                    window.location.href = url;
            }
        }

        // Function to export users
        function exportUsuarios() {
            const table = document.getElementById('usuariosTable');
            if (!table) {
                // If table view is not active, gather data from cards
                const userCards = document.querySelectorAll('.user-card');
                if (userCards.length === 0) {
                    alert('No hay datos para exportar');
                    return;
                }
                
                let csv = 'Nombre,Username,Email,Teléfono,Fecha de Registro,Reservas,Estado\n';
                
                userCards.forEach(function(card) {
                    const nombre = card.querySelector('.text-lg.font-semibold').textContent.trim();
                    const username = card.querySelector('.text-sm.text-gris-medio').textContent.replace('@', '').trim();
                    
                    // Find email
                    const emailIcon = Array.from(card.querySelectorAll('svg')).find(svg => 
                        svg.querySelector('path[d*="2.003 5.884L10 9.882l7.997-3.998"]')
                    );
                    const email = emailIcon ? emailIcon.parentNode.textContent.trim() : 'N/A';
                    
                    // Find phone
                    const phoneIcon = Array.from(card.querySelectorAll('svg')).find(svg => 
                        svg.querySelector('path[d*="2 3a1 1 0 011-1h2.153"]')
                    );
                    const telefono = phoneIcon ? phoneIcon.parentNode.textContent.trim() : 'N/A';
                    
                    // Find date
                    const dateIcon = Array.from(card.querySelectorAll('svg')).find(svg => 
                        svg.querySelector('path[fill-rule="evenodd"][d*="6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10"]')
                    );
                    const fecha = dateIcon ? dateIcon.parentNode.textContent.replace('Miembro desde ', '').trim() : 'N/A';
                    
                    const reservas = card.querySelector('.text-xl.font-bold.text-principal').textContent.trim();
                    
                    // Find status badge
                    const statusBadge = card.querySelector('.inline-flex.items-center.px-2\\.5.py-0\\.5.rounded-full');
                    const estado = statusBadge ? statusBadge.textContent.trim() : 'Activo';
                    
                    csv += '"' + nombre + '","' + username + '","' + email + '","' + telefono + 
                        '","' + fecha + '","' + reservas + '","' + estado + '"\n';
                });
                
                downloadCSV(csv, 'usuarios_cards.csv');
                return;
            }
            
            let csv = 'Nombre,Username,Email,Teléfono,Fecha de Registro,Perfil,Reservas,Estado\n';
            
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(function(row) {
                const cells = row.querySelectorAll('td');
                const nombre = cells[0].querySelector('.text-sm.font-medium').textContent.trim();
                const username = cells[0].querySelector('.text-sm.text-gris-medio').textContent.replace('@', '').trim();
                
                // Extract email from contact cell
                const emailText = cells[1].textContent.trim();
                const email = emailText.split('\n')[0] || 'N/A';
                
                // Extract phone from contact cell
                const phoneLines = cells[1].textContent.trim().split('\n');
                const telefono = phoneLines.length > 1 ? phoneLines[1] : 'N/A';
                
                const fecha = cells[2].querySelector('.text-sm.font-medium').textContent.trim();
                const perfil = cells[3].querySelector('.inline-flex').textContent.trim();
                const reservas = cells[4].querySelector('.text-lg.font-bold').textContent.trim();
                const estado = cells[5].querySelector('.inline-flex').textContent.trim();
                
                csv += '"' + nombre + '","' + username + '","' + email + '","' + telefono + 
                    '","' + fecha + '","' + perfil + '","' + reservas + '","' + estado + '"\n';
            });
            
            downloadCSV(csv, 'usuarios_table.csv');
        }

        // Function to download CSV
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Function to highlight search terms
        function highlightSearchTerm(term) {
            const regex = new RegExp('(' + term + ')', 'gi');
            const textNodes = document.querySelectorAll('.text-lg.font-semibold, .text-sm.font-medium, td .text-sm');
            
            textNodes.forEach(function(node) {
                if (node.textContent.toLowerCase().includes(term.toLowerCase())) {
                    node.innerHTML = node.innerHTML.replace(regex, '<mark class="bg-yellow-200 px-1 rounded">$1</mark>');
                }
            });
        }

        // Load saved view preference
        document.addEventListener('DOMContentLoaded', function() {
            const savedView = localStorage.getItem('userViewPreference');
            if (savedView === 'table') {
                toggleView('table');
            }
        });

        // Handle form submission with Enter key
        document.getElementById('busqueda').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('searchForm').submit();
            }
        });

        // Add smooth transitions for cards
        const cards = document.querySelectorAll('.user-card');
        cards.forEach(function(card) {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-4px)';
                this.style.boxShadow = '0 10px 25px rgba(93, 118, 139, 0.15)';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '';
            });
        });

        // Add loading state for export button
        function exportUsuarios() {
            const button = event.target;
            const originalText = button.innerHTML;
            
            // Show loading state
            button.innerHTML = `
                <svg class="w-4 h-4 mr-2 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Exportando...
            `;
            button.disabled = true;
            
            // Simulate export process
            setTimeout(function() {
                // Your existing export logic here
                const table = document.getElementById('usuariosTable');
                if (!table || table.closest('#tableView').style.display === 'none') {
                    exportFromCards();
                } else {
                    exportFromTable();
                }
                
                // Reset button
                button.innerHTML = originalText;
                button.disabled = false;
                
                // Show success message
                showToast('Exportación completada exitosamente', 'success');
            }, 1000);
        }

        function exportFromCards() {
            const userCards = document.querySelectorAll('.user-card');
            if (userCards.length === 0) {
                showToast('No hay datos para exportar', 'error');
                return;
            }
            
            let csv = 'Nombre,Username,Email,Teléfono,Fecha de Registro,Reservas,Estado\n';
            
            userCards.forEach(function(card) {
                try {
                    const nombre = card.querySelector('.text-lg.font-semibold')?.textContent.trim() || 'N/A';
                    const usernameEl = card.querySelector('.text-sm.text-gris-medio');
                    const username = usernameEl ? usernameEl.textContent.replace('@', '').trim() : 'N/A';
                    
                    // Extract email more reliably
                    const emailContainer = Array.from(card.querySelectorAll('.flex.items-center.text-sm.text-gris-medio')).find(el => 
                        el.textContent.includes('@')
                    );
                    const email = emailContainer ? emailContainer.textContent.trim() : 'N/A';
                    
                    // Extract phone more reliably
                    const phoneContainers = card.querySelectorAll('.flex.items-center.text-sm.text-gris-medio');
                    let telefono = 'N/A';
                    phoneContainers.forEach(container => {
                        const text = container.textContent.trim();
                        if (text.match(/[\d\+\-\(\)\s]/g) && text.length > 5 && !text.includes('@')) {
                            telefono = text;
                        }
                    });
                    
                    // Extract date
                    const dateContainer = Array.from(card.querySelectorAll('.flex.items-center.text-sm.text-gris-medio')).find(el => 
                        el.textContent.includes('Miembro desde')
                    );
                    const fecha = dateContainer ? dateContainer.textContent.replace('Miembro desde ', '').trim() : 'N/A';
                    
                    const reservasEl = card.querySelector('.text-xl.font-bold.text-principal');
                    const reservas = reservasEl ? reservasEl.textContent.trim() : '0';
                    
                    // Extract status from badges
                    const badges = card.querySelectorAll('.inline-flex.items-center.px-2\\.5.py-0\\.5.rounded-full');
                    let estado = 'Activo';
                    badges.forEach(badge => {
                        const text = badge.textContent.trim();
                        if (text === 'Inactivo' || text.includes('Completo') || text.includes('Incompleto')) {
                            estado = text;
                        }
                    });
                    
                    csv += `"${nombre}","${username}","${email}","${telefono}","${fecha}","${reservas}","${estado}"\n`;
                } catch (error) {
                    console.error('Error processing card:', error);
                }
            });
            
            downloadCSV(csv, `usuarios_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function exportFromTable() {
            const table = document.getElementById('usuariosTable');
            let csv = 'Nombre,Username,Email,Teléfono,Fecha de Registro,Perfil,Reservas,Estado\n';
            
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(function(row) {
                try {
                    const cells = row.querySelectorAll('td');
                    const nombre = cells[0]?.querySelector('.text-sm.font-medium')?.textContent.trim() || 'N/A';
                    const username = cells[0]?.querySelector('.text-sm.text-gris-medio')?.textContent.replace('@', '').trim() || 'N/A';
                    
                    // Extract contact info
                    const contactCell = cells[1];
                    const contactDivs = contactCell?.querySelectorAll('.flex.items-center.text-sm.text-gris-medio');
                    let email = 'N/A';
                    let telefono = 'N/A';
                    
                    if (contactDivs) {
                        contactDivs.forEach(div => {
                            const text = div.textContent.trim();
                            if (text.includes('@')) {
                                email = text;
                            } else if (text.match(/[\d\+\-\(\)\s]/g) && text.length > 5) {
                                telefono = text;
                            }
                        });
                    }
                    
                    const fecha = cells[2]?.querySelector('.text-sm.font-medium')?.textContent.trim() || 'N/A';
                    const perfil = cells[3]?.querySelector('.inline-flex')?.textContent.trim() || 'N/A';
                    const reservas = cells[4]?.querySelector('.text-lg.font-bold')?.textContent.trim() || '0';
                    const estado = cells[5]?.querySelector('.inline-flex')?.textContent.trim() || 'N/A';
                    
                    csv += `"${nombre}","${username}","${email}","${telefono}","${fecha}","${perfil}","${reservas}","${estado}"\n`;
                } catch (error) {
                    console.error('Error processing row:', error);
                }
            });
            
            downloadCSV(csv, `usuarios_tabla_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // Toast notification function
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full ${
                type === 'success' ? 'bg-exito text-blanco' : 
                type === 'error' ? 'bg-error text-blanco' : 
                'bg-info text-blanco'
            }`;
            
            toast.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        ${type === 'success' ? 
                            '<path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>' :
                            type === 'error' ?
                            '<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>' :
                            '<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>'
                        }
                    </svg>
                    ${message}
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);
            
            // Animate out and remove
            setTimeout(() => {
                toast.style.transform = 'translateX(full)';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
    </script>
{% endblock %}