{% extends 'gravity/admin/base_admin.html' %}

{% block title %}{% if clase %}Editar{% else %}Crear{% endif %} Clase - Panel de Administración{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="{% url 'gravity:admin_clases_lista' %}">Clases</a></li>
    <li class="breadcrumb-item active">{% if clase %}Editar{% else %}Crear{% endif %}</li>
{% endblock %}

{% block content %}
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h2 class="mb-2">
                                <i class="fas fa-{% if clase %}edit{% else %}plus{% endif %} me-2"></i>
                                {% if clase %}Editar{% else %}Crear{% endif %} Clase
                            </h2>
                            <p class="text-muted mb-0">
                                {% if clase %}
                                    Modifica los datos de la clase existente
                                {% else %}
                                    Completa los datos para crear una nueva clase
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6 text-end">
                            <a href="{% url 'gravity:admin_clases_lista' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Volver a Lista
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Form Section -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5>
                        <i class="fas fa-calendar-alt me-2"></i>
                        Información de la Clase
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="claseForm">
                        {% csrf_token %}
                        
                        <div class="row">
                            <!-- Tipo de Clase -->
                            <div class="col-md-6 mb-4">
                                <label for="tipo" class="form-label">
                                    <i class="fas fa-tag me-2"></i>Tipo de Clase *
                                </label>
                                <select name="tipo" id="tipo" class="form-select" required onchange="toggleEspecialFields()">
                                    <option value="">Selecciona un tipo</option>
                                    {% for value, label in tipos_clases %}
                                        <option value="{{ value }}" 
                                            {% if clase and clase.tipo == value %}selected{% endif %}
                                            {% if form_data.tipo == value %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Selecciona "Clase Especial" para crear clases personalizadas
                                    </small>
                                </div>
                            </div>

                            <!-- Nombre Personalizado (solo para clases especiales) -->
                            <div class="col-md-6 mb-4" id="nombre_personalizado_container" style="display: none;">
                                <label for="nombre_personalizado" class="form-label">
                                    <i class="fas fa-pen-fancy me-2"></i>Nombre de la Clase Especial *
                                </label>
                                <input type="text" 
                                    name="nombre_personalizado" 
                                    id="nombre_personalizado" 
                                    class="form-control"
                                    placeholder="Ej: Pilates Prenatal, Rehabilitación, etc."
                                    maxlength="100"
                                    value="{% if clase %}{{ clase.nombre_personalizado|default:'' }}{% endif %}{% if form_data.nombre_personalizado %}{{ form_data.nombre_personalizado }}{% endif %}">
                                <div class="form-text">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Nombre descriptivo para la clase especial
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Día de la Semana -->
                            <div class="col-md-6 mb-4">
                                <label for="dia" class="form-label">
                                    <i class="fas fa-calendar-day me-2"></i>Día de la Semana *
                                </label>
                                <select name="dia" id="dia" class="form-select" required>
                                    <option value="">Selecciona un día</option>
                                    {% for value, label in dias_semana %}
                                        <option value="{{ value }}" 
                                            data-especial-only="{% if value == 'Sábado' %}true{% else %}false{% endif %}"
                                            {% if clase and clase.dia == value %}selected{% endif %}
                                            {% if form_data.dia == value %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">
                                    <small class="text-muted" id="dia_help_text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Día de la semana para la clase recurrente
                                    </small>
                                </div>
                            </div>

                            <!-- Horario -->
                            <div class="col-md-6 mb-4">
                                <label for="horario" class="form-label">
                                    <i class="fas fa-clock me-2"></i>Horario *
                                </label>
                                <input type="time" 
                                    name="horario" 
                                    id="horario" 
                                    class="form-control" 
                                    value="{% if clase %}{{ clase.horario|time:'H:i' }}{% endif %}{% if form_data.horario %}{{ form_data.horario }}{% endif %}"
                                    min="06:00" 
                                    max="22:00" 
                                    required>
                                <div class="form-text">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Horario entre 06:00 y 22:00 hrs
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Cupo Máximo -->
                            <div class="col-md-6 mb-4">
                                <label for="cupo_maximo" class="form-label">
                                    <i class="fas fa-users me-2"></i>Cupo Máximo *
                                </label>
                                <input type="number" 
                                    name="cupo_maximo" 
                                    id="cupo_maximo" 
                                    class="form-control" 
                                    value="{% if clase %}{{ clase.cupo_maximo }}{% endif %}{% if form_data.cupo_maximo %}{{ form_data.cupo_maximo }}{% endif %}"
                                    min="1" 
                                    max="20" 
                                    required>
                                <div class="form-text">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Número máximo de personas por clase (1-20)
                                    </small>
                                </div>
                            </div>

                            <!-- Estado (solo para edición) -->
                            {% if clase %}
                            <div class="col-md-6 mb-4 d-flex align-items-center">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" 
                                        type="checkbox" 
                                        name="activa" 
                                        id="activa" 
                                        {% if clase.activa %}checked{% endif %}>
                                    <label class="form-check-label" for="activa">
                                        <i class="fas fa-toggle-on me-2"></i>Clase Activa
                                    </label>
                                </div>
                                <div class="form-text ms-3">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Las clases inactivas no aparecerán disponibles para reservar
                                    </small>
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Preview Section -->
                        <div class="row">
                            <div class="col-12 mb-4">
                                <div class="card bg-light border-0">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0">
                                            <i class="fas fa-eye me-2"></i>Vista Previa de la Clase
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="preview-content" class="text-center text-muted">
                                            <i class="fas fa-info-circle me-2"></i>
                                            Completa los campos para ver la vista previa
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Warning for existing class -->
                        {% if clase and not clase.puede_eliminarse %}
                        <div class="row">
                            <div class="col-12 mb-4">
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Atención:</strong> Esta clase tiene {{ clase.reserva_set.filter.count|default:0 }} reservas activas. 
                                    Si cambias el horario o día, afectarás a todos los usuarios con reservas.
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Action Buttons -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex gap-3 justify-content-end">
                                    <a href="{% url 'gravity:admin_clases_lista' %}" 
                                    class="btn btn-outline-secondary">
                                        <i class="fas fa-times me-2"></i>Cancelar
                                    </a>
                                    
                                    <button type="submit" 
                                            class="btn btn-primary" 
                                            id="submitBtn">
                                        <i class="fas fa-{% if clase %}save{% else %}plus{% endif %} me-2"></i>
                                        <span id="submitText">
                                            {% if clase %}Guardar Cambios{% else %}Crear Clase{% endif %}
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Information Sidebar -->
        <div class="col-lg-4">
            <!-- Tips Card -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>Consejos
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            <small>Usa "Clase Especial" para clases personalizadas</small>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            <small>Solo las clases especiales pueden ser los sábados</small>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            <small>El cupo máximo depende del equipo disponible</small>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            <small>Los horarios deben estar en el rango laboral</small>
                        </li>
                        <li class="mb-0">
                            <i class="fas fa-check text-success me-2"></i>
                            <small>Las clases inactivas no son visibles para usuarios</small>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Clase Especial Info -->
            <div class="card mb-4" id="especial_info_card" style="display: none;">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">
                        <i class="fas fa-star me-2"></i>Clases Especiales
                    </h6>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        <small>Las clases especiales te permiten crear clases personalizadas:</small>
                    </p>
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="fas fa-plus text-warning me-2"></i>
                            <small>Nombre personalizable</small>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-calendar-plus text-warning me-2"></i>
                            <small>Disponibles también los sábados</small>
                        </li>
                        <li class="mb-0">
                            <i class="fas fa-users text-warning me-2"></i>
                            <small>Ideales para talleres y eventos</small>
                        </li>
                    </ul>
                    
                    <hr>
                    
                    <div class="mb-0">
                        <strong>Ejemplos de nombres:</strong>
                        <div class="mt-2">
                            <span class="badge bg-outline-warning me-1 mb-1">Pilates Prenatal</span>
                            <span class="badge bg-outline-warning me-1 mb-1">Rehabilitación</span>
                            <span class="badge bg-outline-warning me-1 mb-1">Taller Intensivo</span>
                            <span class="badge bg-outline-warning me-1 mb-1">Pilates Senior</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Información de Clases Actuales (solo al crear) -->
            {% if not clase %}
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>Clases Existentes
                    </h6>
                </div>
                <div class="card-body">
                    <div class="text-muted">
                        <small>
                            <i class="fas fa-info-circle me-2"></i>
                            Asegúrate de no crear duplicados
                        </small>
                    </div>
                    <div id="existing-classes" class="mt-3">
                        <div class="text-center">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <br>
                            <small class="text-muted">Cargando clases existentes...</small>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Información de la Clase Actual (solo para edición) -->
            {% if clase %}
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Información Actual
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Tipo:</strong>
                        {% if clase.tipo == 'Especial' %}
                            <span class="badge bg-warning ms-2">{{ clase.get_nombre_display }}</span>
                        {% else %}
                            <span class="badge bg-info ms-2">{{ clase.get_tipo_display }}</span>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <strong>Reservas Activas:</strong>
                        <span class="badge bg-info ms-2">{{ clase.reserva_set.filter.count|default:0 }}</span>
                    </div>
                    <div class="mb-3">
                        <strong>Cupos Disponibles:</strong>
                        <span class="badge bg-success ms-2">{{ clase.cupos_disponibles|default:0 }}</span>
                    </div>
                    <div class="mb-3">
                        <strong>Ocupación:</strong>
                        <span class="badge bg-primary ms-2">{{ clase.get_porcentaje_ocupacion|default:0 }}%</span>
                    </div>
                    <div class="mb-0">
                        <strong>Estado:</strong>
                        {% if clase.activa %}
                            <span class="badge bg-success ms-2">Activa</span>
                        {% else %}
                            <span class="badge bg-danger ms-2">Inactiva</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('claseForm');
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const previewContent = document.getElementById('preview-content');
            
            // Form fields
            const tipoSelect = document.getElementById('tipo');
            const nombrePersonalizadoInput = document.getElementById('nombre_personalizado');
            const diaSelect = document.getElementById('dia');
            const horarioInput = document.getElementById('horario');
            const cupoInput = document.getElementById('cupo_maximo');
            
            // Inicializa el estado del formulario
            toggleEspecialFields();
            updatePreview();
            
            // Actualiza la vista previa cuando los campos cambian
            function updatePreview() {
                const tipo = tipoSelect.value;
                const nombrePersonalizado = nombrePersonalizadoInput.value;
                const dia = diaSelect.value;
                const horario = horarioInput.value;
                const cupo = cupoInput.value;
                
                if (tipo && dia && horario && cupo) {
                    let tipoText;
                    let iconClass;
                    
                    if (tipo === 'Especial' && nombrePersonalizado) {
                        tipoText = nombrePersonalizado;
                        iconClass = 'fas fa-star fa-2x text-warning';
                    } else if (tipo === 'Especial') {
                        tipoText = 'Clase Especial (sin nombre)';
                        iconClass = 'fas fa-star fa-2x text-warning';
                    } else {
                        const tipoOption = tipoSelect.options[tipoSelect.selectedIndex];
                        tipoText = tipoOption.text;
                        iconClass = (tipo === 'Reformer') ? 'fas fa-dumbbell fa-2x text-primary' : 'fas fa-bed fa-2x text-info';
                    }
                    
                    previewContent.innerHTML = 
                        '<div class="d-flex align-items-center justify-content-center">' +
                            '<div class="me-3">' +
                                '<i class="' + iconClass + '"></i>' +
                            '</div>' +
                            '<div class="text-start">' +
                                '<h6 class="mb-1">' + tipoText + '</h6>' +
                                '<small class="text-muted">' +
                                    '<i class="fas fa-calendar me-1"></i>' + dia + ' - ' +
                                    '<i class="fas fa-clock me-1"></i>' + horario + ' - ' +
                                    '<i class="fas fa-users me-1"></i>' + cupo + ' cupos' +
                                '</small>' +
                            '</div>' +
                        '</div>';
                } else {
                    previewContent.innerHTML = '<i class="fas fa-info-circle me-2"></i>Completa los campos para ver la vista previa';
                }
            }
            
            // Agrega los event listeners
            [tipoSelect, nombrePersonalizadoInput, diaSelect, horarioInput, cupoInput].forEach(function(field) {
                field.addEventListener('change', updatePreview);
                field.addEventListener('input', updatePreview);
            });
            
            // Validación y envío del formulario
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Mostrar estado de carga
                const originalText = submitText.textContent;
                submitText.textContent = 'Guardando...';
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status"></div>' + submitText.textContent;
                
                // Validar formulario
                let isValid = true;
                const requiredFields = [tipoSelect, diaSelect, horarioInput, cupoInput];
                
                // Agrega nombre_personalizado a los requeridos si el tipo es 'Especial'
                if (tipoSelect.value === 'Especial') {
                    requiredFields.push(nombrePersonalizadoInput);
                }
                
                requiredFields.forEach(function(field) {
                    if (!field.value.trim()) {
                        field.classList.add('is-invalid');
                        isValid = false;
                    } else {
                        field.classList.remove('is-invalid');
                    }
                });
                
                // Validar que el sábado solo sea para clases especiales
                if (diaSelect.value === 'Sábado' && tipoSelect.value !== 'Especial') {
                    diaSelect.classList.add('is-invalid');
                    isValid = false;
                    alert('Solo las clases especiales pueden programarse los sábados.');
                }
                
                // Validar rango de horario
                if (horarioInput.value) {
                    const time = horarioInput.value;
                    const timeParts = time.split(':');
                    const hours = parseInt(timeParts[0]);
                    const minutes = parseInt(timeParts[1]);
                    const totalMinutes = hours * 60 + minutes;
                    
                    if (totalMinutes < 6 * 60 || totalMinutes > 22 * 60) {
                        horarioInput.classList.add('is-invalid');
                        isValid = false;
                        alert('El horario debe estar entre las 06:00 y las 22:00');
                    }
                }
                
                // Validar rango de cupo máximo
                if (cupoInput.value) {
                    const cupo = parseInt(cupoInput.value);
                    if (cupo < 1 || cupo > 20) {
                        cupoInput.classList.add('is-invalid');
                        isValid = false;
                        alert('El cupo máximo debe estar entre 1 y 20');
                    }
                }
                
                if (isValid) {
                    // Submit form
                    this.submit();
                } else {
                    // Restablecer el estado del botón
                    submitText.textContent = originalText;
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>' + submitText.textContent;
                }
            });
            
            // Cargar clases existentes en modo creación
            const existingClassesDiv = document.getElementById('existing-classes');
            if (existingClassesDiv) {
                fetch('/api/clases-disponibles/')
                    .then(function(response) {
                        return response.json();
                    })
                    .then(function(data) {
                        if (data.length > 0) {
                            let html = '<div class="small">';
                            data.forEach(function(clase) {
                                html += 
                                    '<div class="d-flex justify-content-between align-items-center mb-1 p-1 bg-light rounded">' +
                                        '<div>' +
                                            '<strong>' + clase.tipo_display + '</strong><br>' +
                                            '<small class="text-muted">' + clase.dia + ' ' + clase.horario_display + '</small>' +
                                        '</div>' +
                                        '<small class="badge bg-secondary">' + clase.cupos_disponibles + '/' + clase.cupo_maximo + '</small>' +
                                    '</div>';
                            });
                            html += '</div>';
                            existingClassesDiv.innerHTML = html;
                        } else {
                            existingClassesDiv.innerHTML = '<small class="text-muted">No hay clases creadas aún</small>';
                        }
                    })
                    .catch(function(error) {
                        existingClassesDiv.innerHTML = '<small class="text-danger">Error al cargar clases</small>';
                    });
            }
        });

        // Función para mostrar/ocultar campos de clase especial
        function toggleEspecialFields() {
            const tipoSelect = document.getElementById('tipo');
            const nombreContainer = document.getElementById('nombre_personalizado_container');
            const nombreInput = document.getElementById('nombre_personalizado');
            const diaSelect = document.getElementById('dia');
            const diaHelpText = document.getElementById('dia_help_text');
            const especialInfoCard = document.getElementById('especial_info_card');
            
            const isEspecial = tipoSelect.value === 'Especial';
            
            // Mostrar/ocultar campo de nombre personalizado
            if (isEspecial) {
                nombreContainer.style.display = 'block';
                nombreInput.required = true;
                especialInfoCard.style.display = 'block';
            } else {
                nombreContainer.style.display = 'none';
                nombreInput.required = false;
                nombreInput.value = '';
                especialInfoCard.style.display = 'none';
            }
            
            // Actualiza las opciones del campo día y el texto de ayuda
            const diaOptions = diaSelect.querySelectorAll('option[data-especial-only="true"]');
            diaOptions.forEach(function(option) {
                if (isEspecial) {
                    option.style.display = 'block';
                    option.disabled = false;
                } else {
                    if (option.selected) {
                        // Restablece la selección al valor predeterminado
                        diaSelect.selectedIndex = 0;
                    }
                    option.style.display = 'none';
                    option.disabled = true;
                }
            });
            
            // Actualiza el texto de ayuda
            if (isEspecial) {
                diaHelpText.innerHTML = '<i class="fas fa-info-circle me-1"></i>Las clases especiales pueden programarse cualquier día, incluidos sábados';
            } else {
                diaHelpText.innerHTML = '<i class="fas fa-info-circle me-1"></i>Día de la semana para la clase recurrente (Lunes a Viernes)';
            }
        }
    </script>
{% endblock %}